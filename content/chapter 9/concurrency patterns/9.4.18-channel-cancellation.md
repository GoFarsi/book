---
title: 9.4.18 ุงูฺฏู Channel Cancellation
slug: go-concurrency-pattern-channel-cancellation
weight: 177018
mermaid: "true"
---


## 9.4.18.1 ุชูุถุญุงุช

ุงูฺฏู **Channel Cancellation** ุง ยซูุบู ุจุง ฺฉุงูุงูยป ฺฉ ุงุฒ ุงูฺฏููุง ฺฉูุฏ ุฏุฑ ุทุฑุงุญ ุจุฑูุงููโูุง ููุฒูุงู (concurrent) ุฏุฑ ุฒุจุงู Go ุงุณุช. ุงู ุงูฺฏู ุฒูุงู ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู ูุงุฒ ุจุงุดุฏ ฺฉ ุง ฺูุฏ ฺฏูุฑูุชู ุฑุง ุจูโุตูุฑุช ููุงููฺฏ ู ุงูู ูุชููู ฺฉููุ ุจูโูฺู ุฏุฑ ุดุฑุงุท ฺฉู ุงุฏุงูู ุงุฌุฑุง ุขูโูุง ุจโูุงุฏู ุง ูุถุฑ ุงุณุช (ูุซูุงู ุฎุทุง ุฑุฎ ุฏุงุฏูุ ุฒูุงูโุณูุฌ ุชูุงู ุดุฏู ุง ุจุฑูุงูู ุฏุฑ ุญุงู ุฎุงุชูู ุงุณุช). ุงู ุงูฺฏู ุจุฑุฎูุงู ุงุณุชูุงุฏู ุงุฒ `context.Context` (ฺฉู ุฏุฑ Go ุจุฑุง ูุบู ุงุณุชุงูุฏุงุฑุฏ ุชูุตู ูโุดูุฏ)ุ ุงุฒ ฺฉ `channel` ุงุฎุชุตุงุต ุจุฑุง ุงุฑุณุงู ุณฺฏูุงู ูุบู ุงุณุชูุงุฏู ูโฺฉูุฏ.

ุฏุฑ ุงู ุงูฺฏูุ ฺฉ ฺฉุงูุงู ูุนูููุงู ุงุฒ ููุน `chan struct{}` (ุง `chan bool`) ุชุนุฑู ูโุดูุฏ ฺฉู ููุท ฺฉ ุจุงุฑ ููุฏุงุฑ ูโฺฏุฑุฏ ู ุจุนุฏ ุงุฒ ุขูุ ุชูุงู ฺฏูุฑูุชูโูุง ฺฉู ุฑู ุขู ููุชุธุฑ ูุณุชูุฏ ูุชูุฌู ูุบู ูโุดููุฏ. ฺฏูุฑูุชูโูุง ูุตุฑูโฺฉููุฏู ุจุง ุงุณุชูุงุฏู ุงุฒ `select` ุจุฑุฑุณ ูโฺฉููุฏ ฺฉู ุขุง ุณฺฏูุงู ูุบู ุฏุฑุงูุช ุดุฏู ุง ููุ ู ุฏุฑ ุตูุฑุช ุฏุฑุงูุช ุขูุ ุจูุงูุงุตูู ูุชููู ูโุดููุฏ. ุจู ุงู ุชุฑุชุจุ ุณุณุชู ุจุฏูู ุงุณุชูุงุฏู ุงุฒ ูุชุบุฑูุง ูุดุชุฑฺฉ ุง ููู (mutex) ูโุชูุงูุฏ ฺฏูุฑูุชูโูุง ูุชุนุฏุฏ ุฑุง ูุชููู ฺฉูุฏ.

ูุฒุช ุงุตู Channel Cancellation ุฏุฑ ุณุงุฏฺฏ ู ุณุงุฒฺฏุงุฑ ุจุงูุง ุจุง ุณุงุฑ ฺฉุงูุงูโูุง ู ุณุงุฎุชุงุฑูุง Go ุงุณุช. ุงู ุงูฺฏู ุจู ุฑุงุญุช ุฏุฑ ุชุฑฺฉุจ ุจุง `select` ุฏุฑ ฺฉูุงุฑ ฺฉุงูุงูโูุง ุฏุงุฏู ุจู ฺฉุงุฑ ูโุฑูุฏุ ุจู ุทูุฑ ฺฉู ูุฑ ฺฏูุฑูุชู ููุฒูุงู ูโุชูุงูุฏ ููุชุธุฑ ุฏุงุฏู ุง ุณฺฏูุงู ูุบู ุจุงุดุฏ. ุงู ุงูฺฏู ููฺูู ููุงุณุจ ุณุณุชูโูุง ุงุณุช ฺฉู ุจู ุณุจฺฉ event-driven ุทุฑุงุญ ุดุฏูโุงูุฏ ุง ูุงุฒ ุฏุงุฑูุฏ ุงุฒ ุนููุงุช ุทููุงู ุง ูุณุฏูุฏฺฉููุฏู (blocking) ุฎุงุฑุฌ ุดููุฏ.

ุฏุฑ ููุงุชุ ฺฏุฑฺู ุงูุฑูุฒู ุงุณุชูุงุฏู ุงุฒ `context.Context` ุฏุฑ ุงุบูุจ ูููุนุชโูุง ูุบู ุชูุตู ูโุดูุฏุ ุงูฺฏู Channel Cancellation ููฺูุงู ุจุณุงุฑ ููุฏุ ุณุจฺฉ ู ูุงุจู ููู ุงุณุชโูุฎุตูุตุงู ุฏุฑ ฺฉุฏูุง ฺฉู ุณุงุฏูโุชุฑ ุง ูุงูุฏ ูุงุฒ ุจู ุชูุงุจุน context-aware ูุณุชูุฏ. ุงู ุงูฺฏู ูพุงูโุง ุจุฑุง ูพุงุฏูโุณุงุฒ shutdown gracefulุ stop ฺฉุฑุฏู workerูุงุ ูุบู ุนููุงุช IO ู ฺฉูุชุฑู ุญูููโูุง ุทููุงูโูุฏุช ุฏุฑ ุจุฑูุงููโูุง Go ูุญุณูุจ ูโุดูุฏ.

## 9.4.18.2 ุฏุงฺฏุฑุงู


{{< mermaid >}}
sequenceDiagram
    participant Main
    participant Worker1
    participant Worker2
    participant CancelChan as Cancel Channel

    Main->>Worker1: start with cancel channel
    Main->>Worker2: start with cancel channel

    Note over Worker1,Worker2: ฺฉุงุฑ ุงุฏุงูู ุฏุงุฑุฏ...

    Main-->>CancelChan: close(cancel)

    Worker1-->>CancelChan: <- cancel
    Worker2-->>CancelChan: <- cancel

    Worker1->>Main: stopped gracefully
    Worker2->>Main: stopped gracefully
{{< /mermaid >}}




## 9.4.18.3 ููููู ฺฉุฏ

```go
package main

import (
	"fmt"
	"time"
)

// ุชุงุจุน ฺฉู ุชุง ุฒูุงู ุฏุฑุงูุช ุณฺฏูุงู ูุบู ฺฉุงุฑ ูโฺฉูุฏ
func worker(id int, cancel <-chan struct{}) {
	for {
		select {
		case <-cancel:
			fmt.Printf("โ๏ธ Worker %d ูุชููู ุดุฏ\n", id)
			return
		default:
			fmt.Printf("โ๏ธ Worker %d ุฏุฑ ุญุงู ฺฉุงุฑ...\n", id)
			time.Sleep(500 * time.Millisecond)
		}
	}
}

func main() {
	cancel := make(chan struct{}) // ฺฉุงูุงู ูุบู ูุดุชุฑฺฉ

	// ุงุฌุฑุง ฺูุฏ ฺฏูุฑูุชู worker
	for i := 1; i <= 3; i++ {
		go worker(i, cancel)
	}

	// ุงุฌุฑุง ุงุตู ุชุง ฒ ุซุงูู ุตุจุฑ ูโฺฉูุฏ
	time.Sleep(2 * time.Second)

	// ุงุฑุณุงู ุณฺฏูุงู ูุบู ุจุง ุจุณุชู ฺฉุงูุงู
	fmt.Println("๐ข ุงุฑุณุงู ุณฺฏูุงู ูุบู ุจู ููู ฺฏูุฑูุชูโูุง...")
	close(cancel)

	// ุตุจุฑ ุจุฑุง ูพุงุงู ุงุฌุฑุง ฺฏูุฑูุชูโูุง
	time.Sleep(1 * time.Second)
	fmt.Println("๐ ูพุงุงู ุจุฑูุงูู")
}
```

```shell
$ go run main.go
โ๏ธ Worker 3 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 1 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 2 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 1 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 3 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 2 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 2 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 3 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 1 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 3 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 2 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 1 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 2 ุฏุฑ ุญุงู ฺฉุงุฑ...
๐ข ุงุฑุณุงู ุณฺฏูุงู ูุบู ุจู ููู ฺฏูุฑูุชูโูุง...
โ๏ธ Worker 3 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 1 ุฏุฑ ุญุงู ฺฉุงุฑ...
โ๏ธ Worker 3 ูุชููู ุดุฏ
โ๏ธ Worker 2 ูุชููู ุดุฏ
โ๏ธ Worker 1 ูุชููู ุดุฏ
๐ ูพุงุงู ุจุฑูุงูู
```


ุฏุฑ ุงู ูุซุงูุ ุงูฺฏู **Channel Cancellation** ุจุฑุง ูุชููู ฺฉุฑุฏู ููุฒูุงู ฺูุฏ ฺฏูุฑูุชู ุจู ฺฉุงุฑ ฺฏุฑูุชู ุดุฏู ุงุณุช. ูุฏู ุงู ุงูฺฏู ุขู ุงุณุช ฺฉู ุจุฏูู ูุงุฒ ุจู ูุชุบุฑูุง ุงุดุชุฑุงฺฉ ุง ููู (mutex)ุ ฺูุฏ ฺฏูุฑูุชู ุฑุง ุจูโุตูุฑุช ููุงููฺฏ ู ุงูู ูุชููู ฺฉููุ ุขูโูู ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ฺฉุงูุงู ุณุงุฏู ฺฉู ููุด ุณฺฏูุงู ูุบู (cancel signal) ุฑุง ุงูุง ูโฺฉูุฏ.

ุฏุฑ ุงุจุชุฏุง ุจุฑูุงููุ ฺฉ ฺฉุงูุงู ุงุฒ ููุน `chan struct{}` ุจู ูุงู `cancel` ุชุนุฑู ูโุดูุฏ. ุงู ฺฉุงูุงู ูฺ ุฏุงุฏูโุง ุญูู ููโฺฉูุฏ ู ููุท ููุด ยซุนูุงูุช ุชูููยป ุฏุงุฑุฏ. ุณูพุณ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ุญูููุ ุณู ฺฏูุฑูุชู worker ุฑุงูโุงูุฏุงุฒ ูโุดููุฏ ฺฉู ููฺฏ ุจู ุงู ฺฉุงูุงู ุฏุณุชุฑุณ ุฏุงุฑูุฏ. ูุฑ ฺฏูุฑูุชู ุฏุฑูู ฺฉ ุญููู ุจโููุงุช ุงุฌุฑุง ูโุดูุฏ ู ุฏุฑูู `select` ุจุฑุฑุณ ูโฺฉูุฏ ฺฉู ุขุง ุณฺฏูุงู ูุบู ุงุฒ ฺฉุงูุงู ุฏุฑุงูุช ุดุฏู ุง ูู. ุงฺฏุฑ ุณฺฏูุงู ูุบู ุฏุฑุงูุช ุดูุฏ (`<-cancel`)ุ ฺฏูุฑูุชู ุจุง ฺุงูพ ฺฉ ูพุงู ูุชููู ูโุดูุฏ. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ฺฉุงุฑ ุดุจูโุณุงุฒโุดุฏูโุง ุงูุฌุงู ูโุฏูุฏ ู ุณูพุณ ฺฉู ูโุฎูุงุจุฏ.

ุฏุฑ ุชุงุจุน `main`ุ ุจุฑูุงูู ุจู ูุฏุช ฒ ุซุงูู ููุชุธุฑ ูโูุงูุฏ ุชุง ฺฏูุฑูุชูโูุง ฺูุฏ ุจุงุฑ ูพุงู ยซุฏุฑ ุญุงู ฺฉุงุฑยป ฺุงูพ ฺฉููุฏ. ุณูพุณ ฺฉุงูุงู `cancel` ุฑุง ูโุจูุฏุฏ (`close(cancel)`) ฺฉู ุงู ุนูู ุจู ุนููุงู ุณฺฏูุงู ุชููู ุจุฑุง ุชูุงู ฺฏูุฑูุชูโูุง ุนูู ูโฺฉูุฏ. ุฏุฑ ูุชุฌูุ ูุฑ ฺฏูุฑูุชู ฺฉู ุฏุฑ ุญุงูุช ุงูุชุธุงุฑ ุฑู ุขู ฺฉุงูุงู ุจูุฏูุ ูุนุงู ูโุดูุฏ ู ูุณุฑ ูุบู ุฑุง ุท ูโฺฉูุฏ. ูพุณ ุงุฒ ุขูุ `main` ฺฉู ุตุจุฑ ูโฺฉูุฏ ุชุง ููู ฺฏูุฑูุชูโูุง ูุฑุตุช ฺุงูพ ูพุงู ยซโ๏ธ ูุชููู ุดุฏยป ุฑุง ูพุฏุง ฺฉููุฏ.

ุงู ูุซุงู ุณุงุฏู ุงูุง ูุคุซุฑ ูุดุงู ูโุฏูุฏ ฺฉู ฺฺฏููู ูโุชูุงู ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ฺฉุงูุงู ูุดุชุฑฺฉุ ฺฏูุฑูุชูโูุง ูุชุนุฏุฏ ุฑุง ุจูโุตูุฑุช ููุงููฺฏ ูุชููู ฺฉุฑุฏุ ุจุฏูู ูุงุฒ ุจู ุงุดุชุฑุงฺฉโฺฏุฐุงุฑ ูุชุบุฑ ุง ูุถุนุช ูพฺุฏู. ุงู ุงูฺฏู ุฏุฑ ุณูุงุฑููุง ูุงูุน ูุงููุฏ ูุชูููโุณุงุฒ graceful ุฏุฑ ุณุฑูุฑูุงุ ูุบู ููุฒูุงู ฺูุฏ workerุ ุง ูุงฺฉูุด ุจู ุฎุทุงูุง ุจุญุฑุงู ุจุณุงุฑ ููุฏ ู ูพุฑุงุณุชูุงุฏู ุงุณุช.

## 9.4.18.4 ฺฉุงุฑุจุฑุฏูุง


- **ุฎุงููุดโุณุงุฒ ฺฏูุฑูุชูโูุง:** ุจุฑุง ูุชููู ฺฉุฑุฏู ฺูุฏ ฺฏูุฑูุชู ุจูโุตูุฑุช ููุงููฺฏ ููฺฏุงู ุงุชูุงู ฺฉุงุฑ ุง ุฏุฑุงูุช ุณฺฏูุงู ุฎุฑูุฌ.
- **ูุฏุฑุช worker pool:** ุจุฑุง ูุบู ูููโ workerูุง ุฏุฑ ุตูุฑุช ุฎุทุง ุจุญุฑุงู ุง ูพุงุงู ูพุฑุฏุงุฒุด.
- **ุฌููฺฏุฑ ุงุฒ ูุดุช ฺฏูุฑูุชู (goroutine leak):** ุจุฑุง ูพุงุงู ุฏุงุฏู ุจู ฺฏูุฑูุชูโูุง ฺฉู ุฏฺฏุฑ ูุงุฒ ุจู ุงุฏุงูู ฺฉุงุฑ ุขูโูุง ูุณุช.
- **ฺฉูุชุฑู ุฒูุงู ุงุฌุฑุง:** ุจุฑุง ูุทุน ุนููุงุชโูุง ุทููุงู ุง ูุณุฏูุฏ ุดุฏู ูพุณ ุงุฒ ฺฉ ูุฏุช ูุดุฎุต.
- **ูพุงุฏูโุณุงุฒ graceful shutdown:** ุจุฑุง ูพุงุงู ุงูู ู ููุธู ุณุฑูุณ ููฺฏุงู ุฎุงููุด ุดุฏู ุง ุฏุฑุงูุช ุณฺฏูุงู `SIGINT`.