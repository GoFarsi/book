---
title: '3.3 ูพฺฉุฌ sync'
slug: go-sync-package
weight: 5003
---

ูพฺฉุฌ `sync` ุชู ฺฏู ูุซู ฺฉ ุฌุนุจูโุงุจุฒุงุฑ ุชุฎุตุต ุจุฑุง **ููฺฏุงูโุณุงุฒ (synchronize)** ู ูุฏุฑุช ุฏุณุชุฑุณ ฺูุฏุชุง **goroutine** ุจู ุฏุงุฏู ุง ููุจุน ูุดุชุฑฺฉู.  
ููุช ฺูุฏ goroutine ููุฒูุงู ุจู ฺฉ ุฏุงุฏู ุฏุณุชุฑุณ ูพุฏุง ูโฺฉููุ ุจุฏูู ููุงููฺฏ ููฺฉูู ุฏุงุฏู ุฎุฑุงุจ ุจุดู ุง ุฑูุชุงุฑ ุจุฑูุงูู ุบุฑูุงุจู ูพุดโุจู ุจุดู (Data Race).

`sync` ุฏููุง ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ุงุชูุงู ุณุงุฎุชู ุดุฏู ู ุงุจุฒุงุฑูุง ุฑู ุงุฑุงุฆู ูโุฏู ฺฉู ุงุฌุงุฒู ูโุฏู **ุฏุณุชุฑุณ ููุฒูุงู ุฑู ฺฉูุชุฑู ฺฉูุฏ**.

ุงุจุฒุงุฑูุง ุงุตู `sync`:

- **`Mutex`** โ ููู ุณุงุฏู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฏุณุชุฑุณ ููุฒูุงู ุจู ููุจุน ูุดุชุฑฺฉ.
- **`RWMutex`** โ ููู ุฎูุงูุฏู/ููุดุชู: ฺูุฏ ุฎูุงููุฏู ููุฒูุงู ุง ฺฉ ููุณูุฏู ุฏุฑ ูุฑ ูุญุธู.
- **`WaitGroup`** โ ููุชุธุฑ ูููุฏู ุชุง ููู goroutineูุง ฺฉุงุฑุดูู ุฑู ุชููู ฺฉูู.
- **`Once`** โ ุงุฌุฑุง ฺฉ ฺฉุฏ ููุท ฺฉ ุจุงุฑ ุญุช ุจู ฺูุฏ goroutine.
- **`Pool`** โ ูฺฏูโุฏุงุฑ ูุฌููุนูโุง ุงุฒ ุขุจุฌฺฉุชโูุง ุขูุงุฏู ุจุฑุง ุงุณุชูุงุฏู ูุฌุฏุฏ.
- **`Cond`** โ ููุงููฺฏ ุจุฑ ุงุณุงุณ ุดุฑุท ุง ุฑูุฏุงุฏ (Condition Variable).

> **ูฺฉุชู:** `sync` ููุท ุจุฑุง **ููุงููฺฏโฺฉุฑุฏู ุฏุณุชุฑุณ ุจู ููุงุจุน ูุดุชุฑฺฉ** ุณุงุฎุชู ุดุฏูุ ูู ุจุฑุง ุฒูุงูโุจูุฏ ุง ุงุฌุฑุง ููุฒูุงู.

{{< hint info >}}
ุชูุฌู ฺฉูุฏ ฺฉู ูพฺฉุฌ `sync` ููุท ู ููุท ุจุฑุง ูุฏุฑุช ู ููฺฏุงู ุณุงุฒ ุฏุณุชุฑุณ ูุง ฺฏูุฑูุชู ูุง ุจู ฺฉ ุฏุงุฏู ูุดุชุฑฺฉ ุงุณุชูุงุฏู ู ุดูุฏ.
{{< /hint >}}
## 3.3.1 Mutex โ ููู ูุชูุงุจู

`Mutex` ุง **ููู ูุชูุงุจู** ฺฉ ุงุฒ ุงุตูโุชุฑู ุงุจุฒุงุฑูุง ููฺฏุงูโุณุงุฒ ุฏุฑ ุฒุจุงู Go ุงุณุช ฺฉู ุจุฑุง ุฌููฺฏุฑ ุงุฒ **ุฏุณุชุฑุณ ููุฒูุงู ูุงุงูู (Data Race)** ุจู ุฏุงุฏูโูุง ูุดุชุฑฺฉ ุงุณุชูุงุฏู ูโุดูุฏ. ููุช ฺฉ goroutine ููู ุฑุง ุจุง `Lock()` ูโฺฏุฑุฏุ ุณุงุฑ goroutineูุง ฺฉู ุณุน ฺฉููุฏ ููุงู ููู ุฑุง ุจฺฏุฑูุฏุ ุจุงุฏ ููุชุธุฑ ุจูุงููุฏ ุชุง ููู ุจุง `Unlock()` ุขุฒุงุฏ ุดูุฏ. ุงู ูฺฉุงูุฒู ุชุถูู ูโฺฉูุฏ ฺฉู ุฏุฑ ูุฑ ูุญุธู ููุท ฺฉ goroutine ูโุชูุงูุฏ ุจุฎุด ุจุญุฑุงู (Critical Section) ฺฉุฏ ุฑุง ุงุฌุฑุง ฺฉูุฏ. ุจุฎุด ุจุญุฑุงู ููุงู ูุณูุช ุงุฒ ฺฉุฏ ุงุณุช ฺฉู ุจู ุฏุงุฏูโ ูุดุชุฑฺฉ ุฏุณุชุฑุณ ุฏุงุฑุฏ ู ุชุบุฑ ุขู ููฺฉู ุงุณุช ุจุงุนุซ ุจุฑูุฒ ุฎุทุง ุง ุฑูุชุงุฑ ุบุฑูุงุจู ูพุดโุจู ุดูุฏ.

ฺฉ ุงุฒ ูฺฉุงุช ฺฉูุฏ ุฏุฑ ุงุณุชูุงุฏู ุงุฒ Mutex ุงู ุงุณุช ฺฉู **ููู ุจุงุฏ ุชุง ุญุฏ ุงูฺฉุงู ฺฉูุชุงูโูุฏุช ูฺฏู ุฏุงุดุชู ุดูุฏ**. ุนู ููุท ููุงู ุจุฎุด ุถุฑูุฑ ุงุฒ ฺฉุฏ ุฑุง ููู ฺฉูุฏุ ฺูู ูููโฺฉุฑุฏู ุทููุงู ูโุชูุงูุฏ ุจุงุนุซ ฺฉุงูุด ฺฉุงุฑุง ู ุงุฌุงุฏ ฺฏููฺฏุงู (Bottleneck) ุดูุฏ. ููฺูู ูุฑฺฏุฒ ูุจุงุฏ Mutex ุฑุง ฺฉูพ ฺฉูุฏุ ฺูู ูุฑ Mutex ุฏุงุฎู ฺฉ ูุถุนุช ุฏุงุฑุฏ ู ฺฉูพ ุขู ุจุงุนุซ ูโุดูุฏ ูููโูุง ุจูโุฏุฑุณุช ุนูู ูฺฉููุฏ.

### ูุซุงู ุชุฆูุฑ โ ุขุดูพุฒุฎุงูู ู ุณุจโุฒูู ุณุฑุฎโฺฉุฑุฏู

ูุฑุถ ฺฉูุฏ ูุงุฏุฑุชุงู ุฏุฑ ุขุดูพุฒุฎุงูู ุฏุฑ ุญุงู ุณุฑุฎ ฺฉุฑุฏู ุณุจโุฒูู ุฎูุงู ุงุณุช. ุจุฑุง ุงูฺฉู ฺฉุณ ูุณุท ฺฉุงุฑ ูุฒุงุญู ูุดูุฏ ู ูุธู ฺฉุงุฑ ุจู ูู ูุฎูุฑุฏุ ุฏุฑู ุขุดูพุฒุฎุงูู ุฑุง ูโุจูุฏุฏ. ุญุงูุง ุงู ุฏุฑ ูุซู ฺฉ **Mutex** ุนูู ูโฺฉูุฏ:

- ููุช ุฏุฑ ุจุณุชู ุงุณุช (**Lock** ุดุฏู)ุ ููุท ูุงุฏุฑุชุงู ุฏุงุฎู ุขุดูพุฒุฎุงูู ุงุณุช ู ูโุชูุงูุฏ ุฑู ุณุจโุฒููโูุง ฺฉุงุฑ ฺฉูุฏ.
- ุงฺฏุฑ ฺฉุณ (ูุซูุงู ฺฉ ุงุฒ ุจฺูโูุง) ุจุฎูุงูุฏ ูุงุฑุฏ ุขุดูพุฒุฎุงูู ุดูุฏุ ุจุงุฏ ููุชุธุฑ ุจูุงูุฏ ุชุง ูุงุฏุฑุชุงู ุฏุฑ ุฑุง ุจุงุฒ ฺฉูุฏ (**Unlock**).
- ููุช ูุงุฏุฑุชุงู ฺฉุงุฑุด ุฑุง ุชูุงู ฺฉุฑุฏ ู ุฏุฑ ุฑุง ุจุงุฒ ฺฉุฑุฏุ ููุฑ ุจุนุฏ ูโุชูุงูุฏ ูุงุฑุฏ ุดูุฏ ู ฺฉุงุฑ ุงูุฌุงู ุฏูุฏ.

ุญุงูุง ูุฑุถ ฺฉูุฏ ุฏุฑ ุทูู ฺฉุงุฑุ ฺฉ ุงุฒ ุจฺูโูุง ุฎู ุนุฌูู ุฏุงุฑุฏ ู ุจุฏูู ุงุฌุงุฒู ูุงุฑุฏ ูโุดูุฏ ู ฺฉ ูุดุช ุณุจโุฒูู ุจุฑูโุฏุงุฑุฏ. ุงู ููุงู **Data Race** ุงุณุช ฺฉู ุจุฏูู ููู ุงุชูุงู ูโุงูุชุฏ ู ูโุชูุงูุฏ ุจุงุนุซ ุฎุฑุงุจ ุดุฏู ุจุฑูุงูู (ุง ุฏุฑ ุงู ูุซุงูุ ฺฉูุชุฑ ุดุฏู ุณุจโุฒููโูุง ๐) ุดูุฏ. Mutex ุฏููุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุงู ููุน ุชุฏุงุฎู ุณุงุฎุชู ุดุฏู ุงุณุช.

{{<img url="#" image="../../assets/img/content/chapter3/sync/1.jpg" alt="sync mutex">}}

### 3.1.1.1 ุณุงุฎุชุงุฑ Mutex ุฏุฑ Go

`sync.Mutex` ุฏู ูุชุฏ ุงุตู ุฏุงุฑู:

1. **`Lock()`**
    - ููุช ฺฉ goroutine ุงู ูุชุฏ ุฑู ุตุฏุง ุจุฒููุ ููู ุฑู ูโฺฏุฑู.
    - ุงฺฏู ููู ูุจูุงู ุชูุณุท goroutine ุฏฺฏู ฺฏุฑูุชู ุดุฏู ุจุงุดูุ ุงู goroutine ููุชุธุฑ ูโูููู (ูุณุฏูุฏ ูโุดู) ุชุง ููู ุขุฒุงุฏ ุจุดู.
2. **`Unlock()`**
    - ููู ุฑู ุขุฒุงุฏ ูโฺฉูู ุชุง goroutineูุง ุฏฺฏู ุจุชููู ูุงุฑุฏ ุจุฎุด ูููโุดุฏู ุจุดู.

> โก **ูฺฉุชู ููู ุชููุฏ:**  
> ุจุนุฏ ุงุฒ ูุฑ `Lock()` ุจูุงูุงุตูู `defer Unlock()` ุจููุณุฏ ุชุง ุญุช ุงฺฏุฑ ูุณุท ฺฉุงุฑ panic ุง return ุงุชูุงู ุงูุชุงุฏุ ููู ุขุฒุงุฏ ุจุดู:
> 
> ```go
> mu.Lock()
> defer mu.Unlock()
> ```

### 3.1.1.2 ูุซุงู ุณุงุฏู Mutex

ุฏุฑ ุงู ูุซุงูุ ฺูุงุฑ goroutine ูโุฎูุงู ููุฒูุงู ููุฏุงุฑ ฺฉ ูุชุบุฑ ูุดุชุฑฺฉ (`count`) ุฑู ุชุบุฑ ุจุฏู:

{{< play >}}
package main

import (
	"fmt"
	"sync"
	"time"
)

var count int // ูุชุบุฑ ูุดุชุฑฺฉ
var mu sync.Mutex

func main() {
	for i := 0; i < 4; i++ {
		go increment()
	}
	time.Sleep(time.Second)
}

func increment() {
	mu.Lock()           // ฺฏุฑูุชู ููู
	defer mu.Unlock()   // ุขุฒุงุฏ ฺฉุฑุฏู ููู ุจุนุฏ ุงุฒ ุงุชูุงู ฺฉุงุฑ
	count++
	fmt.Printf("Count: %d\n", count)
}
{{< /play >}}


### 3.1.1.3 ูฺฉุงุช ฺฉุงุฑุจุฑุฏ ู ุชููุฏ Mutex

1. **ูุญุฏูุฏู ููู ุฑู ฺฉูฺฺฉ ูฺฏู ุฏุงุฑุฏ**  
    ููู ุฑู ููุท ุจุฑุง ุจุฎุด ุงุฒ ฺฉุฏ ฺฉู ูุงุฒ ุจู ุญูุงุธุช ุฏุงุฑู ุจฺฏุฑุฏ. ูููโฺฉุฑุฏู ุจุฎุดโูุง ุจุฒุฑฺฏ ฺฉุฏ ูโุชููู ุจุงุนุซ ุงูุช ฺฉุงุฑุง ุจุดู.
2. **ุงุฒ ฺฉูพ Mutex ุฎูุฏุฏุงุฑ ฺฉูุฏ**  
    ููุดู Mutex ุฑู ุจุง ุงุดุงุฑูโฺฏุฑ (pointer) ูพุงุณ ุจุฏุฏุ ฺูู ฺฉูพโฺฉุฑุฏู Mutex ูโุชููู ุจุงุนุซ ุฑูุชุงุฑ ุบุฑูุงุจู ูพุดโุจู ุจุดู.
3. **ุงุญุชุงุท ุฏุฑ ูููโูุง ุชู ุฏุฑ ุชู (Nested Locks)**  
    ฺฏุฑูุชู ฺูุฏ ููู ุจู ุชุฑุชุจ ุงุดุชุจุงู ูโุชููู ุจุงุนุซ Deadlock ุจุดู. ููุดู ุชุฑุชุจ ูููโฺฏุฑ ุฑู ฺฉุณุงู ูฺฏู ุฏุงุฑุฏ.
4. **ุงุณุชูุงุฏู ุฏุฑ ุณุงุฎุชุงุฑ ุฏุงุฏูโูุง**  
    ูโุชููุฏ Mutex ุฑู ุจู ุนููุงู ููุฏ ุฏุฑ ฺฉ struct ุจุฐุงุฑุฏ ุชุง ุนููุงุช ุฑู ุฏุงุฏูโูุง ุงูู struct ุงูู ุจุดู.

### 3.1.1.4 ูุซุงู ูพุดุฑูุชู: Mutex ุฏุฑ struct

{{< play >}}
package main

import (
	"fmt"
	"sync"
)

type SafeCounter struct {
	mu    sync.Mutex
	value int
}

func (c *SafeCounter) Inc() {
	c.mu.Lock()
	defer c.mu.Unlock()
	c.value++
}

func (c *SafeCounter) Value() int {
	c.mu.Lock()
	defer c.mu.Unlock()
	return c.value
}

func main() {
	counter := &SafeCounter{}
	var wg sync.WaitGroup

	for i := 0; i < 1000; i++ {
		wg.Add(1)
		go func() {
			defer wg.Done()
			counter.Inc()
		}()
	}

	wg.Wait()
	fmt.Println("Final Count:", counter.Value())
}
{{< /play >}}

### 3.1.1.5 ูุฒุงุง ู ูุนุงุจ Mutex

**ูุฒุงุง:**

- ูพุงุฏูโุณุงุฒ ุณุงุฏู ู ูุณุชูู.
- ุจุฏูู overhead ุงุถุงู ุจุฑุง ูุฏุฑุช channel ุง ุณุงุฎุชุงุฑ ูพฺุฏู.

**ูุนุงุจ:**

- ูููโฺฏุฐุงุฑ ุจุด ุงุฒ ุญุฏ ูโุชููู ุจุงุนุซ ุงูุช ฺฉุงุฑุง ุจุดู.
- ุงุดุชุจุงู ุฏุฑ ูุฏุฑุช Lock/Unlock ููฺฉูู ุจุงุนุซ Deadlock ุง Data Race ุจุดู.

### 3.3.1.6 ุณูุงุฑููุง ุงุณุชูุงุฏู

1. **ููฺฏุงู ุณุงุฒ ุฏุณุชุฑุณ ุจู ูุชุบุฑูุง ูุดุชุฑฺฉ:** ฺฉ mutex ู ุชูุงูุฏ ุจุฑุง ููฺฏุงู ุณุงุฒ ุฏุณุชุฑุณ ุจู ูุชุบุฑูุง ูุดุชุฑฺฉ ุจู ฺูุฏู ฺฏูุฑูุชู ุงุณุชูุงุฏู ุดูุฏ. ุงู ู ุชูุงูุฏ ุฏุฑ ููุงุฑุฏ ููุฏ ุจุงุดุฏ ฺฉู ฺูุฏู ฺฏูุฑูุชู ูุงุฒ ุจู ุฎูุงูุฏู ุง ุจู ุฑูุฒ ุฑุณุงู ฺฉ ูุชุบุฑ ุจู ุทูุฑ ููุฒูุงู ุฏุงุฑูุฏ.

2. **ููุงููฺฏ ุฏุณุชุฑุณ ุจู ุญุงูุช ูุดุชุฑฺฉ:** ฺฉ mutex ู ุชูุงูุฏ ุจุฑุง ููุงููฺฏ ฺฉุฑุฏู ุฏุณุชุฑุณ ุจู ุญุงูุช ูุดุชุฑฺฉ ุจู ฺูุฏู ฺฏูุฑูุชู ุงุณุชูุงุฏู ุดูุฏ. ุจู ุนููุงู ูุซุงูุ ููฺฉู ุงุณุช ุงุฒ ฺฉ mutex ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ููุท ฺฉ ฺฏูุฑูุชู ู ุชูุงูุฏ ฺฉ ุณุงุฎุชุงุฑ ุฏุงุฏู ูุดุชุฑฺฉ ุฑุง ุฏุฑ ฺฉ ุฒูุงู ุชุบุฑ ุฏูุฏ.

3. **ูพุงุฏู ุณุงุฒ ุงูฺฏููุง ุชููุฏฺฉููุฏู-ูุตุฑู ฺฉููุฏู (producer-consumer):** ฺฉ mutex ู ุชูุงูุฏ ุจุฑุง ูพุงุฏู ุณุงุฒ ุงูฺฏููุง ุชููุฏฺฉููุฏู-ูุตุฑู ฺฉููุฏู ุงุณุชูุงุฏู ุดูุฏุ ฺฉู ุฏุฑ ุขู ฺฉ ุง ฺูุฏ ฺฏูุฑูุชู ุฏุงุฏู ุชููุฏ ู ฺฉููุฏ ู ฺฉ ุง ฺูุฏ ฺฏูุฑูุชู ุขู ุฑุง ูุตุฑู ู ฺฉููุฏ. mutex ู ุชูุงูุฏ ุจุฑุง ููฺฏุงู ุณุงุฒ ุฏุณุชุฑุณ ุจู ุณุงุฎุชุงุฑ ุฏุงุฏู ูุดุชุฑฺฉ ฺฉู ุฏุงุฏู ูุง ุฑุง ูฺฏู ู ุฏุงุฑุฏ ุงุณุชูุงุฏู ุดูุฏ.

{{< hint warning >}}
**ฒ ูฺฉุชู ุฎู ููู**

1. ุณุน ฺฉูุฏ ูพุณ ุงุฒ ุงูฺฉู ุชุงุจุน Lock ุฑุง ูุฑุงุฎูุงู ูฺฉูุฏ ุชุงุจุน Unlock ุฑุง ุฏุงุฎู defer ูุฑุงุฑ ุฏูุฏ.
2. ุฒูุงูฺฉู ูุตุฏ ุฏุงุฑุฏ Mutex ุฑุง ุจู ุนููุงู ูพุงุฑุงูุชุฑ ูุฑูุฏ ุจุฑุง ุชูุงุจุน ุชุนุฑู ฺฉูุฏ ุจูุชุฑ ุงุณุช ุงุฒ ููุน {{< tooltip text="ุงุดุงุฑู ฺฏุฑ" note="pointer" >}} ุจุงุดุฏ.
{{< /hint >}}

## 3.3.2 RWMutex โ ููู ุฎูุงูุฏู/ููุดุชู

`RWMutex` ูุฎูู **Read-Write Mutex** ูุณุช ู ุฏุฑูุงูุน ูุณุฎูโ ูพุดุฑูุชูโุชุฑ `Mutex` ูุญุณูุจ ูโุดู.  
ูุธููโุงุด ููฺฏุงูโุณุงุฒ ุฏุณุชุฑุณ ููุฒูุงู ุจู ฺฉ ุฏุงุฏู ุง ููุจุน ูุดุชุฑฺฉูุ ูู ุจุง ฺฉ ูุงุจูุช ุงุถุงูู: **ฺูุฏ goroutine ูโุชููู ููุฒูุงู ุฏุงุฏู ุฑู ุจุฎูููุ ูู ููุท ฺฉ goroutine ูโุชููู ุจููุณู ู ููุช ุฏุฑ ุญุงู ููุดุชููุ ูฺโฺฉุณ ุญู ุฎูุงูุฏู ูุฏุงุฑู**.

### 3.3.2.1 ฺุฑุง RWMutexุ

ุฏุฑ ุฎู ุงุฒ ุจุฑูุงููโูุงุ ุชุนุฏุงุฏ ุนููุงุช **ุฎูุงูุฏู (Read)** ุฑู ุฏุงุฏูโูุง ุฎู ุจุดุชุฑ ุงุฒ **ููุดุชู (Write)** ูุณุช. ูุซูุง:

- ฺฉุด (Cache) ฺฉู ุจุดุชุฑ ููุชโูุง ุฏุงุฏู ุฑู ุงุฒ ุญุงูุธู ูโุฎููู ู ููุท ฺฏุงู ุจูโุฑูุฒุฑุณุงู ูโฺฉูู.
- ุชูุธูุงุช ุจุฑูุงูู (Configuration) ฺฉู ุจุงุฑูุง ุฎููุฏู ูโุดู ูู ุจู ูุฏุฑุช ุชุบุฑ ูพุฏุง ูโฺฉูู.

ุฏุฑ ุงู ููุงูุนุ ุงุณุชูุงุฏู ุงุฒ ฺฉ `Mutex` ุณุงุฏู ุจุงุนุซ ูโุดู ุญุช ููุช ฺูุฏ goroutine ููุท ูโุฎูุงู ุฏุงุฏู ุฑู ุจุฎูููุ ูุฌุจูุฑ ุจุดู ููุชุธุฑ ูู ุจูููู. ุงูุง `RWMutex` ุงุฌุงุฒู ูโุฏู ฺูุฏ ุฎูุงููุฏู ููุฒูุงู ฺฉุงุฑ ฺฉูู ู ููุท ูููุน ููุดุชู ููู ููุชุธุฑ ุจูููู.

### 3.3.2.2 ูุชุฏูุง ุงุตู RWMutex

- **`RLock()`** โ ฺฏุฑูุชู ููู ุฎูุงูุฏู. ฺูุฏ goroutine ูโุชููู ููุฒูุงู RLock ุจฺฏุฑู.
- **`RUnlock()`** โ ุขุฒุงุฏ ฺฉุฑุฏู ููู ุฎูุงูุฏู.
- **`Lock()`** โ ฺฏุฑูุชู ููู ููุดุชู. ููุท ฺฉ goroutine ูโุชููู ููุฒูุงู Lock ุจฺฏุฑู ู ุชุง ุฒูุงู ฺฉู ููู ููุดุชู ูุนุงููุ ูฺโฺฉุณ ููโุชููู ุจุฎููู ุง ุจููุณู.
- **`Unlock()`** โ ุขุฒุงุฏ ฺฉุฑุฏู ููู ููุดุชู.

### 3.3.2.3 ูุซุงู ุณุงุฏู RWMutex

{{< play >}}
package main

import (
	"fmt"
	"sync"
	"time"
)

type SafeMap struct {
	mu   *sync.RWMutex
	data map[string]string
}

func (s *SafeMap) Read(key string) string {
	s.mu.RLock()
	defer s.mu.RUnlock()
	return s.data[key]
}

func (s *SafeMap) Write(key, value string) {
	s.mu.Lock()
	defer s.mu.Unlock()
	s.data[key] = value
}

func main() {
	var mu sync.RWMutex

	smap := SafeMap{mu: &mu, data: make(map[string]string)}

	// ููุณูุฏู
	go func() {
		for i := range 5 {
			smap.Write(fmt.Sprintf("book-%d", i), fmt.Sprintf("value-%d", i))
			fmt.Printf("Writer write %d\n", i)
			time.Sleep(200 * time.Millisecond)
		}
	}()

	// ฺูุฏ ุฎูุงููุฏู ููุฒูุงู
	for i := range 3 {
		go func() {
			for j := range 5 {
				fmt.Printf("Reader %d read %s\n", i, smap.Read(fmt.Sprintf("book-%d", j)))
				time.Sleep(500 * time.Millisecond)
			}
		}()
	}

	time.Sleep(3 * time.Second)
}
{{< /play >}}

ุฏุฑ ุงู ูุซุงูุ ฺูุฏ goroutine ููุฒูุงู ุงุฒ ูุชุฏ `Read()` ุงุณุชูุงุฏู ูโฺฉูู ู ฺูู `RLock()` ุงุณุชูุงุฏู ุดุฏูุ ููู ูโุชููู ุจุฏูู ููุชุธุฑ ูููุฏู ุจุฎููู. ูู ูููุน ููุดุชูุ ููู ููุดุชู (`Lock()`) ููู ุฑู ูุชููู ูโฺฉูู ุชุง ุนููุงุช ุงูู ุงูุฌุงู ุจุดู.

### 3.3.2.4 ูฺฉุงุช ู ุชุฑููุฏูุง ุงุณุชูุงุฏู ุงุฒ RWMutex

1. **ููุช ุจุดุชุฑ ุฎูุงูุฏู ุฏุงุฑูุ ุงุฒ RWMutex ุงุณุชูุงุฏู ฺฉูุฏ**  
    ุงฺฏุฑ ูุณุจุช ุฎูุงูุฏู ุจู ููุดุชู ูพุงู ุจุงุดู (ุนู ููุดุชู ุฒุงุฏ ุจุงุดู)ุ ุงุณุชูุงุฏู ุงุฒ RWMutex ููฺฉูู ุญุช ฺฉูุฏุชุฑ ุงุฒ Mutex ุณุงุฏู ุจุงุดูุ ฺูู ูุฏุฑุช ูููโูุง ุฎูุงูุฏู/ููุดุชู ูพฺุฏูโุชุฑู.
2. **ูุฑฺฏุฒ ููู ุฎูุงูุฏู ู ููุดุชู ุฑุง ููุฒูุงู ูฺฏุฑุฏ**  
    ฺฏุฑูุชู `RLock()` ู ุณูพุณ ุชูุงุด ุจุฑุง ฺฏุฑูุชู `Lock()` ุฏุฑ ููุงู goroutine ุจุงุนุซ Deadlock ูโุดู.
3. **ูุญุฏูุฏู ููู ุฑุง ฺฉูฺฺฉ ูฺฏู ุฏุงุฑุฏ**  
    ููุท ููุงู ุจุฎุด ุญุณุงุณ ุจู ุชุบุฑ ุฏุงุฏู ุฑุง ููู ฺฉูุฏ. ุงู ฺฉุงุฑ ุจุงุนุซ ุงูุฒุงุด ุนููฺฉุฑุฏ ู ฺฉุงูุด ุฒูุงู ุงูุชุธุงุฑ ูโุดูุฏ.
4. **ูููโูุง ุฑุง ุฌูุช ุจุงุฒ ู ุจุณุชู ฺฉูุฏ**  
    ูุฑ `RLock()` ุจุงุฏ ุจุง `RUnlock()` ู ูุฑ `Lock()` ุจุงุฏ ุจุง `Unlock()` ุฌูุช ุดูุฏ.

### 3.3.2.5 ูุซุงู ฺฉุงุฑุจุฑุฏ โ ฺฉุด ุฎูุงูุฏู/ููุดุชู

ูุฑุถ ฺฉูุฏ ฺฉ ุณุณุชู ุฏุงุฑู ฺฉู ููุช ุงุฑุฒ ุฑุง ุฐุฎุฑู ูโฺฉูุฏ:

- ุฏูโูุง goroutine ุฏุฑ ุญุงู ุฎูุงูุฏู ููุช ูุณุชูุฏ.
- ููุท ฺฉ goroutine ูุฑ ฺูุฏ ุซุงูู ฺฉุจุงุฑ ููุช ุฑุง ุจูโุฑูุฒุฑุณุงู ูโฺฉูุฏ.

ุฏุฑ ุงู ุณูุงุฑู RWMutex ุจุงุนุซ ูโุดูุฏ ุฎูุงููุฏูโูุง ูุนุทู ููุฏฺฏุฑ ูุดููุฏ ู ููุท ููฺฏุงู ุจุฑูุฒุฑุณุงูุ ููู ููุชุธุฑ ุจูุงููุฏ.

```go
type PriceCache struct {
	mu    sync.RWMutex
	price float64
}

func (p *PriceCache) Get() float64 {
	p.mu.RLock()
	defer p.mu.RUnlock()
	return p.price
}

func (p *PriceCache) Set(val float64) {
	p.mu.Lock()
	defer p.mu.Unlock()
	p.price = val
}
```

## 3.3.3 WaitGroup โ ููุงููฺฏ ูพุงุงู ฺฉุงุฑ goroutineูุง

`WaitGroup` ุฏุฑ ูพฺฉุฌ `sync` ฺฉ ุงุฒ ูพุฑฺฉุงุฑุจุฑุฏุชุฑู ุงุจุฒุงุฑูุง ุจุฑุง ููฺฏุงูโุณุงุฒ ุงุณุช ฺฉู ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ **ููุชุธุฑ ุจูุงูุฏ ุชุง ฺฏุฑูู ุงุฒ goroutineูุง ฺฉุงุฑุดุงู ุฑุง ุชูุงู ฺฉููุฏ**.  
ุงุฏูโุงุด ุณุงุฏู ุงุณุช: ุดูุง ูุจู ุงุฒ ุงุฌุฑุง goroutineูุง ุจู WaitGroup ูโฺฏูุฏ ฺฉู ฺูุฏุชุง ฺฉุงุฑ ูุฑุงุฑ ุงุณุช ุงูุฌุงู ุดูุฏุ ูุฑ goroutine ุจุนุฏ ุงุฒ ุงุชูุงู ฺฉุงุฑ ุจู WaitGroup ุฎุจุฑ ูโุฏูุฏุ ู ููุช ููู ฺฉุงุฑูุง ุชูุงู ุดุฏุ ุจุฑูุงูู ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ.

### 3.3.3.1 ูุชุฏูุง ุงุตู WaitGroup

1. **`Add(delta int)`**
    - ุชุนุฏุงุฏ ฺฉุงุฑูุง ฺฉู WaitGroup ุจุงุฏ ููุชุธุฑุดุงู ุจูุงูุฏ ุฑุง ุงุถุงูู ุง ฺฉู ูโฺฉูุฏ.
    - ูุนูููุงู ูุจู ุงุฒ ุงุฌุฑุง goroutineูุง ุงุณุชูุงุฏู ูโุดูุฏ (`Add(n)` ุจุฑุง n ุชุง goroutine).
2. **`Done()`**
    - ูุดุงู ูโุฏูุฏ ฺฉู ฺฉ ุงุฒ ฺฉุงุฑูุง ุชูุงู ุดุฏู ุงุณุช.
    - ูุนุงุฏู `Add(-1)` ุงุณุช.
    - ูุนูููุงู ุฏุฑ ุงุจุชุฏุง goroutine ุจุง `defer` ูุฑุงุฎูุงู ูโุดูุฏ.
3. **`Wait()`**
    - ุจุฑูุงูู ุฑุง ุชุง ุฒูุงู ฺฉู ุดูุงุฑุด WaitGroup ุจู ุตูุฑ ุจุฑุณุฏ ูุณุฏูุฏ ูโฺฉูุฏ.

### 3.3.3.2 ูุซุงู ุณุงุฏู WaitGroup

{{< play >}}
package main

import (
	"fmt"
	"sync"
	"time"
)

func main() {
	var wg sync.WaitGroup
	wg.Add(3) // ุงูุชุธุงุฑ ุจุฑุง 3 goroutine

	go worker("A", &wg)
	go worker("B", &wg)
	go worker("C", &wg)

	wg.Wait() // ุตุจุฑ ุชุง ูพุงุงู ููู goroutineูุง
	fmt.Println("All workers finished!")
}

func worker(name string, wg *sync.WaitGroup) {
	defer wg.Done() // ุงุนูุงู ูพุงุงู ฺฉุงุฑ
	fmt.Printf("Worker %s starting...\n", name)
	time.Sleep(time.Second)
	fmt.Printf("Worker %s done.\n", name)
}
{{< /play >}}

### 3.3.3.3 ูุซุงู ฺฉุงุฑุจุฑุฏ โ ุฏุงูููุฏ ููุฒูุงู ูุงูโูุง

ูุฑุถ ฺฉูุฏ ูโุฎูุงูู ฺูุฏ ูุงู ุฑุง ุจู ุตูุฑุช ููุงุฒ ุฏุงูููุฏ ฺฉูู ู ููุชุธุฑ ุจูุงูู ุชุง ููู ุฏุงูููุฏูุง ฺฉุงูู ุดููุฏ:

{{< play >}}
package main

import (
	"fmt"
	"sync"
	"time"
)

func downloadFile(url string, wg *sync.WaitGroup) {
	defer wg.Done()
	fmt.Println("Downloading:", url)
	time.Sleep(2 * time.Second)
	fmt.Println("Downloaded:", url)
}

func main() {
	var wg sync.WaitGroup
	files := []string{"file1.zip", "file2.zip", "file3.zip"}

	wg.Add(len(files))
	for _, f := range files {
		go downloadFile(f, &wg)
	}

	wg.Wait()
	fmt.Println("All downloads complete!")
}
{{< play >}}

### 3.3.3.4 ูฺฉุงุช ู ุชุฑููุฏูุง ุงุณุชูุงุฏู ุงุฒ WaitGroup

1. **ููุดู `Add()` ุฑุง ูุจู ุงุฒ ุดุฑูุน goroutineูุง ุงูุฌุงู ุฏูุฏ**  
    ุงฺฏุฑ `Add()` ุฑุง ุจุนุฏ ุงุฒ ุดุฑูุน goroutineูุง ุงูุฌุงู ุฏูุฏุ ููฺฉู ุงุณุช WaitGroup ุตูุฑ ุดูุฏ ู `Wait()` ุจูุงูุงุตูู ุงุฏุงูู ูพุฏุง ฺฉูุฏ (Race Condition).
2. **ุงุฒ ุงุดุงุฑูโฺฏุฑ ุจุฑุง ูพุงุณ ุฏุงุฏู WaitGroup ุงุณุชูุงุฏู ฺฉูุฏ**  
    WaitGroup ุฑุง ฺฉูพ ูฺฉูุฏุ ฺูู ูุฑ ฺฉูพ ุดูุงุฑุด ุฎูุฏุด ุฑุง ุฏุงุฑุฏ ู ููุงููฺฏ ุงุฒ ุจู ูโุฑูุฏ.
3. **ุชุนุฏุงุฏ Add ู Done ุจุงุฏ ุฏููุงู ุจุฑุงุจุฑ ุจุงุดุฏ**  
    ุงฺฏุฑ ุชุนุฏุงุฏ `Done()` ฺฉูุชุฑ ุงุฒ `Add()` ุจุงุดุฏุ `Wait()` ุจุฑุง ููุดู ูุณุฏูุฏ ูโูุงูุฏ.  
    ุงฺฏุฑ ุชุนุฏุงุฏ ุจุดุชุฑ ุจุงุดุฏุ Panic ุฑุฎ ูโุฏูุฏ.
4. **ุชุฑฺฉุจ ุจุง Channel ุจุฑุง ูุชุงุฌ**  
    ูโุชูุงูุฏ WaitGroup ุฑุง ุจุง Channel ุชุฑฺฉุจ ฺฉูุฏ ุชุง ุจุนุฏ ุงุฒ ุงุชูุงู ููู goroutineูุงุ ุฏุงุฏูโูุง ุฑุง ูพุฑุฏุงุฒุด ฺฉูุฏ.

### 3.3.3.5 ุงุดุชุจุงู ุฑุงุฌ โ Add ุฏุงุฎู goroutine

ุงุดุชุจุงู:

```go
for _, task := range tasks {
	go func(t string) {
		wg.Add(1) // โ ุงุดุชุจุงู
		doTask(t)
		wg.Done()
	}(task)
}
```

**ฺุฑุง ุงุดุชุจุงููุ**  

ฺูู ููฺฉูู goroutine ูููุฒ Add ูฺฉุฑุฏู ุจุงุดู ูู main `Wait()` ุฑู ุตุฏุง ุจุฒูู ู ุดูุงุฑุด ุตูุฑ ุจุดู.  

ุฑุงู ุฏุฑุณุช:

```go
wg.Add(len(tasks))
for _, task := range tasks {
	go func(t string) {
		defer wg.Done()
		doTask(t)
	}(task)
}
```

### 3.3.3.6 ูุซุงู ูพุดุฑูุชู โ ูพุฑุฏุงุฒุด ููุงุฒ ุจุง WaitGroup ู Semaphore

ฺฏุงู ุชุนุฏุงุฏ goroutineูุง ููุฒูุงู ุจุงุฏ ูุญุฏูุฏ ุดูุฏ. ุชุฑฺฉุจ WaitGroup ุจุง Channel ุจู ุนููุงู Semaphore ูโุชูุงูุฏ ุงู ฺฉุงุฑ ุฑุง ุงูุฌุงู ุฏูุฏ:

{{< hint info >}}
ุงฺฏุฑ ุฏุฑุฎุตูุต ูพุชุฑู Semaphore ุจุดุชุฑ ูุฎูุงุฏ ุจุฏุงูุฏ ุจู [ุงูุฌุง](../../chapter-9/concurrency-patterns/go-concurrency-pattern-semaphore) ูุฑุงุฌุนู ฺฉูุฏ.
{{< /hint >}}

{{< play >}}
package main

import (
	"fmt"
	"sync"
	"time"
)

func process(id int, wg *sync.WaitGroup, sem chan struct{}) {
	defer wg.Done()
	sem <- struct{}{} // ฺฏุฑูุชู ุงุณูุงุช
	defer func() { <-sem }() // ุขุฒุงุฏ ฺฉุฑุฏู ุงุณูุงุช (ุงููโุชุฑ)
	fmt.Printf("Processing %d\n", id)
	time.Sleep(time.Second)
}

func main() {
	var wg sync.WaitGroup
	sem := make(chan struct{}, 3) // ุญุฏุงฺฉุซุฑ 3 goroutine ููุฒูุงู

	for i := range 10 {
		wg.Add(1)
		go process(i, &wg, sem)
	}

	wg.Wait()
	fmt.Println("All processing complete!")
}
{{< /play >}}


{{< hint info >}}
**ณ ูฺฉุชู ุฎู ููู**

1. ุณุงุฎุชุงุฑ WaitGroup ฺฉ ุงุฒ ูพุฑฺฉุงุฑุจุฑุฏ ุชุฑู ูุงุจูุช ูุง ุจุฑุง ุจุญุซ ููุฒูุงู ู ุจุงุดุฏ ู ุจุฑุฎ ุงููุงุช ุจุฑุง ุฌููฺฏุฑ ุงุฒ Data race ู ููฺูู ุจุฑุง ุชุฑุชุจ ุฏู ุนููุงุช ููุฒูุงู ูู ู ุชูุงู ุงุฒ ุงู ุงุณุชูุงุฏู ฺฉุฑุฏ.
2. ุณุน ฺฉูุฏ WaitGroup ุฑุง ุจุตูุฑุช ุงุดุงุฑู ฺฏุฑ ุจู ุชูุงุจุน ฺฉู ุฏุงุฎู ฺฏูุฑูุชู ูุฑุงุฑ ุฏุงุฑูุฏ ูพุงุณ ุฏูุฏ.
3. ูฺููุช ุชุนุฏุงุฏ ฺฏูุฑูุชู ุฑุง ุจุดุชุฑ ุง ฺฉูุชุฑ ุงุฒ ุงูู ุชุนุฏุงุฏ ฺฉู ุฏุงุฑุฏ ุจู ูุชุฏ Add โูุฏูุฏ ฺูู ุจุง ุฎุทุง Panic ููุงุฌู ุฎูุงูุฏ ุดุฏ.
{{< /hint >}}

## 3.3.4 Once โ ุงุฌุฑุง ฺฉ ฺฉุฏ ููุท ฺฉุจุงุฑ

`sync.Once` ฺฉ ุงุฒ ุงุจุฒุงุฑูุง ูพฺฉุฌ `sync` ูุณุช ฺฉู ุชุถูู ูโฺฉูู **ฺฉ ุชฺฉู ฺฉุฏ ููุท ฺฉุจุงุฑ ุฏุฑ ฺฉู ุทูู ุงุฌุฑุง ุจุฑูุงูู ุงุฌุฑุง ุจุดู**ุ ุญุช ุงฺฏุฑ ฺูุฏู goroutine ุจู ุทูุฑ ููุฒูุงู ุงูู ุฑู ุตุฏุง ุจุฒูู.

ุงู ุงุจุฒุงุฑ ูุนูููุงู ุจุฑุง ฺฉุงุฑูุง ูุซู **ููุฏุงุฑุฏู ุงููู (Initialization)** ุง **ุณุงุฎุช ููุงุจุน ูุดุชุฑฺฉ** ุงุณุชูุงุฏู ูโุดู ฺฉู ูุงุฒู ููุท ฺฉุจุงุฑ ุงูุฌุงู ุจุดู.

### 3.3.4.1 ูุชุฏ ุงุตู Once

- **`Do(func())`**  
    ุงู ูุชุฏ ฺฉ ุชุงุจุน ุฑู ูโฺฏุฑู ู ููุท ุงููู ุจุงุฑ ฺฉู ุตุฏุง ุฒุฏู ุจุดูุ ุงูู ุชุงุจุน ุฑู ุงุฌุฑุง ูโฺฉูู.  
    ุงฺฏุฑ ฺูุฏ goroutine ููุฒูุงู `Do()` ุฑู ุตุฏุง ุจุฒููุ ููุท ฺฉ ุงุฌุฑุง ูโุดู ู ุจูู ููุชุธุฑ ูโูููู ุชุง ุชุงุจุน ุงุฌุฑุง ุจุดู.

### 3.3.4.2 ฺุฑุง ุงุฒ Once ุงุณุชูุงุฏู ฺฉููุ

ุจุฏูู `Once`ุ ุงฺฏุฑ ุจุฎูุงูู ฺฉุงุฑ ุฑู ููุท ฺฉุจุงุฑ ุงูุฌุงู ุจุฏูุ ูุฌุจูุฑู ุงุฒ ฺฉ `Mutex` ุจุฑุง ูุญุงูุธุช ุงุฒ ฺฉุฏ ุงุณุชูุงุฏู ฺฉูู ู ุฎูุฏููู ูุถุนุช (state) ุฑู ฺฺฉ ฺฉูู ฺฉู ุขุง ูุจูุงู ุงุฌุฑุง ุดุฏู ุง ูู. `Once` ุงู ฺฉุงุฑ ุฑู ุจู ุตูุฑุช thread-safe ู ุจููู ุงูุฌุงู ูโุฏูุ ุจุฏูู ุงูฺฉู ูุงุฒ ุจุงุดู ูุง ุฎูุฏููู ูุฏุฑุช ฺฉูู.

### 3.3.4.3 ูุซุงู ุณุงุฏู Once

{{< play >}}
package main

import (
	"fmt"
	"sync"
)

var once sync.Once

func initConfig() {
	fmt.Println("Config initialized")
}

func main() {
	for i := 0; i < 5; i++ {
		go once.Do(initConfig)
	}

	// ฺฉู ุตุจุฑ ูโฺฉูู ุชุง goroutineูุง ุงุฌุฑุง ุจุดู
	var wg sync.WaitGroup
	wg.Add(1)
	go func() {
		defer wg.Done()
	}()
	wg.Wait()
}
{{< /play >}}

ุญุช ุจุง ุงุฌุฑุง ฺูุฏู goroutineุ ูพุงู ููุท ฺฉุจุงุฑ ฺุงูพ ูโุดู.

### 3.3.4.4 ุงุณุชูุงุฏู ุงุฒ Once ุจุฑุง ูพุงุฏูโุณุงุฒ Singleton

`Once` ฺฉ ุงุฒ ุจูุชุฑู ุฑุงูโูุง ุจุฑุง ูพุงุฏูโุณุงุฒ **ุงูฺฏู Singleton** ุฏุฑ Go ูุณุชุ ฺูู ุจู ุตูุฑุช ุงูู ู ููุฒูุงู (thread-safe) ุชุถูู ูโฺฉูู ฺฉู ููุท ฺฉ instance ุณุงุฎุชู ูโุดู.

{{< play >}}
package main

import (
	"fmt"
	"sync"
)

type singleton struct {
	data string
}

var (
	instance *singleton
	once     sync.Once
)

func GetInstance() *singleton {
	once.Do(func() {
		instance = &singleton{data: "my singleton data"}
	})
	return instance
}

func main() {
	s1 := GetInstance()
	s2 := GetInstance()
	if s1 == s2 {
		fmt.Println("Same instance")
	} else {
		fmt.Println("Not same")
	}
}
{{< /play >}}

**ูุฒุช:** ูุงุฒ ุจู ููุดุชู ูููโูุง ุงุถุงูู ุง ูุชุบุฑ flag ูุณุชุ ฺูู `Once` ููู ฺุฒ ุฑู ูุฏุฑุช ูโฺฉูู.

### 3.3.4.5 ูฺฉุงุช ู ุชุฑููุฏูุง ุงุณุชูุงุฏู ุงุฒ Once

1. **ุญุชูุงู ุงุฒ ููุงู ูุชุบุฑ Once ุจุฑุง ุชูุงู ุฏุณุชุฑุณโูุง ุงุณุชูุงุฏู ฺฉูุฏ**  
    ุงฺฏุฑ ุฏุฑ ุฌุงูุง ูุฎุชูู ูุชุบุฑูุง Once ุฌุฏุงฺฏุงูู ุจุณุงุฒุฏุ ูุฑฺฉุฏูู ุชุงุจุน ุฑู ฺฉุจุงุฑ ุงุฌุฑุง ูโฺฉูู.
2. **ุชุงุจุน Do ูุจุงุฏ nil ุจุงุดู**  
    ุงฺฏุฑ nil ุจุฏุฏุ Panic ุงุชูุงู ูโุงูุชู.
3. **Once ุจุฑุง reset ฺฉุฑุฏู ูุณุช**  
    ููุช ุชุงุจุน ุจุง Once ุงุฌุฑุง ุดุฏุ ุฏฺฏู ููโุชููุฏ ุงูู ุฑู ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูุฏ. ุงฺฏุฑ ูุงุฒ ุจู reset ุฏุงุฑุฏุ ุจุงุฏ ุณุงุฎุชุงุฑ ุฌุฏุฏ ุจุณุงุฒุฏ.
4. **ุจููู ู ุณุจฺฉ**  
    `Once` ุจู ุตูุฑุช ุฏุงุฎู ููุท ุฏุฑ ุงููู ุงุฌุฑุง ููู ูโฺฏุฑู ู ุจุนุฏ ุงุฒ ุงูู ุจุฏูู ูุฒูู ูููุ ูุณุชููุงู ุงุฏุงูู ูโุฏู.

## 3.3.5 Pool

ุฏุฑ ูุณุฎู ฑ.ณ ุฒุจุงู ฺฏู ุงูฺฉุงู ุชุงูพ ุจู ูุงู Pool ุฏุฑ ูพฺฉุฌ sync ฺฉู ุงูฺฉุงู ุงุฌุงุฏ ุงุณุชุฎุฑ ุขุจุฌฺฉุช ูุง ุจุทูุฑ ูููุช ุจุฏูู ุงูฺฉู ุจุฎูุงูุฏ ุจุฎุด ุงุฒ ุญุงูุธู ุฑุง ุงุดุชุบุงู ฺฉูุฏ ุงุถุงูู ุดุฏ. ูุฑ ุขุจุฌฺฉุช ฺฉู ุฏุฑ Pool ุฐุฎุฑู ุดูุฏ ุจุทูุฑ ุฎูุฏฺฉุงุฑ ุฏุฑ ูุฑุฒูุงู ุจุฏูู ุงูฺฉู ุงุทูุงุน ุฑุณุงู ฺฉูุฏ ุญุฐู ู ุดูุฏ. ุงูฺฉุงู ุงุณุชูุงุฏู ูุฌุฏุฏ ุงุฒ ุขุจุฌฺฉุช ูุง ฺฉู ุฏุงุฎู ุงุณุชุฎุฑ ู ฺฏุฑูุฏ ูุฌูุฏ ุฏุงุฑุฏ ู ุงู ุจุงุนุซ ู ุดูุฏ ุณุฑุจุงุฑ ุงุณุชูุงุฏู ุญุงูุธู ฺฉุงูุด ุงุจุฏ.

{{<img url="#" image="../../assets/img/content/chapter3/sync/2.gif" alt="sync pool">}}

{{< play >}}
package main

import (
	"bytes"
	"io"
	"os"
	"sync"
	"time"
)

var bufPool = sync.Pool{
	New: func() any {
		// The Pool's New function should generally only return pointer
		// types, since a pointer can be put into the return interface
		// value without an allocation:
		return new(bytes.Buffer)
	},
}

// timeNow is a fake version of time.Now for tests.
func timeNow() time.Time {
	return time.Unix(1136214245, 0)
}

func Log(w io.Writer, key, val string) {
	b := bufPool.Get().(*bytes.Buffer)
	b.Reset()
	// Replace this with time.Now() in a real logger.
	b.WriteString(timeNow().UTC().Format(time.RFC3339))
	b.WriteByte(' ')
	b.WriteString(key)
	b.WriteByte('=')
	b.WriteString(val)
	w.Write(b.Bytes())
	bufPool.Put(b)
}

func main() {
	Log(os.Stdout, "path", "/search?q=flowers")
}
{{< /play >}}

ุฏุฑ ุจุงูุง ูุง ฺฉ ูุชุบุฑ ุจู ูุงู bufPool ุงุฌุงุฏ ฺฉุฑุฏู ฺฉู ฺฉ ุขุจุฌฺฉุช ุงุฒ ููุน bytes.Buffer ุงุฌุงุฏ ู ฺฉูุฏ. ุณูพุณ ุฏุงุฎู ุชุงุจุน Log ูุง ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏ Get ุขุจุฌฺฉุช ููุฑุฏ ูุธุฑ ุฑุง ุงุฒ Pool ุฎุงุฑุฌ ู ุฏุงุฎู ูุชุบุฑ b ูุฑุงุฑ ุฏุงุฏู ู ูพุณ ุงุฒ ุขู ุนููุงุช ูุงุฒู ุฑุง ุจุฑุฑู Buffer ุงูุฌุงู ู ุฏุฑ ููุงุช ุจุง ุงุณุชูุงุฏู ุงุฒ ูุชุฏ Put ุขุจุฌฺฉุช ุฑุง ุจู Pool ุงุถุงูู ฺฉุฑุฏู. ุญุงูุง ุงุชูุงู ฺฉู ุตูุฑุช ฺฏุฑูุชู ูุง ุนููุงุช ฺฉู ูุงุฒ ุฏุงุดุชู ุฑุง ุจุฑุฑู ุขุจุฌฺฉุช ุงูุฌุงู ุฏุงุฏู ุจุฏูู ุงูฺฉู ุจุฎูุงู ุจุฎุด ุงุฒ ุญุงูุธู ุฑุง ุฏุฑฺฏุฑ ฺฉูู.


### 3.3.5.1 ุจูฺูุงุฑฺฉ ุฏุฑ ุฎุตูุต Pool

{{< play >}}
package main

import (
   "sync"
   "testing")

type Person struct {
   Age int
}

var personPool = sync.Pool{
   New: func() interface{} { return new(Person) },
}

func BenchmarkWithoutPool(b *testing.B) {
   var p *Person
   b.ReportAllocs()
   b.ResetTimer()
   for i := 0; i < b.N; i++ {
      for j := 0; j < 10000; j++ {
         p = new(Person)
         p.Age = 23
      }
   }
}

func BenchmarkWithPool(b *testing.B) {
   var p *Person
   b.ReportAllocs()
   b.ResetTimer()
   for i := 0; i < b.N; i++ {
      for j := 0; j < 10000; j++ {
         p = personPool.Get().(*Person)
         p.Age = 23
         personPool.Put(p)
      }
   }
}
{{< /play >}}

### 3.3.5.2 ูุซุงู ูุง ฺฉุงุฑุจุฑุฏ

**ูุซุงู ุงูู :**

ูุฑุถ ฺฉูุฏ ุดูุง ู ุฎูุงูุฏ ฺฉ ูุงู csv ุฑุง ุจุง ฺฉู ุฑฺฉูุฑุฏ parse ฺฉูุฏ. ูุฑ ุฑฺฉูุฑุฏ ูุงุฒููุฏ ุงู ุงุณุช ฺฉู ุฏุงุฎู ฺฉ ุณุงุฎุชุงุฑ ูุฑุงุฑ ุจฺฏุฑุฏ ู ุงุฌุงุฏ ฺฉ ุณุงุฎุชุงุฑ ุจุงุนุซ ู ุดูุฏ ุจุฎุด ุงุฒ ุญุงูุธู ุงุฎุชุตุงุต ุงุจุฏ ุจู ุขู ุณุงุฎุชุงุฑ. ุญุงูุง ูฺฉุฑ ฺฉูุฏ ูููู ูุง ุฑฺฉูุฑุฏ ุฏุงุดุชู ุจุงุดุฏ ู ุงู ุชุฎุตุต ุญุงูุธู ู ุชูุงูุฏ ุจุงุนุซ ุชููู ุจุฑูุงูู ุดูุฏ.

ุญุงูุง ุจุฑุง ุงูฺฉู ุจุฎูุงูู ุฌูู ุงู ุงุชูุงู ุฑุง ุจฺฏุฑู ู ุณุฑุจุงุฑ ุฑุง ฺฉุงูุด ุฏูู ุจูุชุฑ ุงุณุช ูุง ุงุฒ sync.Pool ุงุณุชูุงุฏู ฺฉูู ู ุณุงุฎุชุงุฑูุง ุฑุง ุฏุงุฎู ุงุณุชุฎุฑ ูุฑุงุฑ ุฏูู. ู ุฒูุงูฺฉู ูุฑฺฉุฏุงู ุงุฒ ุณุงุฎุชุงุฑูุง ููุฑุฏ ูุงุฒ ูุจุงุดุฏ ู ุชูุงููุฏ ุฏุงุฎู ุงุณุชุฎุฑ ูุฑุงุฑ ฺฏุฑูุฏ ู ูุฌุฏุฏ ุงุณุชูุงุฏู ุดููุฏ. ุงูฺฉุงุฑ ุจุงุนุซ ู ุดูุฏ ุจุทูุฑ ุฎู ูุงุจู ุชูุฌู ุชุนุฏุงุฏ ุชุฎุตุต ุญุงูุธู ฺฉุงูุด ุงุจุฏ ู ุนููฺฉุฑุฏ ุจุฑูุงูู ฺูุฏ ุจุฑุงุจุฑ ุดูุฏ.

**ูุซุงู ุฏูู :**

ููุงุฑุฏ ุงุณุชูุงุฏู ุฏฺฏุฑ ุงุฒ sync.Pool ุจุฑุง ุฐุฎุฑู ฺฉุฑุฏู ุขุจุฌฺฉุช ูุง ูพุฑฺฉุงุฑุจุฑุฏ ูุธุฑ ฺฉุงูฺฉุดู ุฏุชุงุจุณ ุง ุดุจฺฉู ู ููฺูู ุขุจุฌฺฉุช ูุง ฺฉู ูุตุฏ ุฏุงุฑู ุจุฑุฑู ุขู ุนููุงุช serialize ู deserialize ุงูุฌุงู ุฏูู.

## 3.3.6 Cond


**ูพฺฉุฌ `sync.Cond`** ฺฉ ุงุฒ ุงุจุฒุงุฑูุง ูพุดุฑูุชู ููุฒูุงู ุฏุฑ ุฒุจุงู Go ุงุณุช ฺฉู ุงูฺฉุงู ูพุงุฏูโุณุงุฒ ุงูฺฏู "[ูุงูุชูุฑ](../../chapter-9/concurrency-patterns/go-concurrency-pattern-monitor)" ุง ููุงู **ุดุฑุท ุงูุชุธุงุฑ (Condition Variable)** ุฑุง ูุฑุงูู ูโฺฉูุฏ. Cond ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุชุง ูุฌููุนูโุง ุงุฒ goroutineูุง ุฑุง ุชุง ุฒูุงู ฺฉู ฺฉ ุดุฑุท ุง ุฑูุฏุงุฏ ุฎุงุต ุจุฑูุฑุงุฑ ูุดุฏูุ ุจู ุตูุฑุช ุงูู ู ฺฉุงุฑุขูุฏ (ุจุฏูู busy-waiting ุง ูุตุฑู ุจโููุฑุฏ CPU) ููุชุธุฑ ูฺฏู ุฏุงุฑุฏ. ุฒูุงู ฺฉู ุดุฑุท ููุฑุฏ ูุธุฑ ุจุฑูุฑุงุฑ ุดุฏุ ูโุชูุงูุฏ ฺฉ ุง ููู goroutineูุง ููุชุธุฑ ุฑุง ุจุฏุงุฑ ฺฉูุฏ ุชุง ฺฉุงุฑุดุงู ุฑุง ุงุฏุงูู ุฏููุฏ. ุงู ุชฺฉูฺฉุ ุฏุฑ ุจุณุงุฑ ุงุฒ ุงูฺฏููุง ูุนุฑูู concurrency ูุงููุฏ producer-consumerุ ุตู ุงูุชุธุงุฑุ ุตู ูพุงู ู ฺฉูุชุฑู ููุงุจุน ูุญุฏูุฏ ฺฉุงุฑุจุฑุฏ ุงุณุงุณ ุฏุงุฑุฏ.

#### **ูุญูู ฺฉุงุฑ Cond ู ููุด ููู (Mutex / RWMutex)**

ุจุฑุง ุณุงุฎุช ฺฉ ุดุก Cond ุจุงุฏ ฺฉ ููู (ูุนูููุงู ุงุฒ ููุน `*sync.Mutex` ุง `*sync.RWMutex`) ุจู ุขู ุจุฏูุฏ. ุงู ููู ุจู Cond ุงุฌุงุฒู ูโุฏูุฏ ุชุง ูุถุนุช ูุดุชุฑฺฉ (shared state) ุฑุง ุฏุฑ ูุงู ฺูุฏ goroutine ุจู ุทูุฑ thread-safe ุจุฑุฑุณ ู ฺฉูุชุฑู ฺฉูุฏ. ูููุ ุชุถูู ูโฺฉูุฏ ฺฉู ูฺ ุฏู goroutineุง ููุฒูุงู ูุชูุงููุฏ ูุถุนุช ุฑุง ุชุบุฑ ุฏููุฏ ุง ุจู ูุชุฏูุง Cond ุฏุณุชุฑุณ ูพุฏุง ฺฉููุฏุ ฺฉู ุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ race condition ฺฉุงููุงู ุญุงุช ุงุณุช.

```go
lock := &sync.Mutex{}
cond := sync.NewCond(lock)
```

#### **ุนููฺฉุฑุฏ ูุชุฏูุง**

- **Wait():**
    ููุช ฺฉ goroutine ูุชุฏ Wait ุฑุง ุตุฏุง ูโุฒูุฏุ ุฏู ุงุชูุงู ูพุดุชโุณุฑูู ุฑุฎ ูโุฏูุฏ:
    1. ููู ุฏุงุฏูโุดุฏู (ูุซูุงู Mutex) ุจู ุทูุฑ ูููุช ุขุฒุงุฏ ูโุดูุฏ ุชุง ุณุงุฑ goroutineูุง ุจุชูุงููุฏ ูุถุนุช ูุดุชุฑฺฉ ุฑุง ุชุบุฑ ุฏููุฏ.
    2. goroutine ุชุง ุฒูุงู ุฏุฑุงูุช ุณฺฏูุงู (`Signal` ุง `Broadcast`) ุจู ุญุงูุช ุชุนูู (sleep) ูโุฑูุฏ ู ูฺ ูพุฑุฏุงุฒุด ุงูุฌุงู ููโุฏูุฏ (ฺฉุงููุงู ุบุฑูุณุฏูุฏฺฉููุฏู).
        ูพุณ ุงุฒ ุฏุฑุงูุช ุณฺฏูุงู ู ุจุฏุงุฑ ุดุฏูุ Wait ุฏูุจุงุฑู ุจู ุตูุฑุช ุงุชูฺฉ ููู ุฑุง ุฏุฑ ุงุฎุชุงุฑ ูโฺฏุฑุฏ ู ุงุฌุฑุง ุงุฒ ููุงู ุฎุท ุงุฏุงูู ูพุฏุง ูโฺฉูุฏ.
        ูุนูููุงู ูุจู ุงุฒ Wait ุจุงุฏ ุดุฑุท ุฑุง ุฏุงุฎู ฺฉ ุญููู (for) ุจุฑุฑุณ ฺฉูุฏ ุชุง ุงุฒ **spurious wakeup** ู ุฑูุงุจุช ุฏุงุฏูโุง ุฌููฺฏุฑ ุดูุฏ:

    ```go
    cond.L.Lock()
    for !ุดุฑุท_ุจุฑูุฑุงุฑ_ุงุณุช {
        cond.Wait()
    }
    // ุงุฏุงูู ููุทู ...
    cond.L.Unlock()
    ```

- **Signal():**
    ุงู ูุชุฏ ุชููุง **ฺฉ ุงุฒ goroutineูุง ููุชุธุฑ** ุฑุง ุจุฏุงุฑ ูโฺฉูุฏ (ุงฺฏุฑ ฺฉุณ ุฏุฑ ุตู ุงูุชุธุงุฑ ุจุงุดุฏ). ุงูุชุฎุงุจ ุงูฺฉู ฺฉุฏุงู goroutine ุจุฏุงุฑ ุดูุฏ ุจู ุณุงุณุช ุฒูุงูโุจูุฏ runtime ูุงุจุณุชู ุงุณุช ู ุชุถูู ุจุฑุง ุชุฑุชุจ ุฎุงุต ูุฌูุฏ ูุฏุงุฑุฏ. Signal ูุนูููุงู ุฒูุงู ุจู ฺฉุงุฑ ูโุฑูุฏ ฺฉู ุงูุชุธุงุฑ ุฏุงุฑุฏ ููุท ฺฉ ูุตุฑูโฺฉููุฏู ุจุง ุฏุงุฏู ุฌุฏุฏ ุง ุชุบุฑ ูุถุนุช ุจุฏุงุฑ ุดูุฏ.

- **Broadcast():**
    ุงู ูุชุฏ **ููู goroutineูุง ููุชุธุฑ ุฑู ุขู Cond** ุฑุง ุจุฏุงุฑ ูโฺฉูุฏ ุชุง ุดุฑุท ุฑุง ุฏูุจุงุฑู ุจุฑุฑุณ ฺฉููุฏ. Broadcast ุฒูุงู ฺฉุงุฑุจุฑุฏ ุฏุงุฑุฏ ฺฉู ฺฉ ุฑูุฏุงุฏ ูโุชูุงูุฏ ุจุฑุง ูููโ ููุชุธุฑูุง ููู ุจุงุดุฏ (ูุซูุงู ุงุชูุงู ฺฉุงุฑ ุง ุขุฒุงุฏ ุดุฏู ููุจุน ุจุฑุง ููู ูุตุฑูโฺฉููุฏูโูุง).

ุจู ูุซุงู ุฒุฑ ุชูุฌู ฺฉูุฏ :

{{< play >}}
package main

import (
	"fmt"
	"sync"
)

var sharedResource = make(map[string]interface{})

func main() {
	var wg sync.WaitGroup
	wg.Add(2)
	locker := sync.Mutex{}
	condition := sync.NewCond(&locker)

	go waitForResourceUpdate(&wg, condition, "rsc1")
	go waitForResourceUpdate(&wg, condition, "rsc2")

	// this one writes changes to sharedResource
	condition.L.Lock()
	sharedResource["rsc1"] = "a string"
	sharedResource["rsc2"] = 123456
	condition.Broadcast()
	condition.L.Unlock()

	wg.Wait()
}

// waitForResourceUpdate waits for a signal that a resource changed and prints it.
func waitForResourceUpdate(wg *sync.WaitGroup, cond *sync.Cond, key string) {
	defer wg.Done()
	cond.L.Lock()
	for len(sharedResource) == 0 {
		cond.Wait()
	}
	fmt.Println("Resource", key, ":", sharedResource[key])
	cond.L.Unlock()
}
{{< /play >}}
