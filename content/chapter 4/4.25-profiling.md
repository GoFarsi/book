---
title: 4.25 ุขููุฒุด profiling
slug: profiling
weight: 7024
---

ูพุฑููุงููฺฏ ฺฉ ุชฺฉูฺฉ ููุฏ ุจุฑุง ุดูุงุณุง  {{< tooltip text="ฺฏููฺฏุงูโูุง" note="bottlenecks" >}}  {{< tooltip text="ุนููฺฉุฑุฏ" note="performance" >}}ุ ุจุฑุฑุณ ูุตุฑู ุญุงูุธู ู ุจู ุฏุณุช ุขูุฑุฏู ุจูุด ุฏุฑุจุงุฑู ุณุฑุจุงุฑ ุฌูุนโุขูุฑ ุฒุจุงูู (Garbage Collection) ู ููุงุฑุฏ ุฏฺฏุฑ ุงุณุช. ุงฺฉูุณุณุชู Go ุงุจุฒุงุฑูุง ูููโุงูุนุงุฏูโุง ุจุฑุง ุงู ููุธูุฑ ุงุฑุงุฆู ูโุฏูุฏ. ุงูฺฉุงู ูุนุงู ู ุบุฑูุนุงู ฺฉุฑุฏู ูพุฑููุงููฺฏ ุจู ูฺู ููฺฏุงู ุฑูุน ุงุดฺฉุงู ุฏุฑ ฺฉ ุจุฑูุงูู CLI ููุดุชู ุดุฏู ุจุง Go ุจุณุงุฑ ููุฏ ุงุณุช.

{{< hint info >}}
**ููู ู ููู ููุณูุฏู:**

ุดุงุฏ profiling ุจุฑุง ุญุงู ุญุงุถุฑ ูุงุจู ุงููุช ูุจุงุดุฏ ุงูุง ุฑูุฒ ุฎูุงูุฏ ุฑุณุฏ ฺฉู ุฏุฑ ุจุฎุด ูุง ุงุฒ ูพุฑูฺู ุฏฺุงุฑ ูุตุฑู ุจุด ุงุฒ ุญุฏ memory, CPU ุฎูุงูุฏ ุดุฏ ู ุงูุฌุงุณ ฺฉู profiling ุจู ุดูุง ฺฉูฺฉ ุฎูุงูุฏ ฺฉุฑุฏ ุณุฑุฒ ููุงุจุน ุฑุง ูพุฏุง ฺฉูุฏ.

ุณุน ฺฉูุฏ ุงู ูุทูุจ ุฑุง ุงุฏ ุจฺฏุฑุฏ ูุทุนุง ฺฉ ุฑูุฒ ุจุง ุงู ููุถูุน ููุงุฌู ุฎูุงูุฏ ุดุฏ.
{{< /hint >}}

**ฺู ุฒูุงู ูพุฑููุงู ฺฉููุ**

ููุงุฑุฏ ุงุณุชูุงุฏู ุฑุงุฌ ูพุฑููุงููฺฏ ุนุจุงุฑุชูุฏ ุงุฒ:

- ฺฉุดู  {{< tooltip text="ฺฏููฺฏุงูโูุง" note="bottlenecks" >}} ุนููฺฉุฑุฏ ู ุฑูุน ุขูโูุง ุจุฑุง ุจูุจูุฏ ุนููฺฉุฑุฏ ฺฉู
- ุงูุชู   {{< tooltip text="ุชุฎุตุตโูุง" note="allocations" >}} ุงุถุงู ุญุงูุธู ู ฺฉุงูุด ุขูโูุง ุจู ููุธูุฑ ฺฉุงูุด ุชุงุซุฑ ููู Garbage Collection ุจุฑ ุนููฺฉุฑุฏ.
- ุณุฑุฑุฒ ุง ูุดุช ุญุงูุธู ุง CPU ุฏุฑ ุจููุฏ ูุฏุช (ูุดุช ููุงุจุน ููุช ูุดุฎุต ู ุดูุฏ ฺฉู ุณุฑูุณ ุดูุง ุจุฑุง ูุฏุช ุทููุงู ฺูุฏ ุฑูุฒ ุฏุฑ ุญุงู ุงุฌุฑุง ุจุงุดุฏ.)

## 4.25.1 ูุฏู ุฐูู (mental) ุจุฑุง Go 

ููฺฉู ุงุณุช ุจุชูุงูุฏ ุฏุฑ ููุดุชู ฺฉุฏ Go ุจู ููุงุฑุช ุจุงูุง ุจุฑุณุฏ ุจุฏูู ุงูฺฉู ุฏุฑฺฉ ุฏูู ุงุฒ ูุญูู ุนููฺฉุฑุฏ ุงู ุฒุจุงู ุฏุฑ ูพุดุช ุตุญูู ุฏุงุดุชู ุจุงุดุฏ. ุงูุง ููุช ุจู ุนููฺฉุฑุฏ ู ุงุดฺฉุงูโุฒุฏุง ูโุฑุณูุ ุฏุงุดุชู ฺฉ ูุฏู ุฐูู ุงุฒ ุฌุฒุฆุงุช ุฏุงุฎู ุฒุจุงู ุจู ุดุฏุช ุจู ููุน ุดูุง ุฎูุงูุฏ ุจูุฏ. ุจูุงุจุฑุงูุ ุงุจุชุฏุง ฺฉ ูุฏู ุงุจุชุฏุง ุงุฒ Go ุฑุง ุดุฑุญ ูโุฏูู. ุงู ูุฏู ุจู ุงูุฏุงุฒู ฺฉุงู ุฎูุจ ุงุณุช ฺฉู ุจู ุดูุง ฺฉูฺฉ ฺฉูุฏ ุงุฒ ุงุดุชุจุงูุงุช ุฑุงุฌ ุงุฌุชูุงุจ ฺฉูุฏุ ุงูุง ุชูุงู ูุฏูโูุง ูุญุฏูุฏุช ุฏุงุฑูุฏุ ุจูุงุจุฑุงู ุชูุตู ูโุดูุฏ ฺฉู ุจุฑุง ุญู ูุดฺฉูุงุช ูพฺุฏูโุชุฑ ุฏุฑ ุขูุฏูุ ุจู ููุงุจุน ุชุฎุตุตโุชุฑ ูุฑุงุฌุนู ฺฉูุฏ.

ูุธูู ุงุตู Goุ ูุดุงุจู ฺฉ ุณุณุชูโุนุงููุ ุงู ุงุณุช ฺฉู ููุงุจุน ุณุฎุชโุงูุฒุงุฑ ุฑุง ฺูุฏูุธููโุง ู ุงูุชุฒุงุน ฺฉูุฏ. ุงู ฺฉุงุฑ ุนูุฏุชุงู ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏู ุงูุชุฒุงุน ุงุตู ุงูุฌุงู ูโุดูุฏ:

1.   {{< tooltip text="ุฒูุงูโุจูุฏ" note="Scheduler" >}} Goroutine: ูุฏุฑุช ูุญูู ุงุฌุฑุง ฺฉุฏ ุดูุง ุจุฑ ุฑู ูพุฑุฏุงุฒูุฏูโูุง ุณุณุชู.
2. ุฌูุนโุขูุฑ ุฒุจุงูู (Garbage Collector): ุญุงูุธู ูุฌุงุฒ ุฑุง ูุฑุงูู ูโฺฉูุฏ ฺฉู ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุฏุฑ ุตูุฑุช ูุงุฒ ุขุฒุงุฏ ูโุดูุฏ.


### 4.25.1.1 ุฒูุงูโุจูุฏ (scheduler) ฺฏูุฑูุชู 
 
ุงุจุชุฏุง ุจุง ุงุณุชูุงุฏู ุงุฒ ูุซุงู ุฒุฑ ุฏุฑ ููุฑุฏ ุฒูุงูโุจูุฏ ุตุญุจุช ฺฉูู:

```go
func main() {
    res, err := http.Get("https://example.org/")
    if err != nil {
        panic(err)
    }
    fmt.Printf("%d\n", res.StatusCode)
}
```

ุฏุฑ ุงูุฌุง ฺฉ goroutine ูุงุญุฏ ุฏุงุฑู ฺฉู ุขู ุฑุง G1 ูโูุงูู ู ุงู goroutine ุชุงุจุน main ุฑุง ุงุฌุฑุง ูโฺฉูุฏ. ุชุตูุฑ ุฒุฑ ฺฉ ุฎุท ุฒูุงู ุณุงุฏูโุดุฏู ุงุฒ ูุญูู ุงุฌุฑุง ุงู goroutine ุฑู ฺฉ ูพุฑุฏุงุฒูุฏู ุฑุง ูุดุงู ูโุฏูุฏ. ุงุจุชุฏุง G1 ุจุฑ ุฑู ูพุฑุฏุงุฒูุฏู ุงุฌุฑุง ูโุดูุฏ ุชุง ุฏุฑุฎูุงุณุช HTTP ุฑุง ุขูุงุฏู ฺฉูุฏ. ุณูพุณ ูพุฑุฏุงุฒูุฏู ุจฺฉุงุฑ ูโุดูุฏ ุฒุฑุง goroutine ุจุงุฏ ููุชุธุฑ ุดุจฺฉู ุจูุงูุฏ. ุฏุฑ ููุงุชุ goroutine ุฏูุจุงุฑู ุฑู ูพุฑุฏุงุฒูุฏู ุฒูุงูโุจูุฏ ูโุดูุฏ ุชุง ฺฉุฏ ูุถุนุช ุฑุง ฺุงูพ ฺฉูุฏ.

{{<img url="#" image="../../assets/img/content/chapter4/profiling/1.png" alt="go scheduler">}}

ุงุฒ ุฏุฏฺฏุงู ุฒูุงูโุจูุฏุ ุจุฑูุงูู ุจุงูุง ุจู ุงู ุตูุฑุช ุงุฌุฑุง ูโุดูุฏ. ุงุจุชุฏุง G1 ุฏุฑ ุญุงู ุงุฌุฑุง ุฑู ูพุฑุฏุงุฒูุฏู 1 ุงุณุช. ุณูพุณ goroutine ุงุฒ ูพุฑุฏุงุฒูุฏู ุฎุงุฑุฌ ูโุดูุฏ ู ุฏุฑ ุญุงู ุงูุชุธุงุฑ ุจุฑุง ุดุจฺฉู ูุฑุงุฑ ูโฺฏุฑุฏ. ุฒูุงู ฺฉู ุฒูุงูโุจูุฏ ูุชูุฌู ูโุดูุฏ ุดุจฺฉู ูพุงุณุฎ ุฏุงุฏู ุงุณุช (ุจุง ุงุณุชูุงุฏู ุงุฒ ูุฑูุฏ/ุฎุฑูุฌ ุบุฑูุณุฏูุฏฺฉููุฏูุ ูุดุงุจู Node.js) ฺฏูุฑูุชู ุฑุง ุจู ุนููุงู " {{< tooltip text="ุขูุงุฏู ุงุฌุฑุง" note="Runnable" >}}" ุนูุงูุชโฺฏุฐุงุฑ ูโฺฉูุฏ. ู ุจู ูุญุถ ุงูฺฉู ฺฉ ูุณุชู ูพุฑุฏุงุฒูุฏู ุขุฒุงุฏ ุดูุฏุ goroutine ุฏูุจุงุฑู ุดุฑูุน ุจู ุงุฌุฑุง ูโฺฉูุฏ. ุฏุฑ ูุซุงู ูุง ุชูุงู ูุณุชูโูุง ุฏุฑ ุฏุณุชุฑุณ ูุณุชูุฏุ ุจูุงุจุฑุงู G1 ุจูุงูุงุตูู ุจุฏูู ุตุฑู ุฒูุงู ุฏุฑ ุญุงูุช "ุขูุงุฏู ุงุฌุฑุง" ูโุชูุงูุฏ ุจู ุงุฌุฑุง ุชุงุจุน `fmt.Printf()` ุจุฑ ุฑู ฺฉ ุงุฒ ูพุฑุฏุงุฒูุฏูโูุง ุจุฑฺฏุฑุฏุฏ.

{{<img url="#" image="../../assets/img/content/chapter4/profiling/2.gif" alt="scheduler">}}

ุฏุฑ ุงฺฉุซุฑ ููุงูุนุ ุจุฑูุงููโูุง Go ฺูุฏู goroutine ุฑุง ุจู ุทูุฑ ููุฒูุงู ุงุฌุฑุง ูโฺฉููุฏุ ุจูุงุจุฑุงู ุชุนุฏุงุฏ ุงุฒ goroutineูุง ุฏุฑ ุญุงู ุงุฌุฑุง ุฑู ุจุฑุฎ ุงุฒ ูุณุชูโูุง ูพุฑุฏุงุฒูุฏู ูุณุชูุฏุ ุชุนุฏุงุฏ ุฒุงุฏ ุงุฒ goroutineูุง ุจู ุฏูุงู ูุฎุชูู ุฏุฑ ุญุงูุช "ุงูุชุธุงุฑ" ูุฑุงุฑ ุฏุงุฑูุฏุ ู ุงุฏูโุขู ุงู ุงุณุช ฺฉู ูฺ goroutine ุฏุฑ ุญุงูุช "ุขูุงุฏู ุงุฌุฑุง" ูุจุงุดุฏุ ูฺฏุฑ ุงูฺฉู ุจุฑูุงูู ุดูุง ุจุงุฑ ูพุฑุฏุงุฒุด ุจุณุงุฑ ุจุงูุง ุจุฑ ุฑู ูพุฑุฏุงุฒูุฏู ุงุฌุงุฏ ฺฉูุฏ. ฺฉ ูุซุงู ุงุฒ ุงู ุญุงูุช ุฑุง ูโุชูุงู ุฏุฑ ุฒุฑ ูุดุงูุฏู ฺฉุฑุฏ.


{{<img url="#" image="../../assets/img/content/chapter4/profiling/3.png" alt="scheduler complete">}}

ุงูุจุชู ูุฏู ุจุงูุง ุจุณุงุฑ ุงุฒ ุฌุฒุฆุงุช ุฑุง ูุงุฏุฏู ูโฺฏุฑุฏ. ุฏุฑ ูุงูุนุชุ ุฒูุงูโุจูุฏ Go ุจุฑ ุฑู ูุฎโูุง (threads) ฺฉู ุชูุณุท ุณุณุชูโุนุงูู ูุฏุฑุช ูโุดููุฏุ ฺฉุงุฑ ูโฺฉูุฏ ู ุญุช ุฎูุฏ ูพุฑุฏุงุฒูุฏูโูุง ูุฒ ูุงุฏุฑ ุจู ุงุณุชูุงุฏู ุงุฒ ูุงูพุฑุชุฑุฏูฺฏ (hyper-threading) ูุณุชูุฏ ฺฉู ูโุชูุงู ุขู ุฑุง ููุน ุฒูุงูโุจูุฏ ุฏุฑ ูุธุฑ ฺฏุฑูุช. 

ุจุง ุงู ุญุงูุ ูุฏู ููู ุจุงุฏ ุจุฑุง ุฏุฑฺฉ ุจุฎุดโูุง ุจุงูโูุงูุฏู ุงุฒ ุงู ุฑุงูููุง ฺฉุงู ุจุงุดุฏ. ุจู ุทูุฑ ุฎุงุตุ ุจุงุฏ ุฑูุดู ุดูุฏ ฺฉู ุฒูุงู ุงูุฏุงุฒูโฺฏุฑโุดุฏู ุชูุณุท ูพุฑููุงูุฑูุง ูุฎุชูู Go ุฏุฑ ุงุตู ุฒูุงู ุงุณุช ฺฉู goroutineูุง ุดูุง ุฏุฑ ุญุงูุช "ุงุฌุฑุง" (Executing) ู "ุงูุชุธุงุฑ" (Waiting) ุตุฑู ูโฺฉููุฏุ ููุงูโุทูุฑ ฺฉู ุฏุฑ ูููุฏุงุฑ ุฒุฑ ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช.

{{<img url="#" image="../../assets/img/content/chapter4/profiling/4.png" alt="profile venn">}}

### 4.25.1.2 ุฒุจุงูู ุฌูุน ฺฉู (Garbage Collector)

ุฏฺฏุฑ ุงูุชุฒุงุน ููู ุฏุฑ Goุ ุฌูุนโุขูุฑ ุฒุจุงูู (Garbage Collector) ุงุณุช. ุฏุฑ ุฒุจุงูโูุง ูุงููุฏ Cุ ุจุฑูุงููโููุณ ุจุงุฏ ุจู ุตูุฑุช ุฏุณุช ุชุฎุตุต ู ุขุฒุงุฏุณุงุฒ ุญุงูุธู ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ `malloc()` ู `free()` ูุฏุฑุช ฺฉูุฏ. ุงู ุฑูฺฉุฑุฏ ฺฉูุชุฑู ุฎูุจ ุงุฑุงุฆู ูโุฏูุฏุ ุงูุง ุฏุฑ ุนูู ุจุณุงุฑ ูุณุชุนุฏ ุฎุทุง ุงุณุช. ฺฉ ุฌูุนโุขูุฑโฺฉููุฏู ุฒุจุงูู (GC) ูโุชูุงูุฏ ุงู ุจุงุฑ ุฑุง ฺฉุงูุด ุฏูุฏุ ุงูุง ูุฏุฑุช ุฎูุฏฺฉุงุฑ ุญุงูุธู ููฺฉู ุงุณุช ุจู ุฑุงุญุช ุจู ฺฉ ฺฏููฺฏุงู ุนููฺฉุฑุฏ ุชุจุฏู ุดูุฏ. ุงู ุจุฎุด ุงุฒ ุฑุงูููุง ฺฉ ูุฏู ุณุงุฏู ุจุฑุง GC ุฏุฑ Go ุงุฑุงุฆู ูโุฏูุฏ ฺฉู ุจุฑุง ุดูุงุณุง ู ุจูููโุณุงุฒ ูุดฺฉูุงุช ูุฑุจูุท ุจู ูุฏุฑุช ุญุงูุธู ููุฏ ุฎูุงูุฏ ุจูุฏ.

ุจุฑุง ฺฉ ุฑุงูููุง ุฌุงูุนโุชุฑ ุฏุฑุจุงุฑู GC ุฏุฑ Goุ ุจู [ูุณุชูุฏุงุช ุฑุณู](https://go.dev/doc/gc-guide) ูุฑุงุฌุนู ฺฉูุฏ.

####  4.25.1.2.1 ูพุดุชู (Stack)  

ุจุง ุงุตูู ุงููู ุดุฑูุน ฺฉูู. Go ูโุชูุงูุฏ ุญุงูุธู ุฑุง ุฏุฑ ฺฉ ุงุฒ ุฏู ูฺฉุงู ุชุฎุตุต ุฏูุฏ: ูพุดุชู ุง ููพ. ูุฑ goroutine ูพุดุชู ุฎุงุต ุฎูุฏ ุฑุง ุฏุงุฑุฏ ฺฉู ฺฉ ูุงุญู ูพูุณุชู ุงุฒ ุญุงูุธู ุงุณุช. ุนูุงูู ุจุฑ ุงูุ ฺฉ ูุงุญู ุจุฒุฑฺฏ ุงุฒ ุญุงูุธู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุจู goroutineูุง ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชู ูโุดูุฏ ู ุจู ุขู  {{< tooltip text="ููพ" note="ุงheap" >}} ูโฺฏููุฏ. ุงู ุญุงูุช ุฑุง ูโุชูุงู ุฏุฑ ุชุตูุฑ ุฒุฑ ูุดุงูุฏู ฺฉุฑุฏ.

{{<img url="#" image="../../assets/img/content/chapter4/profiling/5.png" alt="sample heap">}}

ููุช ฺฉ ุชุงุจุน ุชุงุจุน ุฏฺฏุฑ ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏุ ฺฉ ุจุฎุด ูุฎุตูุต ุฑู ูพุดุชู ุจู ุขู ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ ฺฉู ุจู ุขู ยซูุฑู ูพุดุชูยป (stack frame) ูโฺฏููุฏ ู ูโุชูุงูุฏ ุจุฑุง ูุฑุงุฑ ุฏุงุฏู ูุชุบุฑูุง ูุญู ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉูุฏ. ฺฉ ุงุดุงุฑูโฺฏุฑ ูพุดุชู (stack pointer) ุจุฑุง ุดูุงุณุง ูุญู ุขุฒุงุฏ ุจุนุฏ ุฏุฑ ูุฑู ุงุณุชูุงุฏู ูโุดูุฏ. ุฒูุงู ฺฉู ฺฉ ุชุงุจุน ุจู ูพุงุงู ูโุฑุณุฏุ ุฏุงุฏูโูุง ูุฑู ูุจู ุจู ุณุงุฏฺฏ ุจุง ุจุงุฒฺฏุฑุฏุงูุฏู ุงุดุงุฑูโฺฏุฑ ูพุดุชู ุจู ุงูุชูุง ูุฑู ูุจู ุญุฐู ูโุดููุฏ. ุฏุงุฏูโูุง ูุฑู ููฺูุงู ูโุชูุงููุฏ ุฏุฑ ูพุดุชู ุจุงู ุจูุงููุฏ ู ุจุง ูุฑุงุฎูุงู ุจุนุฏ ุชุงุจุน ุจุงุฒููุณ ุดููุฏ. ุงู ูุฑุขูุฏ ุจุณุงุฑ ุณุงุฏู ู ฺฉุงุฑุขูุฏ ุงุณุช ุฒุฑุง Go ูุงุฒ ุจู ูพฺฏุฑ ูุฑ ูุชุบุฑ ูุฏุงุฑุฏ.

```go
func main() {
	sum := 0
	sum = add(23, 42)
	fmt.Println(sum)
}

func add(a, b int) int {
	return a + b
}
```

**ุจุฑุง ุฏุฑฺฉ ุจูุชุฑ ุงู ููุถูุนุ ุจู ูุซุงู ุฒุฑ ุชูุฌู ฺฉูุฏ:**

ุฏุฑ ุงูุฌุง ฺฉ ุชุงุจุน `main()` ุฏุงุฑู ฺฉู ุจุง ุฑุฒุฑู ููุฏุงุฑ ูุถุง ุฑู ูพุดุชู ุจุฑุง ูุชุบุฑ `sum` ุดุฑูุน ูโุดูุฏ. ููุช ุชุงุจุน `add()` ูุฑุงุฎูุงู ูโุดูุฏุ ฺฉ ูุฑู ูุฎุตูุต ุจุฑุง ูฺฏู ุฏุงุดุชู ูพุงุฑุงูุชุฑูุง ูุญู `a` ู `b` ุจู ุขู ุงุฎุชุตุงุต ุฏุงุฏู ูโุดูุฏ. ูพุณ ุงุฒ ุงุชูุงู ุงุฌุฑุง `add()`ุ ุฏุงุฏูโูุง ุขู ุจุง ุจุงุฒฺฏุฑุฏุงูุฏู ุงุดุงุฑูโฺฏุฑ ูพุดุชู ุจู ุงูุชูุง ูุฑู ุชุงุจุน `main()` ุญุฐู ูโุดููุฏ ู ูุชุบุฑ `sum` ุจุง ูุชุฌู ุจูโุฑูุฒ ูโุดูุฏ. ุฏุฑ ููู ุญุงูุ ููุงุฏุฑ ูุฏู ุชุงุจุน `add()` ูุฑุงุชุฑ ุงุฒ ุงุดุงุฑูโฺฏุฑ ูพุดุชู ุจุงู ูโูุงููุฏ ุชุง ุจุง ูุฑุงุฎูุงู ุจุนุฏ ุชุงุจุน ุจุงุฒููุณ ุดููุฏ. ุฏุฑ ุฒุฑ ฺฉ ุชุตูุฑุณุงุฒ ุงุฒ ุงู ูุฑุขูุฏ ุขูุฏู ุงุณุช:

{{<img url="#" image="../../assets/img/content/chapter4/profiling/6.gif" alt="stack">}}

ูุซุงู ุจุงูุง ุจู ุดุฏุช ุณุงุฏู ุดุฏู ุงุณุช ู ุจุณุงุฑ ุงุฒ ุฌุฒุฆุงุช ูุงููุฏ ููุงุฏุฑ ุจุงุฒฺฏุดุชุ ุงุดุงุฑูโฺฏุฑูุง ูุฑูุ ุขุฏุฑุณโูุง ุจุงุฒฺฏุดุช ู ุฏุฑููโุฎุทโุณุงุฒ (inlining) ุชูุงุจุน ุฑุง ุญุฐู ฺฉุฑุฏู ุงุณุช. ุฏุฑ ูุงูุนุ ุงุฒ ูุณุฎู Go 1.17 ุจู ุจุนุฏุ ููฺฉู ุงุณุช ุจุฑูุงูู ุจุงูุง ูุงุฒ ุจู ูุถุง ูพุดุชู ูุฏุงุดุชู ุจุงุดุฏุ ุฒุฑุง ููุฏุงุฑ ฺฉู ุฏุงุฏู ูโุชูุงูุฏ ุชูุณุท ฺฉุงููพุงูุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ ุซุจุงุชโูุง ูพุฑุฏุงุฒูุฏู (CPU registers) ูุฏุฑุช ุดูุฏ. ุงูุง ุงู ูุณุฆูู ูุดฺฉู ุงุฌุงุฏ ููโฺฉูุฏ. ุงู ูุฏู ููฺูุงู ุจู ุดูุง ฺฉ ุดููุฏ ูุนููู ุงุฒ ูุญูู ุชุฎุตุต ู ุญุฐู ูุชุบุฑูุง ูุญู ุฏุฑ ุจุฑูุงููโูุง ูพฺุฏูโุชุฑ Go ุฑู ูพุดุชู ูโุฏูุฏ.

ุดุงุฏ ุฏุฑ ุงู ูุฑุญูู ุงู ุณูุงู ุจุฑุง ุดูุง ูพุด ุจุงุฏ ฺฉู ฺู ุงุชูุงู ูโุงูุชุฏ ุงฺฏุฑ ูุถุง ูพุดุชู ุชูุงู ุดูุฏ. ุฏุฑ ุฒุจุงูโูุง ูุงููุฏ Cุ ุงู ููุถูุน ุจุงุนุซ ุฎุทุง ุณุฑุฑุฒ ูพุดุชู (stack overflow) ูโุดูุฏ. ุงูุง ุฏุฑ Goุ ุงู ูุดฺฉู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุจุง ุงุฌุงุฏ ฺฉ ูุณุฎู ฺฉูพ ุงุฒ ูพุดุชู ฺฉู ุฏู ุจุฑุงุจุฑ ุจุฒุฑฺฏุชุฑ ุงุณุชุ ูุฏุฑุช ูโุดูุฏ. ุงู ูุงุจูุช ุจู goroutineูุง ุงุฌุงุฒู ูโุฏูุฏ ฺฉู ุจุง ูพุดุชูโูุง ุจุณุงุฑ ฺฉูฺฺฉุ ูุนูููุงู 2 ฺฉููุจุงุชุ ุดุฑูุน ฺฉููุฏ ู ฺฉ ุงุฒ ุนูุงูู ุงุตู ููุงุณโูพุฐุฑ ุจุดุชุฑ goroutineูุง ูุณุจุช ุจู ูุฎโูุง ุณุณุชูโุนุงูู ููู ููุถูุน ุงุณุช.

ฺฉ ุฏฺฏุฑ ุงุฒ ุฌูุจูโูุง ูพุดุชูุ ูุญูู ุงุณุชูุงุฏู ุงุฒ ุขู ุฏุฑ ุงุฌุงุฏ ุฑุฏุงุจ ูพุดุชู (stack trace) ุงุณุช. ุงู ููุถูุน ฺฉู ูพุดุฑูุชูโุชุฑ ุงุณุชุ ุงูุง ุงฺฏุฑ ุนูุงููโููุฏ ูุณุชุฏุ ูโุชูุงูุฏ ุจู ูุณุชูุฏุงุช ยซุฑุฏุงุจ ูพุดุชู ุฏุฑ Goยป ฺฉู ุฏุฑ ุงู ูุฎุฒู ููุฌูุฏ ุงุณุชุ ูุฑุงุฌุนู ฺฉูุฏ.

####  4.25.1.2.2 ููพ (Heap)  

ุชุฎุตุตโูุง ูพุดุชู ุนุงู ูุณุชูุฏุ ุงูุง ุฏุฑ ุจุณุงุฑ ุงุฒ ููุงุฑุฏ Go ููโุชูุงูุฏ ุงุฒ ุขูโูุง ุงุณุชูุงุฏู ฺฉูุฏ. ุฑุงุฌโุชุฑู ุญุงูุช ุฒูุงู ุงุณุช ฺฉู ุจุงุฏ ุงุดุงุฑูโฺฏุฑ ุจู ฺฉ ูุชุบุฑ ูุญู ุงุฒ ฺฉ ุชุงุจุน ุจุงุฒฺฏุฑุฏุงูุฏู ุดูุฏ. ุงู ููุถูุน ุฑุง ูโุชูุงู ุฏุฑ ูุณุฎู ุงุตูุงุญโุดุฏู ูุซุงู ุชุงุจุน `add()` ฺฉู ุฏุฑ ุจุงูุง ุขูุฏุ ูุดุงูุฏู ฺฉุฑุฏ:

```go
func main() {
	fmt.Println(*add(23, 42))
}

func add(a, b int) *int {
	sum := a + b
	return &sum
}
```

ุฏุฑ ุญุงูุช ุนุงุฏุ Go ูโุชูุงูุฏ ูุชุบุฑ `sum` ุฑุง ุฏุงุฎู ุชุงุจุน `add()` ุฑู ูพุดุชู ุชุฎุตุต ุฏูุฏ. ุงูุง ููุงูุทูุฑ ฺฉู ุงุฏ ฺฏุฑูุชูุ ุงู ุฏุงุฏูโูุง ููฺฏุงู ุจุงุฒฺฏุดุช ุชุงุจุน `add()` ุงุฒ ุจู ูโุฑููุฏ. ุจูุงุจุฑุงูุ ุจุฑุง ุจุงุฒฺฏุฑุฏุงูุฏู ุงูู ฺฉ ุงุดุงุฑูโฺฏุฑ ุจู `&sum`ุ Go ุจุงุฏ ุญุงูุธู ุฑุง ุงุฒ ุฎุงุฑุฌ ุงุฒ ูพุดุชู ุชุฎุตุต ุฏูุฏ. ุงูุฌุง ุงุณุช ฺฉู ููพ ูุงุฑุฏ ุนูู ูโุดูุฏ.

**ููพ** ุจุฑุง ุฐุฎุฑูโุณุงุฒ ุฏุงุฏูโูุง ุงุณุชูุงุฏู ูโุดูุฏ ฺฉู ููฺฉู ุงุณุช ูพุณ ุงุฒ ูพุงุงู ุงุฌุฑุง ุชุงุจุน ุณุงุฒูุฏูุ ููฺูุงู ููุฑุฏ ูุงุฒ ุจุงุดูุฏุ ููฺูู ุจุฑุง ูุฑ ุฏุงุฏูโุง ฺฉู ุจู goroutineูุง ุจุง ุงุณุชูุงุฏู ุงุฒ ุงุดุงุฑูโฺฏุฑูุง ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชู ูโุดูุฏ. ุงูุง ุงู ุณูุงู ูพุด ูโุขุฏ ฺฉู ฺฺฏููู ุงู ุญุงูุธู ุขุฒุงุฏ ูโุดูุฏุ ฺูู ุจุฑุฎูุงู ุชุฎุตุตโูุง ูพุดุชูุ ุชุฎุตุตโูุง ููพ ุฑุง ููโุชูุงู ุจู ูุญุถ ุงุชูุงู ุชุงุจุน ฺฉู ุขูโูุง ุฑุง ุงุฌุงุฏ ฺฉุฑุฏูุ ุญุฐู ฺฉุฑุฏ.

Go ุงู ูุดฺฉู ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ุฌูุนโุขูุฑ ุฒุจุงูู ุฏุงุฎู (GC) ุฎูุฏ ุญู ูโฺฉูุฏ. ุฌุฒุฆุงุช ูพุงุฏูโุณุงุฒ ุขู ุจุณุงุฑ ูพฺุฏู ุงุณุชุ ุงูุง ุงุฒ ฺฉ ุฏุฏ ฺฉูุ GC ุญุงูุธู ุดูุง ุฑุง ุจู ุงู ุดฺฉู ูุฏุฑุช ูโฺฉูุฏ. ุฏุฑ ุชุตูุฑ ุฒุฑ ูโุจูุฏ ฺฉู ุณู goroutine ุฏุงุฑุง ุงุดุงุฑูโฺฏุฑูุง ุจู ุชุฎุตุตโูุง ุณุจุฒ ุฑูฺฏ ุฑู ููพ ูุณุชูุฏ. ุจุฑุฎ ุงุฒ ุงู ุชุฎุตุตโูุง ููฺูู ุจู ุชุฎุตุตโูุง ุณุจุฒ ุฏฺฏุฑ ุงุดุงุฑู ูโฺฉููุฏ. ุนูุงูู ุจุฑ ุงูุ ุชุฎุตุตโูุง ุฎุงฺฉุณุชุฑ ูุฌูุฏ ุฏุงุฑูุฏ ฺฉู ููฺฉู ุงุณุช ุจู ุชุฎุตุตโูุง ุณุจุฒ ุง ฺฉุฏฺฏุฑ ุงุดุงุฑู ฺฉููุฏุ ุงูุง ุฎูุฏุดุงู ุชูุณุท ุชุฎุตุตโูุง ุณุจุฒ ูุฑุฌุน ูุดุฏูโุงูุฏ. ุงู ุชุฎุตุตโูุง ุฒูุงู ูุงุจู ุฏุณุชุฑุณ ุจูุฏูุฏุ ุงูุง ุงฺฉููู ุจู ุนููุงู ุฒุจุงูู ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดููุฏ. ุงู ุงุชูุงู ููฺฉู ุงุณุช ุฒูุงู ุฑุฎ ุฏูุฏ ฺฉู ุชุงุจุน ฺฉู ุงุดุงุฑูโฺฏุฑูุง ุขูโูุง ุฑุง ุฑู ูพุดุชู ุงุฌุงุฏ ฺฉุฑุฏู ุจูุฏ ุจุงุฒฺฏุฑุฏุฏุ ุง ููุฏุงุฑุดุงู ุจุงุฒููุณ ุดุฏู ุจุงุดุฏ. ูุธูู GC ุงู ุงุณุช ฺฉู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงู ุชุฎุตุตโูุง ุฑุง ุดูุงุณุง ู ุขุฒุงุฏ ฺฉูุฏ.

{{<img url="#" image="../../assets/img/content/chapter4/profiling/7.gif" alt="heap gc">}}

ุงุฌุฑุง ุฌูุนโุขูุฑ ุฒุจุงูู (GC) ุดุงูู ูพูุงุด ฺฏุฑุงูโูุง ูพุฑูุฒูู ู ุชุฎูู ฺฉุด (cache thrashing) ุงุณุช. ุงู ูุฑุงูุฏ ุญุช ูุงุฒ ุจู ูุงุฒูุง ูุชูููโฺฉููุฏู ฺฉู ุฌูุงู (stop-the-world) ุฏุงุฑุฏ ฺฉู ุงุฌุฑุง ฺฉู ุจุฑูุงูู ุดูุง ุฑุง ูุชููู ูโฺฉูุฏ. ุฎูุดุจุฎุชุงูู ูุณุฎูโูุง ุงุฎุฑ Go ุงู ุฒูุงู ุฑุง ุจู ฺฉุณุฑ ุงุฒ ฺฉ ููโุซุงูู ฺฉุงูุด ุฏุงุฏูโุงูุฏุ ุงูุง ุจุณุงุฑ ุงุฒ ูุฒููโูุง ุจุงูโูุงูุฏู ุฐุงุชุงู ุจู ูุฑ GC ูุฑุจูุท ูโุดูุฏ. ุฏุฑ ูุงูุนุ ูุนูููุงู ฒฐ ุชุง ณฐ ุฏุฑุตุฏ ุงุฒ ุงุฌุฑุง ฺฉ ุจุฑูุงูู Go ุตุฑู ูุฏุฑุช ุญุงูุธู ูโุดูุฏ.

ุจูโุทูุฑ ฺฉูุ ูุฒูู GC ูุชูุงุณุจ ุจุง ููุฏุงุฑ ุชุฎุตุตโูุง ููพ (heap allocations) ุงุณุช ฺฉู ุจุฑูุงูู ุดูุง ุงูุฌุงู ูโุฏูุฏ. ุจูุงุจุฑุงู ููุช ุตุญุจุช ุงุฒ ุจูููโุณุงุฒ ูุฒููโูุง ูุฑุชุจุท ุจุง ุญุงูุธู ูโุดูุฏุ ุดุนุงุฑ ุงู ุงุณุช:

- **ฺฉุงูุด (Reduce)**: ุณุน ฺฉูุฏ ุชุฎุตุตโูุง ููพ ุฑุง ุจู ุชุฎุตุตโูุง ูพุดุชู ุชุจุฏู ฺฉูุฏ ุง ุงุฒ ุขูโูุง ุจูโุทูุฑ ฺฉู ุงุฌุชูุงุจ ฺฉูุฏ. ฺฉุงูุด ุชุนุฏุงุฏ ุงุดุงุฑูโฺฏุฑูุง ุฏุฑ ููพ ูุฒ ฺฉูฺฉ ูโฺฉูุฏ.
- **ุจุงุฒุงุณุชูุงุฏู (Reuse)**: ุชุฎุตุตโูุง ููพ ุฑุง ุฏูุจุงุฑู ุงุณุชูุงุฏู ฺฉูุฏ ุจู ุฌุง ุงูฺฉู ุขูโูุง ุฑุง ุจุง ุชุฎุตุตโูุง ุฌุฏุฏ ุฌุงฺฏุฒู ฺฉูุฏ.
- **ุจุงุฒุงูุช (Recycle)**: ุจุฑุฎ ุงุฒ ุชุฎุตุตโูุง ููพ ุบุฑูุงุจู ุงุฌุชูุงุจ ูุณุชูุฏ. ุจฺฏุฐุงุฑุฏ GC ุขูโูุง ุฑุง ุจุงุฒุงูุช ฺฉูุฏ ู ุจุฑ ุฑู ูุณุงุฆู ุฏฺฏุฑ ุชูุฑฺฉุฒ ฺฉูุฏ.

ููุงููุฏ ูุฏู ุฐูู ูุจู ุฏุฑ ุงู ุฑุงูููุงุ ููู ููุงุฑุฏ ุจุงูุง ููุง ุจู ุดุฏุช ุณุงุฏู ุดุฏู ุงุฒ ูุงูุนุช ุงุณุช. ุงูุง ุงูุฏูุงุฑู ฺฉู ุงู ูุฏู ุจู ุงูุฏุงุฒู ฺฉุงู ููุฏ ุจุงุดุฏ ุชุง ุจุงูโูุงูุฏู ุงู ุฑุงูููุง ุฑุง ุฏุฑฺฉ ฺฉูุฏ ู ุดูุง ุฑุง ุจู ูุทุงูุนู ููุงูุงุช ุจุดุชุฑ ุฏุฑ ุงู ุฒููู ุชุฑุบุจ ฺฉูุฏ. ฺฉ ุงุฒ ููุงูุงุช ฺฉู ุญุชูุงู ุจุงุฏ ุจุฎูุงูุฏุ ููุงูู ยซุจู Go ุฑุณุฏู: ุณูุฑ ุฌูุนโุขูุฑ ุฒุจุงูู Goยป ุงุณุช ฺฉู ุงุฏู ุฎูุจ ุงุฒ ูพุดุฑูุชโูุง GC Go ุฏุฑ ุทูู ุณุงูโูุง ู ุณุฑุนุช ุจูุจูุฏ ุขู ุงุฑุงุฆู ูโุฏูุฏ.

## 4.25.2 ุฏุฑฺฉ ุนูู ูพุฑููุงูุฑูุง (Profilers) ฺฏู

ุฏุฑ ุงูุฌุง ูุฑูุฑ ุจุฑ  {{< tooltip text="ูพุฑููุงูุฑูุง" note="profilers" >}} ุณุงุฎุชูโุดุฏู ุฏุฑ ุฒูุงู ุงุฌุฑุง Go (Go runtime) ุงุฑุงุฆู ูโุดูุฏ. ุจุฑุง ุฌุฒุฆุงุช ุจุดุชุฑุ ุจู ููฺฉโูุง ูุฑุงุฌุนู ฺฉูุฏ.

ุฏุฑ ุฒุฑ ุฌุฏูู ูุฑุจูุท ุจู ูพุฑููุงูุฑูุง ูุฎุชูู ููุฌูุฏ ุฏุฑ Go ุงุฑุงุฆู ุดุฏู ุงุณุช:

| ูฺฺฏ                                                            | [CPU](#42521-ูพุฑููุงูุฑ-cpu) | [Memory](#42522-ูพุฑููุงูุฑ-ุญุงูุธู-memory) | [Block](#42523-ูพุฑููุงูุฑ-ุจูุงฺฉ) | [Mutex](#42524-ูพุฑููุงูุฑ-mutex) | [Goroutine](#42525-ูพุฑููุงูุฑ-goroutine) | [ThreadCreate](#42526-ูพุฑููุงูุฑ-threadcreate) |
| ---------------------------------------------------------------- | -------------------------- | -------------------------------------- | ----------------------------- | ------------------------------ | -------------------------------------- | -------------------------------------------- |
| Production Safety                                                | โ                          | โ                                      | โ (1.)                        | โ                              | โ๏ธ (2.)                                | ๐ (3.)                                      |
| {{< tooltip text="ูุฑุฎ ุงูู" note="Safe Rate" >}}                | default                    | default                                | โ (1.)                        | `100`                          | `1000` goroutines                      | -                                            |
| {{< tooltip text="ุฏูุช" note="Accuracy" >}}                       | โญ๏ธโญ๏ธ                       | โญโญโญ                                    | โญโญโญ                           | โญโญโญ                            | โญโญโญ                                    | -                                            |
| {{< tooltip text="ุนูู ุญุฏุงฺฉุซุฑ ูพุดุชู" note="Max Stack Depth" >}}    | `64`                       | `32`                                   | `32`                          | `32`                           | `32` - `100` (4.)                      | -                                            |
| {{< tooltip text="ุจุฑฺุณุจโูุง ูพุฑููุงูุฑ" note="Profiler Labels" >}} | โ                          | โ                                      | โ                             | โ                              | โ                                      | -                                            |

1. **ูพุฑููุงูุฑ ุจููฺฉ** (block profiler): ุงฺฏุฑ ุจู ุฏุฑุณุช ูพฺฉุฑุจูุฏ ูุดุฏู ุจุงุดุฏุ ูพุฑููุงูุฑ ุจููฺฉ ูโุชูุงูุฏ ููุจุน ูุงุจู ุชูุฌู ุงุฒ ุจุงุฑ CPU ุจุงุดุฏ.
2. **ุชูููโูุง ุฌูุงู** (stop-the-world): ฺฉ ุชููู ุฌูุงู`O(N)` ูุฌูุฏ ุฏุงุฑุฏ ฺฉู N ุชุนุฏุงุฏ goroutineูุง ุงุณุช. ุงูุชุธุงุฑ ูโุฑูุฏ ูุฑ goroutine ุจู `~1-10` ูฺฉุฑูุซุงูู ุชููู ุฏุงุดุชู ุจุงุดุฏ.
3. **ูพุฑููุงูุฑ ThreadCreate**: ุงู ูพุฑููุงูุฑ ุจู ุทูุฑ ฺฉุงูู ูุนูุจ ุงุณุช ู ุจูุชุฑ ุงุณุช ุงุฒ ุขู ุงุณุชูุงุฏู ูฺฉูุฏ.
4. **ุนูู ุญุฏุงฺฉุซุฑ ูพุดุชู**: ุงู ููุฑุฏ ุจู API ูุงุจุณุชู ุงุณุช.

### 4.25.2.1 ูพุฑููุงูุฑ CPU

ูพุฑููุงูุฑ CPU ุฏุฑ Go ูโุชูุงูุฏ ุจู ุดูุง ฺฉูฺฉ ฺฉูุฏ ุชุง ูุณูุชโูุง ุงุฒ ฺฉุฏ ุฎูุฏ ุฑุง ฺฉู ุฒูุงู CPU ุฒุงุฏ ูุตุฑู ูโฺฉููุฏุ ุดูุงุณุง ฺฉูุฏ.

โ๏ธ ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุฒูุงู CPU ูุนูููุงู ุจุง ุฒูุงู ูุงูุน ฺฉู ฺฉุงุฑุจุฑุงู ุดูุง ุชุฌุฑุจู ูโฺฉููุฏ (ฺฉู ุจู ุขู ุชุงุฎุฑ ูโฺฏููุฏ) ูุชูุงูุช ุงุณุช. ุจู ุนููุงู ูุซุงูุ ฺฉ ุฏุฑุฎูุงุณุช HTTP ูุนูููุงู ููฺฉู ุงุณุช ฑฐฐ ููโุซุงูู ุทูู ุจฺฉุดุฏุ ุงูุง ุชููุง ต ููโุซุงูู ุงุฒ ุฒูุงู CPU ุฑุง ูุตุฑู ฺฉูุฏ ู นต ููโุซุงูู ุฑุง ุฏุฑ ุงูุชุธุงุฑ ูพุงุณุฎ ุงุฒ ูพุงฺฏุงู ุฏุงุฏู ุจฺฏุฐุฑุงูุฏ. ููฺูู ููฺฉู ุงุณุช ฺฉ ุฏุฑุฎูุงุณุช ฑฐฐ ููโุซุงูู ุทูู ุจฺฉุดุฏุ ุงูุง ฒฐฐ ููโุซุงูู ุงุฒ ุฒูุงู CPU ุฑุง ุตุฑู ฺฉูุฏ ุงฺฏุฑ ุฏู goroutine ุจู ุทูุฑ ููุฒูุงู ฺฉุงุฑูุง ูพุฑุฏุงุฒุด ุณูฺฏู ุงูุฌุงู ุฏููุฏ. ุงฺฏุฑ ุงู ููุถูุน ุจุฑุง ุดูุง ฺฏุฌโฺฉููุฏู ุงุณุชุ ูุทูุงู ุจู ุจุฎุด **ุจุฑูุงููโุฑุฒ goroutine** ูุฑุงุฌุนู ฺฉูุฏ.

ุดูุง ูโุชูุงูุฏ ูพุฑููุงูุฑ CPU ุฑุง ุงุฒ ุทุฑู APIูุง ูุฎุชูู ฺฉูุชุฑู ฺฉูุฏ:

- `go test -cpuprofile cpu.pprof`: ุงู ุฏุณุชูุฑ ุชุณุชโูุง ุดูุง ุฑุง ุงุฌุฑุง ฺฉุฑุฏู ู ูพุฑููุงู CPU ุฑุง ุฏุฑ ูุงู ุจู ูุงู **cpu.pprof** ูโููุณุฏ.
  
- `pprof.StartCPUProfile(w)`: ุงู ุฏุณุชูุฑ ูพุฑููุงู CPU ุฑุง ุจู **w** ุถุจุท ูโฺฉูุฏ ู ุฒูุงู ุฑุง ุชุง ุฒูุงู ฺฉู `pprof.StopCPUProfile()` ูุฑุงุฎูุงู ุดูุฏุ ูพูุดุด ูโุฏูุฏ.

- `import _ "net/http/pprof"`: ุงู ฺฉุฏ ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุจุง ุฏุฑุฎูุงุณุช GET ุจู ุขุฏุฑุณ `/debug/pprof/profile?seconds=30` ุงุฒ ุณุฑูุฑ HTTP ูพุดโูุฑุถ ฺฉู ูโุชูุงูุฏ ุจุง ุงุณุชูุงุฏู ุงุฒ `http.ListenAndServe("localhost:6060", nil)` ุฑุงูโุงูุฏุงุฒ ฺฉูุฏุ ฺฉ ูพุฑููุงู CPU ุจู ูุฏุช ณฐ ุซุงูู ุฏุฑุฎูุงุณุช ฺฉูุฏ.

- `runtime.SetCPUProfileRate()`: ุงู ุชุงุจุน ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ูุฑุฎ ูููููโฺฏุฑ ูพุฑููุงูุฑ CPU ุฑุง ฺฉูุชุฑู ฺฉูุฏ. ุจุฑุง ูุญุฏูุฏุชโูุง ูุนู ุจู **ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ CPU** ูุฑุงุฌุนู ฺฉูุฏ.

- `runtime.SetCgoTraceback()`: ุงู ุชุงุจุน ูโุชูุงูุฏ ุจุฑุง ุฏุฑุงูุช ุฑุฏุงุจโูุง ูพุดุชู ุจู ฺฉุฏ cgo ุงุณุชูุงุฏู ุดูุฏ. `benesch/cgosymbolizer` ฺฉ ูพุงุฏูโุณุงุฒ ุจุฑุง Linux ู macOS ุฏุงุฑุฏ.

ุงฺฏุฑ ุจู ฺฉ ูุทุนู ฺฉุฏ ุณุฑุน ูุงุฒ ุฏุงุฑุฏ ฺฉู ุจุชูุงูุฏ ุฏุฑ ุชุงุจุน **main()** ุฎูุฏ ูุฑุงุฑ ุฏูุฏุ ูโุชูุงูุฏ ุงุฒ ฺฉุฏ ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ: 

```go
file, _ := os.Create("./cpu.pprof")
pprof.StartCPUProfile(file)
defer pprof.StopCPUProfile()
```


ุตุฑู ูุธุฑ ุงุฒ ุงูฺฉู ฺฺฏููู ูพุฑููุงูุฑ CPU ุฑุง ูุนุงู ูโฺฉูุฏุ ูพุฑููุงู ุจูโุฏุณุชโุขูุฏู ุฏุฑ ุงุตู ฺฉ ุฌุฏูู ุงุฒ ุฑุฏุงุจโูุง ูพุดุชู ุงุณุช ฺฉู ุจู ูุฑูุช ุจุงูุฑ **pprof** ูุงูุจโุจูุฏ ุดุฏู ุงุณุช. ุฏุฑ ุฒุฑ ูุณุฎูโุง ุณุงุฏูโุดุฏู ุงุฒ ฺูู ุฌุฏูู ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช:

|stack trace|samples/count|cpu/nanoseconds|
|-|-|-|
|main;foo|5|50000000|
|main;foo;bar|3|30000000|
|main;foobar|4|40000000|

ูพุฑููุงูุฑ CPU ุงู ุฏุงุฏูโูุง ุฑุง ุจุง ุฏุฑุฎูุงุณุช ุงุฒ ุณุณุชูโุนุงูู ุจุฑุง ูุธุงุฑุช ุจุฑ ุงุณุชูุงุฏู ุงุฒ CPU ุจุฑูุงูู ุฌูุนโุขูุฑ ูโฺฉูุฏ ู ูุฑ ฑฐ ููโุซุงูู ฺฉู CPU ุฒูุงู ุฑุง ูุตุฑู ูโฺฉูุฏุ ุณฺฏูุงู **SIGPROF** ุฑุง ุจู ุขู ุงุฑุณุงู ูโฺฉูุฏ. ููฺูู ุณุณุชูโุนุงูู ุฒูุงู ุตุฑูโุดุฏู ุชูุณุท ฺฉุฑูู ุจู ููุงูุฏฺฏ ุงุฒ ุจุฑูุงูู ุฑุง ุฏุฑ ุงู ูุธุงุฑุช ุดุงูู ูโฺฉูุฏ. ุงุฒ ุขูุฌุง ฺฉู ูุฑุฎ ุชุญูู ุณฺฏูุงู ุจู ูุตุฑู CPU ูุงุจุณุชู ุงุณุชุ ุงู ูุฑุฎ ุฏูุงูฺฉ ุจูุฏู ู ูโุชูุงูุฏ ุจู ุญุฏุงฺฉุซุฑ **N * 100Hz** ุจุฑุณุฏ ฺฉู ุฏุฑ ุขู **N** ุชุนุฏุงุฏ ูุณุชูโูุง ููุทู CPU ุฏุฑ ุณุณุชู ุงุณุช.

ููฺฏุงู ฺฉู ุณฺฏูุงู **SIGPROF** ุฏุฑุงูุช ูโุดูุฏุ ููุฏูุฑ ุณฺฏูุงู Go ฺฉ ุฑุฏุงุจ ูพุดุชู ุงุฒ goroutine ูุนุงู ฺฉู ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุฑ ุญุงู ุงุฌุฑุง ุงุณุชุ ุฌูุนโุขูุฑ ูโฺฉูุฏ ู ููุงุฏุฑ ูุฑุจูุทู ุฏุฑ ูพุฑููุงู ุฑุง ุงูุฒุงุด ูโุฏูุฏ. ููุฏุงุฑ **cpu/nanoseconds** ุฏุฑ ุญุงู ุญุงุถุฑ ูุณุชููุงู ุงุฒ ุชุนุฏุงุฏ ูููููโูุง ูุดุชู ูโุดูุฏุ ุจูุงุจุฑุงู ุงู ููุฏุงุฑ ุชฺฉุฑุงุฑ ุงุณุชุ ุงูุง ุฑุงุญุช ุงุณุช.


#### 4.25.2.1.1 ุจุฑฺุณุจโูุง ูพุฑููุงูุฑ (Profiler Labels) CPU

ฺฉ ุงุฒ ูฺฺฏโูุง ุฌุงูุจ ูพุฑููุงูุฑ CPU ุฏุฑ Go ุงู ุงุณุช ฺฉู ูโุชูุงูุฏ ุฌูุชโูุง ฺฉูุฏ ู ููุฏุงุฑ ุฏูุฎูุงู ุฑุง ุจู ฺฉ goroutine ูุชุตู ฺฉูุฏ. ุงู ุจุฑฺุณุจโูุง ุชูุณุท ูุฑ goroutineโุง ฺฉู ุงุฒ ุขู goroutine ูุชููุฏ ูโุดูุฏุ ุจู ุงุฑุซ ุจุฑุฏู ูโุดููุฏ ู ุฏุฑ ูพุฑููุงู ููุง ููุงุด ุฏุงุฏู ูโุดููุฏ.

ุจุงุฏ ูุซุงู ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑู ฺฉู ุจุฑุฎ ุงุฒ ฺฉุงุฑูุง CPU ุฑุง ุจู ููุงูุฏฺฏ ุงุฒ ฺฉ ฺฉุงุฑุจุฑ ุงูุฌุงู ูโุฏูุฏ. ุจุง ุงุณุชูุงุฏู ุงุฒ API ูุง `pprof.Labels()` ู `pprof.Do()`ุ ูโุชูุงูู ฺฉุงุฑุจุฑ ุฑุง ุจุง goroutine ฺฉู ุฏุฑ ุญุงู ุงุฌุฑุง ุชุงุจุน `work()` ุงุณุชุ ูุฑุชุจุท ฺฉูู. ุนูุงูู ุจุฑ ุงูุ ุจุฑฺุณุจโูุง ุจูโุทูุฑ ุฎูุฏฺฉุงุฑ ุชูุณุท ูุฑ goroutineโุง ฺฉู ุฏุฑ ููุงู ุจููฺฉ ฺฉุฏ ูุชููุฏ ูโุดูุฏุ ุจู ุงุฑุซ ุจุฑุฏู ูโุดููุฏุ ุจุฑุง ูุซุงู `goroutine backgroundWork()`.

```go
func work(ctx context.Context, user string) {
	labels := pprof.Labels("user", user)
	pprof.Do(ctx, labels, func(_ context.Context) {
		go backgroundWork()
		directWork()
	})
}
```

ูพุฑููุงู ููุง ุดุงูู ฺฉ ุณุชูู ุจุฑฺุณุจ ุฌุฏุฏ ุฎูุงูุฏ ุจูุฏ ู ููฺฉู ุงุณุช ุจู ุดฺฉู ุฒุฑ ุจุงุดุฏ:

|stack trace|label|samples/count|cpu/nanoseconds|
|-|-|-|-|
|main.backgroundWork|user:bob|5|50000000|
|main.backgroundWork|user:alice|2|20000000|
|main.work;main.directWork|user:bob|4|40000000|
|main.work;main.directWork|user:alice|3|30000000|

ูุดุงูุฏู ููุงู ูพุฑููุงู ุจุง ููุง ฺฏุฑุงู pprof ูุฒ ุดุงูู ุจุฑฺุณุจโูุง ุฎูุงูุฏ ุจูุฏ:

{{<img url="#" image="../../assets/img/content/chapter4/profiling/8.png" alt="cpu profiler labels">}}

ฺฺฏููฺฏ ุงุณุชูุงุฏู ุงุฒ ุงู ุจุฑฺุณุจโูุง ุจู ุดูุง ุจุณุชฺฏ ุฏุงุฑุฏ. ูโุชูุงูุฏ ููุงุฑุฏ ูุงููุฏ ุดูุงุณูโูุง ฺฉุงุฑุจุฑุ ุดูุงุณูโูุง ุฏุฑุฎูุงุณุชุ ููุงุท ูพุงุงู HTTPุ ุจุฑูุงููโูุง ุงุดุชุฑุงฺฉ ุง ุฏุงุฏูโูุง ุฏฺฏุฑ ุฑุง ุดุงูู ฺฉูุฏ ฺฉู ุจู ุดูุง ฺฉูฺฉ ูโฺฉูุฏ ุฏุฑฺฉ ุจูุชุฑ ุงุฒ ุงูฺฉู ฺฉุฏุงู ููุน ุฏุฑุฎูุงุณุชโูุง ุจุงุนุซ ูุตุฑู ุจุงูุง CPU ูโุดููุฏุ ุญุช ุฒูุงู ฺฉู ุชูุณุท ููุงู ูุณุฑูุง ฺฉุฏ ูพุฑุฏุงุฒุด ูโุดููุฏุ ุจู ุฏุณุช ุขูุฑุฏ. ุจุง ุงู ุญุงูุ ุงุณุชูุงุฏู ุงุฒ ุจุฑฺุณุจโูุง ุงูุฏุงุฒู ูุงูโูุง pprof ุดูุง ุฑุง ุงูุฒุงุด ูโุฏูุฏ. ุจูุงุจุฑุงู ุจูุชุฑ ุงุณุช ุจุง ุจุฑฺุณุจโูุง ุจุง ฺฉุงุฑุฏูุงูุชู ูพุงู ูุงููุฏ ููุงุท ูพุงุงู ุดุฑูุน ฺฉูุฏ ู ุณูพุณ ุจู ุจุฑฺุณุจโูุง ุจุง ฺฉุงุฑุฏูุงูุชู ุจุงูุง ุจุฑูุฏุ ุฒูุงู ฺฉู ุงุญุณุงุณ ูโฺฉูุฏ ุจุฑ ุนููฺฉุฑุฏ ุจุฑูุงูู ุดูุง ุชุฃุซุฑ ููโฺฏุฐุงุฑุฏ.

โ๏ธ ูุณุฎูโูุง Go 1.17 ู ูพุงูโุชุฑ ุญุงู ฺูุฏู ุงุดฺฉุงู ุจูุฏูุฏ ฺฉู ูโุชูุงูุณุชูุฏ ููุฌุฑ ุจู ุนุฏู ูุฌูุฏ ุจุฑุฎ ุจุฑฺุณุจโูุง ูพุฑููุงูุฑ ุฏุฑ ูพุฑููุงูโูุง CPU ุดููุฏุ ุจุฑุง ุงุทูุงุนุงุช ุจุดุชุฑ ุจู ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ CPU ูุฑุงุฌุนู ฺฉูุฏ.

#### 4.25.2.1.2 ูุตุฑู CPU

ุงุฒ ุขูุฌุง ฺฉู ูุฑุฎ ูููููโฺฏุฑ ูพุฑููุงูุฑ CPU ุจุง ุชูุฌู ุจู ููุฏุงุฑ CPU ฺฉู ุจุฑูุงูู ุดูุง ูุตุฑู ูโฺฉูุฏุ ุชูุธู ูโุดูุฏุ ูโุชูุงูุฏ ูุตุฑู CPU ุฑุง ุงุฒ ูพุฑููุงูโูุง CPU ุงุณุชุฎุฑุงุฌ ฺฉูุฏ. ุฏุฑ ูุงูุนุ pprof ุงู ฺฉุงุฑ ุฑุง ุจู ุทูุฑ ุฎูุฏฺฉุงุฑ ุจุฑุง ุดูุง ุงูุฌุงู ูโุฏูุฏ. ุจู ุนููุงู ูุซุงูุ ูพุฑููุงู ุฒุฑ ุงุฒ ุจุฑูุงููโุง ุงุณุชุฎุฑุงุฌ ุดุฏู ุงุณุช ฺฉู ุฏุงุฑุง ูุงูฺฏู ูุตุฑู CPU ุจุฑุงุจุฑ ุจุง 147.77% ุจูุฏ:

```shell
$ go tool pprof guide/cpu-utilization.pprof
Type: cpu
Time: Sep 9, 2021 at 11:34pm (CEST)
Duration: 1.12s, Total samples = 1.65s (147.77%)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof) 
```

ุฑูุด ุฏฺฏุฑ ฺฉู ุจุฑุง ุจุงู ูุตุฑู CPU ูุญุจูุจ ุงุณุชุ ุงุณุชูุงุฏู ุงุฒ ูุณุชูโูุง CPU ุงุณุช. ุฏุฑ ูุซุงู ุจุงูุงุ ุจุฑูุงูู ุจูโุทูุฑ ูุงูฺฏู ุงุฒ 1.47 ูุณุชู CPU ุฏุฑ ุทูู ุฏูุฑู ูพุฑููุงูโุณุงุฒ ุงุณุชูุงุฏู ูโฺฉุฑุฏ.

โ๏ธ ุฏุฑ ูุณุฎูโูุง Go 1.17 ู ูพุงูโุชุฑุ ูุจุงุฏ ุจู ุงู ุนุฏุฏ ุจู ุฎุตูุต ุงฺฏุฑ ูุฒุฏฺฉ ุง ุจุดุชุฑ ุงุฒ 250% ุจุงุดุฏุ ุงุนุชูุงุฏ ุฒุงุฏ ุฏุงุดุชู ุจุงุดุฏ. ุจุง ุงู ุญุงูุ ุงฺฏุฑ ุนุฏุฏ ุจุณุงุฑ ูพุงู ูุงููุฏ 10% ูุดุงูุฏู ฺฉุฑุฏุฏุ ูุนูููุงู ูุดุงูโุฏููุฏู ุงู ุงุณุช ฺฉู ูุตุฑู CPU ุจุฑุง ุจุฑูุงูู ุดูุง ูุดฺฉู ูุณุช. ฺฉ ุงุดุชุจุงู ุฑุงุฌ ุงู ุงุณุช ฺฉู ุจู ุงู ุนุฏุฏ ุชูุฌู ูฺฉุฑุฏู ู ูฺฏุฑุงู ฺฉ ุชุงุจุน ุฎุงุต ุจุงุดุฏ ฺฉู ุฒูุงู ุฒุงุฏ ูุณุจุช ุจู ุจูู ูพุฑููุงู ุตุฑู ูโฺฉูุฏ. ุงู ูุนูููุงู ููุช ุชูู ฺฉุฑุฏู ุงุณุชุ ุฒูุงู ฺฉู ูุตุฑู ฺฉู CPU ูพุงู ุงุณุชุ ุฒุฑุง ุงุฒ ุจูููโุณุงุฒ ุงู ุชุงุจุน ฺูุฏุงู ุณูุฏ ูุฎูุงูุฏ ุจุฑุฏ.

#### 4.25.2.1.3 ูุฑุงุฎูุงูโูุง ุณุณุชู ุฏุฑ ูพุฑููุงูโูุง CPU

ุงฺฏุฑ ุฏุฑ ูพุฑููุงูโูุง CPU ุฎูุฏ ูุฑุงุฎูุงูโูุง ุณุณุชู ูุงููุฏ `syscall.Read()` ุง `syscall.Write()` ุฑุง ูุดุงูุฏู ฺฉุฑุฏุฏ ฺฉู ุฒูุงู ุฒุงุฏ ุฑุง ุตุฑู ูโฺฉููุฏุ ูุทูุงู ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุงู ููุท ุฒูุงู CPU ุตุฑู ุดุฏู ุฏุฑ ุฏุงุฎู ุงู ุชูุงุจุน ุฏุฑ ูุณุชู ุงุณุช. ุฒูุงู I/O ุฎูุฏ ุจูโุทูุฑ ุฌุฏุงฺฏุงูู ูพฺฏุฑ ููโุดูุฏ. ุตุฑู ุฒูุงู ุฒุงุฏ ุฏุฑ ูุฑุงุฎูุงูโูุง ุณุณุชู ูุนูููุงู ูุดุงููโุง ุงุฒ ุงูุฌุงู ุจุด ุงุฒ ุญุฏ ุขูโูุง ุงุณุชุ ุจูุงุจุฑุงู ุดุงุฏ ุงูุฒุงุด ุงูุฏุงุฒู ุจุงูุฑูุง ุจุชูุงูุฏ ฺฉูฺฉ ฺฉูุฏ. ุจุฑุง ูููุนุชโูุง ูพฺุฏูโุชุฑ ูุงููุฏ ุงูุ ุจุงุฏ ุงุณุชูุงุฏู ุงุฒ Linux perf ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏุ ุฒุฑุง ูโุชูุงูุฏ stack trace ูุง ูุณุชู ุฑุง ูุฒ ุจู ุดูุง ูุดุงู ุฏูุฏ ฺฉู ููฺฉู ุงุณุช ุณุฑูุฎโูุง ุงุถุงู ุจุฑุง ุดูุง ูุฑุงูู ฺฉูุฏ.

#### 4.25.2.1.4 ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ CPU

ฺูุฏู ูุดฺฉู ู ูุญุฏูุฏุช ุดูุงุฎุชูโุดุฏู ุจุฑุง ูพุฑููุงูุฑ CPU ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ููฺฉู ุงุณุช ุจุฎูุงูุฏ ุงุฒ ุขูโูุง ุขฺฏุงู ุจุงุดุฏ:

- ๐ [**GH #35057**](https://github.com/golang/go/issues/35057): ูพุฑููุงูโูุง CPU ฺฉู ุจุง ูุณุฎูโูุง Go <= 1.17 ฺฏุฑูุชู ุดุฏูโุงูุฏุ ุจูโุทูุฑ ูุณุจ ุจุฑุง ุจุฑูุงููโูุง ฺฉู ุงุฒ ุจุด ุงุฒ 2.5 ูุณุชู CPU ุงุณุชูุงุฏู ูโฺฉููุฏุ ุฏูุช ฺฉูุชุฑ ุฏุงุฑูุฏ. ุจูโุทูุฑ ฺฉูุ ุงุณุชูุงุฏู ฺฉู ุงุฒ CPU ุจูโุทูุฑ ูุงุฏุฑุณุช ฺฏุฒุงุฑุด ูโุดูุฏ ู ูพฺฉโูุง ุจุงุฑฺฉุงุฑ ููฺฉู ุงุณุช ุจูโุฏุฑุณุช ุฏุฑ ูพุฑููุงู ุญุงุตู ููุงุงู ูุดููุฏ. ุงู ูุดฺฉู ุฏุฑ Go 1.18 ุจุฑุทุฑู ุดุฏู ุงุณุช. ุฏุฑ ุนู ุญุงูุ ูโุชูุงูุฏ ุงุฒ Linux perf ุจูโุนููุงู ฺฉ ุฑุงูโุญู ูููุช ุงุณุชูุงุฏู ฺฉูุฏ.
  
- ๐ **ุจุฑฺุณุจโูุง ูพุฑููุงูุฑ ุฏุฑ Go <= 1.17** ุงุฒ ฺูุฏู ุจุงฺฏ ุฑูุฌ ูโุจุฑุฏูุฏ.
  - [**GH #48577**](https://github.com/golang/go/issues/48577) ู [**CL 367200**](https://go-review.googlesource.com/c/go/+/367200/): ุจุฑฺุณุจโูุง ุจุฑุง goroutineูุง ฺฉู ุจุฑ ุฑู ุงุณุชฺฉ ุณุณุชูุ ฺฉุฏ C ุฑุง ุงุฌุฑุง ูโฺฉููุฏ ุง ูุฑุงุฎูุงูโูุง ุณุณุชู ุฑุง ุงูุฌุงู ูโุฏููุฏุ ฺฏู ุดุฏู ุจูุฏูุฏ.
  - [**CL 369741**](https://go-review.googlesource.com/c/go/+/369741): ุงููู ุฏุณุชู ุงุฒ ูููููโูุง ุฏุฑ ฺฉ ูพุฑููุงู CPU ุฏุงุฑุง ุฎุทุง off-by-one ุจูุฏูุฏ ฺฉู ุจุงุนุซ ูุณุจุชโฺฏุฐุงุฑ ูุงุฏุฑุณุช ุจุฑฺุณุจโูุง ูโุดุฏ.
  - [**CL 369983**](https://go-review.googlesource.com/c/go/+/369983): ุณุณุชู goroutineูุง ฺฉู ุจู ููุงูุฏฺฏ ุงุฒ goroutineูุง ฺฉุงุฑุจุฑ ุงุฌุงุฏ ุดุฏูโุงูุฏ (ูุซูุงู ุจุฑุง ุฌูุนโุขูุฑ ุฒุจุงูู) ุจูโุทูุฑ ูุงุฏุฑุณุช ุจุฑฺุณุจโูุง ูุงูุฏู ุฎูุฏ ุฑุง ุจู ุงุฑุซ ุจุฑุฏูุฏ.

- โ๏ธ๏ธ ูโุชูุงูุฏ ุงุฒ [`runtime.SetCPUProfileRate()`](https://pkg.go.dev/runtime#SetCPUProfileRate) ุจุฑุง ุชูุธู ูุฑุฎ ูพุฑููุงูุฑ CPU ูุจู ุงุฒ ูุฑุงุฎูุงู `runtime.StartCPUProfile()` ุงุณุชูุงุฏู ฺฉูุฏ. ุงู ุนูู ฺฉ ูุดุฏุงุฑ ุฑุง ฺุงูพ ูโฺฉูุฏ ฺฉู ูโฺฏูุฏ `runtime: cannot set cpu profile rate until previous profile has finished`. ุจุง ุงู ุญุงูุ ุงู ุนูู ูููุฒ ุฏุฑ ฺุงุฑฺูุจ ูุญุฏูุฏุชโูุง ุจุงฺฏ ุฐฺฉุฑ ุดุฏู ุนูู ูโฺฉูุฏ. ุงู ูุณุฆูู ุงุจุชุฏุง ุฏุฑ [ุงูุฌุง](https://github.com/golang/go/issues/40094) ูุทุฑุญ ุดุฏ ู ฺฉ [ูพุดููุงุฏ](https://github.com/golang/go/issues/42502) ูพุฐุฑูุชู ุดุฏู ุจุฑุง ุจูุจูุฏ API ูุฌูุฏ ุฏุงุฑุฏ.

- โ๏ธ ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ูุฑุงุฎูุงูโูุง ุชู ุฏุฑ ุชู ุชุงุจุน ฺฉู ูโุชูุงูุฏ ุฏุฑ stack trace ูุง ุชูุณุท ูพุฑููุงูุฑ CPU ุถุจุท ุดูุฏุ ุฏุฑ ุญุงู ุญุงุถุฑ [64](https://sourcegraph.com/search?q=context:global+repo:github.com/golang/go+file:src/*+maxCPUProfStack+%3D&patternType=literal) ุงุณุช. ุงฺฏุฑ ุจุฑูุงูู ุดูุง ุงุฒ ุงูฺฏููุง ูุงููุฏ ุจุงุฒฺฏุดุช ุนูู ุง ุฏฺฏุฑ ุงูฺฏููุง ุงุณุชูุงุฏู ฺฉูุฏ ฺฉู ุจู ุนูู ุงุณุชฺฉ ุจุงูุง ููุฌุฑ ูโุดูุฏุ ูพุฑููุงู CPU ุดูุง ุดุงูู stack trace ูุง ุฎูุงูุฏ ุจูุฏ ฺฉู ุจุฑุด ุฏุงุฏู ุดุฏูโุงูุฏ. ุงู ุจู ุงู ูุนูุงุณุช ฺฉู ุดูุง ุจุฎุด ุงุฒ ุฒูุฌุฑูู ูุฑุงุฎูุงู ฺฉู ุจู ุชุงุจุน ฺฉู ุฏุฑ ุฒูุงู ูููููโุจุฑุฏุงุฑ ูุนุงู ุจูุฏุ ููุฌุฑ ุดุฏูุ ุฑุง ุงุฒ ุฏุณุช ุฎูุงูุฏ ุฏุงุฏ.

### 4.25.2.2 ูพุฑููุงูุฑ ุญุงูุธู (Memory)

ูพุฑููุงูุฑ ุญุงูุธู ุฏุฑ Go ูโุชูุงูุฏ ุจู ุดูุง ฺฉูฺฉ ฺฉูุฏ ุชุง ุดูุงุณุง ฺฉูุฏ ฺฉุฏุงู ุจุฎุดโูุง ฺฉุฏ ุดูุง ุฏุงุฑุง ุชุนุฏุงุฏ ุฒุงุฏ ุชุฎุตุตุงุช ุญุงูุธู ุฏุฑ ููพ (heap) ูุณุชูุฏ ู ููฺูู ฺูุฏ ุชุง ุงุฒ ุงู ุชุฎุตุตุงุช ุฏุฑ ุขุฎุฑู ุฌูุนโุขูุฑ ุฒุจุงูู (garbage collection) ูููุฒ ุฏุฑ ุฏุณุชุฑุณ ุจูุฏูุฏ. ุจู ููู ุฏููุ ูพุฑููุงู ุชููุฏ ุดุฏู ุชูุณุท ูพุฑููุงูุฑ ุญุงูุธู ูุนูููุงู ุจูโุนููุงู ูพุฑููุงู ููพ ูุฒ ุดูุงุฎุชู ูโุดูุฏ.

ูุฏุฑุช ุญุงูุธู ููพ ูุนูููุงู ูุณุฆูู ุญุฏูุฏ 20-30% ุงุฒ ุฒูุงู CPU ูุตุฑู ุชูุณุท ูุฑุขูุฏูุง Go ุงุณุช. ุนูุงูู ุจุฑ ุงูุ ุญุฐู ุชุฎุตุตุงุช ููพ ูโุชูุงูุฏ ุชุฃุซุฑุงุช ุซุงูููโุง ุฏุงุดุชู ุจุงุดุฏ ฺฉู ุจุฎุดโูุง ุฏฺฏุฑ ฺฉุฏ ุดูุง ุฑุง ุจูโุฏูู ฺฉุงูุด ููุฏุงุฑ ูุฏุฑ ุฑูุช ฺฉุด (cache thrashing) ฺฉู ุฏุฑ ููฺฏุงู ุงุณฺฉู ููพ ุชูุณุท ุฌูุนโุขูุฑูุฏู ุฒุจุงูู (garbage collector) ุฑุฎ ูโุฏูุฏุ ุณุฑุนโุชุฑ ูโฺฉูุฏ. ุจู ุงู ูุนู ฺฉู ุจูููโุณุงุฒ ุชุฎุตุตโูุง ุญุงูุธู ูโุชูุงูุฏ ูุนูููุงู ุจุงุฒฺฏุดุช ุจูุชุฑ ูุณุจุช ุจู ุจูููโุณุงุฒ ูุณุฑูุง ฺฉุฏ ูุงุจุณุชู ุจู CPU ุฏุฑ ุจุฑูุงูู ุดูุง ุฏุงุดุชู ุจุงุดุฏ.

โ๏ธ ูพุฑููุงูุฑ ุญุงูุธู ุชุฎุตุตุงุช ุงุณุชฺฉ ุฑุง ูุดุงู ููโุฏูุฏ ุฒุฑุง ุงูโูุง ุจูโุทูุฑ ฺฉู ุจุณุงุฑ ุงุฑุฒุงูโุชุฑ ุงุฒ ุชุฎุตุตุงุช ููพ ูุณุชูุฏ. ุจุฑุง ุงุทูุงุนุงุช ุจุดุชุฑ ุจู ุจุฎุด ุฌูุนโุขูุฑูุฏู ุฒุจุงูู ูุฑุงุฌุนู ฺฉูุฏ.

ุดูุง ูโุชูุงูุฏ ูพุฑููุงูุฑ ุญุงูุธู ุฑุง ุงุฒ ุทุฑู API ูุง ูุฎุชูู ฺฉูุชุฑู ฺฉูุฏ:

- `go test -memprofile mem.pprof` ุชุณุชโูุง ุดูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ู ูพุฑููุงู ุญุงูุธู ุฑุง ุฏุฑ ูุงู ุจู ูุงู `mem.pprof` ูโููุณุฏ.
- `pprof.Lookup("allocs").WriteTo(w, 0)` ูพุฑููุงู ุญุงูุธูโุง ฺฉู ุดุงูู ุฑูุฏุงุฏูุง ุชุฎุตุต ุงุฒ ุฒูุงู ุดุฑูุน ูุฑุขูุฏ ุงุณุช ุฑุง ุจู `w` ูโููุณุฏ.
- `import _ "net/http/pprof"` ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ฺฉู ฺฉ ูพุฑููุงู ุญุงูุธู 30 ุซุงููโุง ุจุง ูุฑุงุฎูุงู `GET /debug/pprof/allocs?seconds=30` ุงุฒ ุณุฑูุฑ HTTP ูพุดโูุฑุถ ฺฉู ูโุชูุงูุฏ ุจุง `http.ListenAndServe("localhost:6060", nil)` ุฑุงูโุงูุฏุงุฒ ฺฉูุฏุ ุฏุฑุฎูุงุณุช ฺฉูุฏ. ุงู ูพุฑููุงู ุจูโุทูุฑ ุฏุงุฎู ุจู ุนููุงู ูพุฑููุงู ุฏูุชุง (delta profile) ุดูุงุฎุชู ูโุดูุฏ.
- `runtime.MemProfileRate` ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ุชุง ูุฑุฎ ูููููโุจุฑุฏุงุฑ ูพุฑููุงูุฑ ุญุงูุธู ุฑุง ฺฉูุชุฑู ฺฉูุฏ. ุจุฑุง ูุญุฏูุฏุชโูุง ฺฉููู ุจู **ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ ุญุงูุธู** ูุฑุงุฌุนู ฺฉูุฏ.

ุงฺฏุฑ ุจู ฺฉ ูุทุนู ฺฉุฏ ุณุฑุน ูุงุฒ ุฏุงุฑุฏ ฺฉู ุจุชูุงูุฏ ุขู ุฑุง ุจู ุชุงุจุน `main()` ุฎูุฏ ุงุถุงูู ฺฉูุฏุ ูโุชูุงูุฏ ุงุฒ ฺฉุฏ ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

```go
file, _ := os.Create("./mem.pprof")
defer pprof.Lookup("allocs").WriteTo(file, 0)
defer runtime.GC()
```

ุตุฑู ูุธุฑ ุงุฒ ุงูฺฉู ฺฺฏููู ูพุฑููุงูุฑ ุญุงูุธู ุฑุง ูุนุงู ฺฉูุฏุ ูพุฑููุงู ุญุงุตู ุงุณุงุณุงู ฺฉ ุฌุฏูู ุงุฒ ุฑุฏุงุจโูุง ูพุดุชู ุงุณุช ฺฉู ุจู ูุฑูุช ุจุงูุฑ pprof ูุฑูุชโุจูุฏ ุดุฏู ุงุณุช. ูุณุฎูโุง ุณุงุฏูโุดุฏู ุงุฒ ฺูู ุฌุฏูู ุฏุฑ ุฒุฑ ูุดุงู ุฏุงุฏู ุดุฏู ุงุณุช:

|stack trace|alloc_objects/count|alloc_space/bytes|inuse_objects/count|inuse_space/bytes|
|-|-|-|-|-|
|main;foo|5|120|2|48|
|main;foo;bar|3|768|0|0|
|main;foobar|4|512|1|128|

ฺฉ ูพุฑููุงู ุญุงูุธู ุดุงูู ุฏู ุจุฎุด ุงุตู ุงุทูุงุนุงุช ุงุณุช:

- `alloc_*`: ููุฏุงุฑ ุชุฎุตุตโูุง ฺฉู ุจุฑูุงูู ุดูุง ุงุฒ ุฒูุงู ุดุฑูุน ูุฑุงูุฏ (ุง ุฏูุฑู ูพุฑููุงูโฺฏุฑ ุจุฑุง ูพุฑููุงูโูุง ุฏูุชุง) ุงูุฌุงู ุฏุงุฏู ุงุณุช.
- `inuse_*`: ููุฏุงุฑ ุชุฎุตุตโูุง ฺฉู ุจุฑูุงูู ุดูุง ุงูุฌุงู ุฏุงุฏู ู ุฏุฑ ุขุฎุฑู ุฌูุนโุขูุฑ ุฒุจุงูู (GC) ููฺูุงู ูุงุจู ุฏุณุชุฑุณ ุจูุฏูุฏ.

ุดูุง ูโุชูุงูุฏ ุงุฒ ุงู ุงุทูุงุนุงุช ุจุฑุง ููุงุตุฏ ูุฎุชูู ุงุณุชูุงุฏู ฺฉูุฏ. ุจู ุนููุงู ูุซุงูุ ูโุชูุงูุฏ ุงุฒ ุฏุงุฏูโูุง `alloc_*` ุจุฑุง ุชุนู ุงูฺฉู ฺฉุฏุงู ูุณุฑูุง ฺฉุฏ ููฺฉู ุงุณุช ุฒุจุงูู ุฒุงุฏ ุชููุฏ ฺฉููุฏ ฺฉู GC ุจุงุฏ ุจุง ุขู ุจุฑุฎูุฑุฏ ฺฉูุฏุ ุงุณุชูุงุฏู ฺฉูุฏ. ููฺูู ุจุฑุฑุณ ุฏุงุฏูโูุง `inuse_*` ุฏุฑ ุทูู ุฒูุงู ูโุชูุงูุฏ ุจู ุดูุง ุฏุฑ ุจุฑุฑุณ ูุดุช ุญุงูุธู ุง ุงุณุชูุงุฏู ุจุงูุง ุญุงูุธู ุชูุณุท ุจุฑูุงููโุชุงู ฺฉูฺฉ ฺฉูุฏ.

#### 4.25.2.2.1 ุชูุงูุช ูพุฑููุงูโูุง Allocations ู Heap

ุชุงุจุน `pprof.Lookup()` ู ููฺูู ุจุณุชู `[net/http/pprof](https://pkg.go.dev/net/http/pprof)` ูพุฑููุงู ุญุงูุธู ุฑุง ุชุญุช ุฏู ูุงู ูุฎุชูู ุนุฑุถู ูโฺฉููุฏ: `allocs` ู `heap`. ูุฑ ุฏู ูพุฑููุงู ุดุงูู ุฏุงุฏูโูุง ฺฉุณุงู ูุณุชูุฏุ ุชููุง ุชูุงูุช ุงู ุงุณุช ฺฉู ูพุฑููุงู `allocs` ุจู ุนููุงู ููุน ููููู ูพุดโูุฑุถ `alloc_space/bytes` ุฑุง ุฏุงุฑุฏุ ุฏุฑ ุญุงู ฺฉู ูพุฑููุงู `heap` ุจู ุทูุฑ ูพุดโูุฑุถ `inuse_space/bytes` ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ. ุงู ููุถูุน ุชูุณุท ุงุจุฒุงุฑ `pprof` ุจุฑุง ุชุตููโฺฏุฑ ุฏุฑุจุงุฑู ููุน ูููููโุง ฺฉู ุจุงุฏ ุจู ุทูุฑ ูพุดโูุฑุถ ูุดุงู ุฏุงุฏู ุดูุฏุ ุงุณุชูุงุฏู ูโุดูุฏ.

#### 4.25.2.2.2 ูููููโุจุฑุฏุงุฑ (Sampling) ูพุฑููุงู ุญุงูุธู

ุจุฑุง ุญูุธ ุจุงุฑ ฺฉูุ ูพุฑููุงู ุญุงูุธู ุงุฒ ูููููโุจุฑุฏุงุฑ ูพูุงุณูู ุงุณุชูุงุฏู ูโฺฉูุฏ ุชุง ุจู ุทูุฑ ูุชูุณุท ููุท ฺฉ ุชุฎุตุต ุงุฒ ูุฑ 512KiB ุจุงุนุซ ุดูุฏ ฺฉู ฺฉ ุฑุฏุงุจ ูพุดุชู ฺฏุฑูุชู ุดุฏู ู ุจู ูพุฑููุงู ุงุถุงูู ุดูุฏ. ุจุง ุงู ุญุงูุ ูุจู ุงุฒ ุงูฺฉู ูพุฑููุงู ุจู ูุงู ููุง `pprof` ููุดุชู ุดูุฏุ ุฒูุงูโุงุฌุฑุง ููุงุฏุฑ ููููู ุฌูุนโุขูุฑ ุดุฏู ุฑุง ุจุง ุชูุณู ุจุฑ ุงุญุชูุงู ูููููโุจุฑุฏุงุฑ ููุงุณ ูโุฏูุฏ. ุงู ุจุฏุงู ูุนูุงุณุช ฺฉู ููุฏุงุฑ ุชุฎุตุตโูุง ฺฏุฒุงุฑุด ุดุฏู ุจุงุฏ ุชุฎูู ุฎูุจ ุงุฒ ููุฏุงุฑ ูุงูุน ุชุฎุตุตโูุง ุจุงุดุฏุ ุตุฑูโูุธุฑ ุงุฒ ูุฑุฎ `runtime.MemProfileRate` ฺฉู ุงุณุชูุงุฏู ูโฺฉูุฏ.

ุจุฑุง ูพุฑููุงูโฺฏุฑ ุฏุฑ ูุญุท ุชููุฏุ ูุนูููุงู ูุงุฒ ุจู ุชุบุฑ ูุฑุฎ ูููููโุจุฑุฏุงุฑ ูุณุช. ุชููุง ุฏูู ฺฉู ุจุฑุง ุงู ฺฉุงุฑ ูุฌูุฏ ุฏุงุฑุฏุ ูฺฏุฑุงู ุฏุฑุจุงุฑู ุงู ุงุณุช ฺฉู ุฏุฑ ุดุฑุงุท ฺฉู ุชุฎุตุตโูุง ุจุณุงุฑ ฺฉู ุงูุฌุงู ูโุดูุฏุ ููฺฉู ุงุณุช ุชุนุฏุงุฏ ฺฉุงู ูููููโูุง ุฌูุนโุขูุฑ ูุดูุฏ.

#### 4.25.2.2.3 Memory Inuse ุฏุฑ ููุงุจู RSS 

ฺฉ ุงุดุชุจุงู ุฑุงุฌ ุงู ุงุณุช ฺฉู ููุฏุงุฑ ฺฉู ุญุงูุธู ฺฏุฒุงุฑุดโุดุฏู ุชูุณุท ููุน ููููู `inuse_space/bytes` ุฑุง ุจุง ููุฏุงุฑ ุงุณุชูุงุฏู ุงุฒ ุญุงูุธู [RSS](https://en.wikipedia.org/wiki/Resident_set_size) ฺฉู ุชูุณุท ุณุณุชูโุนุงูู ฺฏุฒุงุฑุด ูโุดูุฏ ููุงุณู ฺฉูุฏ ู ูุชูุฌู ุดูุฏ ฺฉู ุงู ุฏู ุจุง ูู ูุทุงุจูุช ูุฏุงุฑูุฏ. ุฏูุงู ูุฎุชูู ุจุฑุง ุงู ุนุฏู ุชุทุงุจู ูุฌูุฏ ุฏุงุฑุฏ:

- ุจูโุทูุฑ ุชุนุฑู ุดุฏูุ RSS ุดุงูู ููุงุฑุฏ ุจุดุชุฑ ุงุฒ ููุท ุงุณุชูุงุฏู ุงุฒ ุญุงูุธู ูพุดุชู Go ุงุณุชุ ูุงููุฏ ุญุงูุธู ุงุณุชูุงุฏู ุดุฏู ุชูุณุท ูพุดุชูโูุง ฺฏูุฑูุชูโูุงุ ูุงู ุงุฌุฑุง ุจุฑูุงููุ ฺฉุชุงุจุฎุงููโูุง ูุดุชุฑฺฉ ู ููฺูู ุญุงูุธู ุชุฎุตุต ุงูุชู ุชูุณุท ุชูุงุจุน C.
- GC (ุฌูุนโฺฉููุฏู ุฒุจุงูู) ููฺฉู ุงุณุช ุชุตูู ุจฺฏุฑุฏ ฺฉู ุญุงูุธู ุขุฒุงุฏ ุฑุง ููุฑุงู ุจู ุณุณุชูโุนุงูู ุจุงุฒูฺฏุฑุฏุงูุฏุ ุงูุง ุจุนุฏ ุงุฒ ุชุบุฑุงุช ุฒูุงูโุงุฌุฑุง ุฏุฑ [Go 1.16](https://golang.org/doc/go1.16#runtime) ุงู ููุถูุน ฺฉูุชุฑ ูุดฺฉูโุณุงุฒ ุดุฏู ุงุณุช.
- Go ุงุฒ GC ุบุฑูุชุญุฑฺฉ ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจูุงุจุฑุงู ุฏุฑ ุจุฑุฎ ููุงุฑุฏุ ุญุงูุธู ุขุฒุงุฏ ูพุดุชู ููฺฉู ุงุณุช ุจู ฺฏูููโุง ุชฺฉูโุชฺฉู ุดูุฏ ฺฉู ูุงูุน ุงุฒ ุจุงุฒฺฏุดุช ุขู ุจู ุณุณุชูโุนุงูู ุดูุฏ.


#### 4.25.2.2.4 ูพุงุฏูโุณุงุฒ ูพุฑููุงูุฑ ุญุงูุธู

ฺฉุฏ ุฒุฑ ุจุงุฏ ุฌูุจูโูุง ุงุณุงุณ ูพุงุฏูโุณุงุฒ ูพุฑููุงูุฑ ุญุงูุธู ุฑุง ูพูุดุด ุฏูุฏ ุชุง ุดูุง ุฏุฑฺฉ ุจูุชุฑ ุงุฒ ุขู ุฏุงุดุชู ุจุงุดุฏ. ููุงูุทูุฑ ฺฉู ูุดุงูุฏู ูโฺฉูุฏุ ุชุงุจุน `malloc()` ุฏุฑ ุฏุงุฎู ุฒูุงูโุงุฌุฑุง Go ุงุฒ ุชุงุจุน `poisson_sample(size)` ุจุฑุง ุชุนู ุงู ฺฉู ุขุง ุจุงุฏ ฺฉ ุชุฎุตุต ูููููโฺฏุฑ ุดูุฏ ุง ุฎุฑ ุงุณุชูุงุฏู ูโฺฉูุฏ. ุงฺฏุฑ ุฌูุงุจ ูุซุจุช ุจุงุดุฏุ ฺฉ ุฏูุจุงูู ูพุดุชู (stack trace) ุจู ูุงู `s` ฺฏุฑูุชู ูโุดูุฏ ู ุจู ุนููุงู ฺฉูุฏ ุฏุฑ `mem_profile` (ฺฉ ููุดู ูุด) ุงุณุชูุงุฏู ูโุดูุฏ ุชุง ุดูุงุฑูุฏูโูุง `allocs` ู `alloc_bytes` ุงูุฒุงุด ุงุจูุฏ. ุนูุงูู ุจุฑ ุงูุ ูุฑุงุฎูุงู `track_profiled(object, s)`ุ ุดุก ุชุฎุตุต ุงูุชู ุฑุง ุจู ุนููุงู ฺฉ ุชุฎุตุต ูููููโฺฏุฑ ุดุฏู ุฏุฑ ูพุดุชู ุนูุงูุชโฺฏุฐุงุฑ ูโฺฉูุฏ ู ุฏูุจุงูู ูพุดุชู `s` ุฑุง ุจุง ุขู ูุฑุชุจุท ูโุณุงุฒุฏ.

```go
func malloc(size):
  object = ... // allocation magic

  if poisson_sample(size):
    s = stacktrace()
    mem_profile[s].allocs++
    mem_profile[s].alloc_bytes += size
    track_profiled(object, s)

  return object
```

ููฺฏุงู ฺฉู GC (ุฌูุนโุขูุฑ ุฒุจุงููโูุง) ุชุนู ูโฺฉูุฏ ฺฉู ุฒูุงู ุขุฒุงุฏุณุงุฒ ฺฉ ุดุก ุชุฎุตุต ุงูุชู ูุฑุง ุฑุณุฏู ุงุณุชุ ุชุงุจุน `sweep()` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ ฺฉู ุงุฒ `is_profiled(object)` ุงุณุชูุงุฏู ูโฺฉูุฏ ุชุง ุจุฑุฑุณ ฺฉูุฏ ุขุง ุดุก ุจู ุนููุงู ฺฉ ุดุก ูููููโฺฏุฑ ุดุฏู ุนูุงูุชโฺฏุฐุงุฑ ุดุฏู ุงุณุช ุง ุฎุฑ. ุงฺฏุฑ ุฌูุงุจ ูุซุจุช ุจุงุดุฏุ ุฏูุจุงูู ูพุดุชู `s` ฺฉู ููุฌุฑ ุจู ุชุฎุตุต ุดุฏู ุจูุฏ ุจุงุฒุงุจ ูโุดูุฏ ู ุดูุงุฑูุฏูโูุง `frees` ู `free_bytes` ุจุฑุง ุขู ุฏุงุฎู `mem_profile` ุงูุฒุงุด ูโุงุจุฏ.

```go
func sweep(object):
  if is_profiled(object)
    s = alloc_stacktrace(object)
    mem_profile[s].frees++
    mem_profile[s].free_bytes += sizeof(object)

	// deallocation magic
```

ุดูุงุฑูุฏูโูุง `free_*` ุจูโุทูุฑ ูุณุชูู ุฏุฑ ูพุฑููุงู ููุง ุญุงูุธู ฺฏูุฌุงูุฏู ููโุดููุฏ. ุฏุฑ ุนูุถุ ุงุฒ ุขูโูุง ุจุฑุง ูุญุงุณุจู ุดูุงุฑูุฏูโูุง `inuse_*` ุฏุฑ ูพุฑููุงู ุงุฒ ุทุฑู ฺฉู ฺฉุฑุฏู ุณุงุฏูโ `frees` ุงุฒ `allocs` ุงุณุชูุงุฏู ูโุดูุฏ. ููฺููุ ููุงุฏุฑ ุฎุฑูุฌ ููุง ุจุง ุชูุณู ุขูโูุง ุจุฑ ุงุญุชูุงู ูููููโฺฏุฑ ููุงุณโุจูุฏ ูโุดููุฏ.

#### 4.25.2.2.5 ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ ุญุงูุธู

ฺูุฏู ูุดฺฉู ู ูุญุฏูุฏุช ุดูุงุฎุชูโุดุฏู ุจุฑุง ูพุฑููุงูุฑ ุญุงูุธู ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุจุงุฏ ุงุฒ ุขูโูุง ุขฺฏุงู ุจุงุดุฏ:

- ๐ [GH #49171](https://github.com/golang/go/issues/49171): ูพุฑููุงูโูุง ุฏูุชุง (ฺฉู ุจุง ูุซูุงู `GET /debug/pprof/allocs?seconds=60` ฺฏุฑูุชู ูโุดููุฏ) ููฺฉู ุงุณุช ุจู ุฏูู ฺฉ ุจุงฺฏ ุฏุฑ ููโููุงุฏุณุงุฒ ูุฑุชุจุท ุจุง closures ุฏุงุฎู ุฏุฑ Go 1.17 ุดูุงุฑุด ุชุฎุตุต ููู ุฑุง ฺฏุฒุงุฑุด ฺฉููุฏ. ุงู ูุดฺฉู ุฏุฑ Go 1.18 ุฑูุน ุดุฏู ุงุณุช.
- โ๏ธ [`runtime.MemProfileRate`](https://pkg.go.dev/runtime#MemProfileRate) ุจุงุฏ ููุท ฺฉ ุจุงุฑ ู ุฏุฑ ุงุณุฑุน ููุช ุฏุฑ ุงุจุชุฏุง ุงุฌุฑุง ุจุฑูุงูู ุชุบุฑ ุฏุงุฏู ุดูุฏุ ุจุฑุง ูุซุงู ุฏุฑ ุงุจุชุฏุง ุชุงุจุน `main()`. ุชุบุฑ ุงู ููุฏุงุฑ ุจูโุตูุฑุช ฺูุฏุจุงุฑู ุฏุฑ ุทูู ุงุฌุฑุง ุจุฑูุงูู ุจุงุนุซ ุชููุฏ ูพุฑููุงูโูุง ูุงุฏุฑุณุช ุฎูุงูุฏ ุดุฏ.
- โ ููฺฏุงู ุนุจโุงุจ ูุดุชโูุง ุญุงูุธู ุงุญุชูุงูุ ูพุฑููุงูุฑ ุญุงูุธู ูโุชูุงูุฏ ูุดุงู ุฏูุฏ ฺฉู ุงู ุชุฎุตุตโูุง ฺฉุฌุง ุงุฌุงุฏ ุดุฏูโุงูุฏุ ุงูุง ููโุชูุงูุฏ ูุดุงู ุฏูุฏ ฺฉู ฺฉุฏุงู ูุฑุงุฌุน ุจุงุนุซ ุฒูุฏู ูฺฏูโุฏุงุดุชู ุขูโูุง ูุณุชูุฏ. ฺูุฏู ุชูุงุด ุจุฑุง ุญู ุงู ูุดฺฉู ุงูุฌุงู ุดุฏู ุงุณุชุ ุงูุง ูฺโฺฉุฏุงู ุจุง ูุณุฎูโูุง ุงุฎุฑ Go ฺฉุงุฑ ููโฺฉููุฏ.
- โ [ุจุฑฺุณุจโูุง ูพุฑููุงูุฑ CPU](#425211-ุจุฑฺุณุจูุง-ูพุฑููุงูุฑ-profiler-labels-cpu) ุง ูุดุงุจู ุขู ุชูุณุท ูพุฑููุงูุฑ ุญุงูุธู ูพุดุชุจุงู ููโุดููุฏ. ุงุถุงูู ฺฉุฑุฏู ุงู ูฺฺฏ ุจู ูพุงุฏูโุณุงุฒ ูุนู ุณุฎุช ุงุณุช ุฒุฑุง ูโุชูุงูุฏ ููุฌุฑ ุจู ูุดุช ุญุงูุธู ุฏุฑ ุฌุฏูู ูุด ุฏุงุฎู ุฏุงุฏูโูุง ูพุฑููุงู ุญุงูุธู ุดูุฏ.
- โ ุชุฎุตุตโูุง ุงูุฌุงู ุดุฏู ุชูุณุท ฺฉุฏ C (cgo) ุฏุฑ ูพุฑููุงู ุญุงูุธู ููุงุด ุฏุงุฏู ููโุดููุฏ.
- โ ุฏุงุฏูโูุง ูพุฑููุงู ุญุงูุธู ููฺฉู ุงุณุช ุชุง ุฏู ฺุฑุฎูโ ุฌูุนโุขูุฑ ุฒุจุงูู ูุฏู ุจุงุดูุฏ. ุงฺฏุฑ ูุงุฒ ุจู ฺฉ ุนฺฉุณ ููุฑ ูุฏุงูู ุฏุงุฑุฏุ ูโุชูุงูุฏ ูุจู ุงุฒ ุฏุฑุฎูุงุณุช ูพุฑููุงู ุญุงูุธูุ `runtime.GC()` ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ. [net/http/pprof](https://pkg.go.dev/net/http/pprof) ุงุฒ ุขุฑฺฏููุงู `?gc=1` ุจุฑุง ุงู ููุธูุฑ ูพุดุชุจุงู ูโฺฉูุฏ.
- โ ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ุชูุงุจุน ุชู ุฏุฑ ุชู ฺฉู ุชูุณุท ูพุฑููุงูุฑ ุญุงูุธู ุฏุฑ ุงุซุฑ ูุฑุงุฎูุงู ุซุจุช ูโุดููุฏุ ุฏุฑ ุญุงู ุญุงุถุฑ [`32`](https://sourcegraph.com/search?q=context:global+repo:github.com/golang/go+file:src/*+maxStack+%3D&patternType=literal) ุงุณุช. ุจุฑุง ุงุทูุงุนุงุช ุจุดุชุฑ ุฏุฑ ููุฑุฏ ุงู ูุญุฏูุฏุชุ ุจู [ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ CPU](#425214-ูุญุฏูุฏุชูุง-ูพุฑููุงูุฑ-cpu) ูุฑุงุฌุนู ฺฉูุฏ.
- โ ูฺ ูุญุฏูุฏุช ุจุฑุง ุงูุฏุงุฒูโ ุฌุฏูู ูุด ุฏุงุฎู ฺฉู ูพุฑููุงู ุญุงูุธู ุฑุง ูฺฏูโ ูโุฏุงุฑุฏ ูุฌูุฏ ูุฏุงุฑุฏ. ุงู ุฌุฏูู ุชุง ุฒูุงู ฺฉู ุชูุงู ูุณุฑูุง ุชุฎุตุต ฺฉุฏ ุดูุง ุฑุง ูพูุดุด ุฏูุฏุ ุจุฒุฑฺฏ ูโุดูุฏ. ุงู ูุณุฆูู ุฏุฑ ุนูู ูุดฺฉูโุณุงุฒ ูุณุช ุงูุง ููฺฉู ุงุณุช ุจูโูุธุฑ ุจุฑุณุฏ ฺฉู ูุงููุฏ ฺฉ ูุดุช ุญุงูุธู ฺฉูฺฺฉ ุงุณุช ุงฺฏุฑ ุงุฒ ูุฒุงู ุงุณุชูุงุฏู ุญุงูุธู ูุฑุขูุฏ ุฎูุฏ ูุธุงุฑุช ฺฉูุฏ.


### 4.25.2.3 ูพุฑููุงูุฑ ุจูุงฺฉ

ูพุฑููุงูุฑ ุจูุงฺฉ ุฏุฑ Go ุงูุฏุงุฒูโฺฏุฑ ูโฺฉูุฏ ฺฉู ฺูุฏุฑ ุฒูุงู ฺฏูุฑูุชูโูุง ุดูุง ุฏุฑ ุญุงูุช Off-CPU ุตุฑู ูโุดูุฏุ ุฏุฑ ุญุงู ฺฉู ููุชุธุฑ ุนููุงุช ฺฉุงูุงู ู mutexูุง ุงุฑุงุฆูโุดุฏู ุชูุณุท ูพฺฉุฌ [sync](https://pkg.go.dev/sync) ูุณุชูุฏ. ุนููุงุชโูุง Go ุฒุฑ ุชูุณุท ูพุฑููุงูุฑ ุจูุงฺฉ ฺฉูุชุฑู ูโุดููุฏ:

- [select](https://github.com/golang/go/blob/go1.15.7/src/runtime/select.go#L511)
- [chan send](https://github.com/golang/go/blob/go1.15.7/src/runtime/chan.go#L279)
- [chan receive](https://github.com/golang/go/blob/go1.15.7/src/runtime/chan.go#L586)
- [semacquire](https://github.com/golang/go/blob/go1.15.7/src/runtime/sema.go#L150) (ูุซู [`Mutex.Lock`](https://golang.org/pkg/sync/#Mutex.Lock)ุ [`RWMutex.RLock`](https://golang.org/pkg/sync/#RWMutex.RLock)ุ [`RWMutex.Lock`](https://golang.org/pkg/sync/#RWMutex.Lock)ุ [`WaitGroup.Wait`](https://golang.org/pkg/sync/#WaitGroup.Wait))
- [notifyListWait](https://github.com/golang/go/blob/go1.15.7/src/runtime/sema.go#L515) (ูุซู [`Cond.Wait`](https://golang.org/pkg/sync/#Cond.Wait))

โ๏ธ ูพุฑููุงูโูุง ุจูุงฺฉ ุดุงูู ุฒูุงู ุงูุชุธุงุฑ ุฑู I/Oุ ุฎูุงุจ (Sleep)ุ GC ู ุณุงุฑ ุญุงูุงุช ุงูุชุธุงุฑ ูุณุชูุฏ. ููฺูู ุฑูุฏุงุฏูุง ูุณุฏูุฏ ฺฉููุฏู ุชุง ุฒูุงู ฺฉู ฺฉุงูู ูุดููุฏ ุซุจุช ููโุดููุฏุ ุจูุงุจุฑุงู ูพุฑููุงู ุจูุงฺฉ ููโุชูุงูุฏ ุจุฑุง ุงุดฺฉุงูโุฒุฏุง ุงุฒ ุงูฺฉู ฺุฑุง ฺฉ ุจุฑูุงูู Go ุฏุฑ ุญุงู ุญุงุถุฑ ููู ฺฉุฑุฏู ุงุณุชูุงุฏู ุดูุฏ. ุจุฑุง ุงู ููุธูุฑุ ุงุฒ ูพุฑููุงูุฑ ฺฏูุฑูุชู ูโุชูุงู ุงุณุชูุงุฏู ฺฉุฑุฏ.

#### 4.25.2.3.1 ฺฉูุชุฑู ูพุฑููุงูุฑ ุจูุงฺฉ ุจุง APIโูุง ูุฎุชูู:

- ุฏุณุชูุฑ `go test -blockprofile block.pprof` ุชุณุชโูุง ุฑุง ุงุฌุฑุง ฺฉุฑุฏู ู ูพุฑููุงู ุงุฒ ูุฑ ุฑูุฏุงุฏ ูุณุฏูุฏฺฉููุฏู ุฏุฑ ูุงู ุจู ูุงู `block.pprof` ุฐุฎุฑู ูโฺฉูุฏ.
- ุชุงุจุน [`runtime.SetBlockProfileRate(rate)`](https://pkg.go.dev/runtime#SetBlockProfileRate) ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ ูุฑุฎ ูููููโฺฏุฑ ูพุฑููุงูุฑ ุจูุงฺฉ ุฑุง ฺฉูุชุฑู ฺฉูุฏ.
- ุฏุณุชูุฑ [`pprof.Lookup("block").WriteTo(w, 0)`](https://pkg.go.dev/runtime/pprof#Lookup) ูพุฑููุงู ุงุฒ ุฑูุฏุงุฏูุง ูุณุฏูุฏฺฉููุฏู ุงุฒ ุงุจุชุฏุง ูุฑุขูุฏ ุชุง ฺฉููู ุงุฌุงุฏ ูโฺฉูุฏ ู ุฏุฑ ุฎุฑูุฌ `w` ูโููุณุฏ.
- ุฏุณุชูุฑ [`import _ "net/http/pprof"`](https://pkg.go.dev/net/http/pprof) ุงุฌุงุฒู ูโุฏูุฏ ุชุง ุจุง ุงุณุชูุงุฏู ุงุฒ ุฏุฑุฎูุงุณุช `GET /debug/pprof/block?seconds=30` ฺฉ ูพุฑููุงู ุจูุงฺฉ 30 ุซุงููโุง ุฏุฑุฎูุงุณุช ฺฉูุฏ.

#### 4.25.2.3.2 ฺฉุฏ ููููู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ูพุฑููุงูุฑ ุจูุงฺฉ ุฏุฑ ุจุฑูุงูู:

```go
runtime.SetBlockProfileRate(100_000_000) // ูุดุฏุงุฑ: ูโุชูุงูุฏ ุจุงุนุซ ุงูุฒุงุด ุงุณุชูุงุฏู ุงุฒ CPU ุดูุฏ
file, _ := os.Create("./block.pprof")
defer pprof.Lookup("block").WriteTo(file, 0)
```

ุตุฑูโูุธุฑ ุงุฒ ูุญูู ูุนุงู ฺฉุฑุฏู ูพุฑููุงูุฑ ุจูุงฺฉุ ูพุฑููุงู ููุง ฺฉ ุฌุฏูู ุงุฒ ุฑุฏูพุงูุง ูพุดุชู ุฎูุงูุฏ ุจูุฏ ฺฉู ุฏุฑ ูุฑูุช ุจุงูุฑ **pprof** ูุฑูุช ุดุฏู ุงุณุช.

|stack trace|contentions/count|delay/nanoseconds|
|-|-|-|
|main;foo;runtime.selectgo|5|867549417|
|main;foo;bar;sync.(*Mutex).Lock|3|453510869|
|main;foobar;runtime.chanrecv1|4|5351086|

#### 4.25.2.3.3 ูพุงุฏูโุณุงุฒ ูพุฑููุงูุฑ ุจูุงฺฉ

ฺฉุฏ ุดุจู ุฒุฑ ุฌูุจูโูุง ุงุณุงุณ ุงุฒ ูพุงุฏูโุณุงุฒ ูพุฑููุงูุฑ ุจูุงฺฉ ุฑุง ูุดุงู ูโุฏูุฏ ุชุง ุฏุฑฺฉ ุจูุชุฑ ุงุฒ ุขู ุจู ุดูุง ุจุฏูุฏ. ููฺฏุงู ุงุฑุณุงู ูพุงู ุจู ฺฉ ฺฉุงูุงูุ ุนู `ch <- msg`ุ Go ุชุงุจุน `chansend()` ุฑุง ุฏุฑ runtime ูุฑุงุฎูุงู ูโฺฉูุฏ. ุงฺฏุฑ ฺฉุงูุงู ุจุฑุง ุฏุฑุงูุช ูพุงู ุขูุงุฏู ุจุงุดุฏ (`ready()`)ุ ุนููุงุช `send()` ุจูุงูุงุตูู ุงูุฌุงู ูโุดูุฏ. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ูพุฑููุงูุฑ ุจูุงฺฉ ุฒูุงู ุดุฑูุน ุฑูุฏุงุฏ ูุณุฏูุฏฺฉููุฏู ุฑุง ุซุจุช ูโฺฉูุฏ ู ุงุฒ ุชุงุจุน `wait_until_ready()` ุงุณุชูุงุฏู ูโฺฉูุฏ ุชุง ฺฏูุฑูุชู ุงุฒ CPU ุฎุงุฑุฌ ุดูุฏ ุชุง ุฒูุงู ฺฉู ฺฉุงูุงู ุขูุงุฏู ุดูุฏ. ููฺฏุงู ฺฉู ฺฉุงูุงู ุขูุงุฏู ุดุฏุ ูุฏุช ุฒูุงู ูุณุฏูุฏ ุดุฏู ุชุนู ูโุดูุฏ ู ุจุง ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน `random_sample()` ู ูุฑุฎ ูููููโฺฏุฑุ ุจุฑุฑุณ ูโุดูุฏ ฺฉู ุขุง ุจุงุฏ ุงู ุฑูุฏุงุฏ ูุณุฏูุฏฺฉููุฏู ุซุจุช ุดูุฏ ุง ุฎุฑ. ุฏุฑ ุตูุฑุช ูุซุจุช ุจูุฏู ูพุงุณุฎุ ุฑุฏูพุง ูพุดุชู ูุนู (`stack trace`) ฺฏุฑูุชู ุดุฏู ู ุจู ุนููุงู ฺฉูุฏ ุฏุฑูู ููุดู ูุด `block_profile` ุงุณุชูุงุฏู ูโุดูุฏ ุชุง ุดูุงุฑูุฏูโูุง `count` ู `delay` ุงูุฒุงุด ุงุจูุฏ. ูพุณ ุงุฒ ุขูุ ุนููุงุช `send()` ุงุฏุงูู ูโุงุจุฏ.

```go
func chansend(channel, msg):
  if ready(channel):
    send(channel, msg)
    return

  start = now()
  wait_until_ready(channel) // Off-CPU Wait
  duration = now() - start

  if random_sample(duration, rate):
    s = stacktrace()
    // note: actual implementation is a bit trickier to correct for bias
    block_profile[s].contentions += 1
    block_profile[s].delay += duration

  send(channel, msg)
```

ุชุงุจุน `random_sample` ุจู ุงู ุตูุฑุช ุนูู ูโฺฉูุฏ. ุงฺฏุฑ ูพุฑููุงูุฑ ุจูุงฺฉ ูุนุงู ุจุงุดุฏุ ููู ุฑูุฏุงุฏูุง ฺฉู `duration >= rate` ุจุงุดูุฏ ุซุจุช ูโุดููุฏ ู ุฑูุฏุงุฏูุง ฺฉูุชุงูโุชุฑ ุจุง ุงุญุชูุงู `duration/rate` ุซุจุช ูโุดููุฏ.

```go
func random_sample(duration, rate):
  if rate <= 0 || (duration < rate && duration/rate > rand(0, 1)):
    return false
  return true
```

ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ุงฺฏุฑ ูุฑุฎ (`rate`) ุฑุง ุจุฑุงุจุฑ `10,000` ุชูุธู ฺฉูุฏ (ูุงุญุฏ ุฏุฑ ุงูุฌุง ูุงููุซุงูู ุงุณุช)ุ ููู ุฑูุฏุงุฏูุง ูุณุฏูุฏฺฉููุฏูโุง ฺฉู `10 ยตsec` ุง ุจุดุชุฑ ุทูู ูโฺฉุดูุฏ ุซุจุช ูโุดููุฏ. ุนูุงูู ุจุฑ ุงูุ `10%` ุงุฒ ุฑูุฏุงุฏูุง ุจุง ุทูู `1 ยตsec` ู `1%` ุงุฒ ุฑูุฏุงุฏูุง ุจุง ุทูู `100 ูุงููุซุงูู` ู... ูุฒ ุซุจุช ูโุดููุฏ.

#### 4.25.2.3.4 ุชูุงูุช ูพุฑููุงูุฑ ุจูุงฺฉ ู ูพุฑููุงูุฑ Mutex

ูุฑ ุฏู ูพุฑููุงูุฑ ุจูุงฺฉ ู mutex ุฒูุงู ุงูุชุธุงุฑ ุฑู mutexูุง ุฑุง ฺฏุฒุงุฑุด ูโุฏููุฏ. ุชูุงูุช ุงู ุงุณุช ฺฉู ูพุฑููุงูุฑ ุจูุงฺฉ ุฒูุงู ุงูุชุธุงุฑ ุจุฑุง ุจู ุฏุณุช ุขูุฑุฏู `Lock()` ุฑุง ุซุจุช ูโฺฉูุฏุ ุฏุฑ ุญุงู ฺฉู ูพุฑููุงูุฑ mutex ุฒูุงู ฺฉู ฺฏูุฑูุชู ุฏฺฏุฑ ููุชุธุฑ `Unlock()` ุงุณุช ุชุง ุงุฌุฑุง ุดูุฏ ุฑุง ุซุจุช ูโฺฉูุฏ.

#### 4.25.2.3.5 ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ ุจูุงฺฉ

- ๐จ ูพุฑููุงูุฑ ุจูุงฺฉ ูโุชูุงูุฏ ุจุงุนุซ ุงูุฒุงุด ูุงุจู ุชูุฌู ูุตุฑู CPU ุฏุฑ ูุญุท ุชููุฏ ุดูุฏ. ุชูุตู ูโุดูุฏ ฺฉู ุชููุง ุจุฑุง ุชูุณุนู ู ุชุณุช ุงุณุชูุงุฏู ุดูุฏ. ุงฺฏุฑ ูุงุฒ ุจู ุงุณุชูุงุฏู ุงุฒ ุขู ุฏุฑ ูุญุท ุชููุฏ ุฏุงุฑุฏุ ุจุง ูุฑุฎ ุจุณุงุฑ ุจุงูุง ุดุฑูุน ฺฉูุฏุ ูุซูุงู 100 ููููุ ู ุชููุง ุฏุฑ ุตูุฑุช ูุงุฒ ุขู ุฑุง ฺฉุงูุด ุฏูุฏ.
- โ ูพุฑููุงูโูุง ุจูุงฺฉ ุชููุง ุดุงูู ุฒุฑ ูุฌููุนู ฺฉูฺฺฉ ุงุฒ ุญุงูุงุช ุงูุชุธุงุฑ Off-CPU ูุณุชูุฏ ฺฉู ฺฉ ฺฏูุฑูุชู ูโุชูุงูุฏ ูุงุฑุฏ ุขูโูุง ุดูุฏ.
- โ ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ุชูุงุจุน ุชู ุฏุฑ ุชู ฺฉู ูโุชูุงููุฏ ุฏุฑ ุฑุฏูพุงูุง ูพุดุชู ุชูุณุท ูพุฑููุงูุฑ ุจูุงฺฉ ุซุจุช ุดููุฏุ ูุนูุงู ุจุฑุงุจุฑ [`32`](https://sourcegraph.com/search?q=context:global+repo:github.com/golang/go+file:src/*+maxStack+%3D&patternType=literal) ุงุณุช.
- โ ููุดู ูุด ุฏุงุฎู ฺฉู ูพุฑููุงู ุจูุงฺฉ ุฑุง ูฺฏู ูโุฏุงุฑุฏ ูฺ ูุญุฏูุฏุช ุฏุฑ ุงูุฏุงุฒู ูุฏุงุฑุฏ.


### 4.25.2.4 ูพุฑููุงูุฑ Mutex

ูพุฑููุงูุฑ mutex ุฒูุงู ุฑุง ุงูุฏุงุฒูโฺฏุฑ ูโฺฉูุฏ ฺฉู ฺฏูุฑูุชูโูุง ุตุฑู ูุณุฏูุฏ ฺฉุฑุฏู ุณุงุฑ ฺฏูุฑูุชูโูุง ูโฺฉููุฏ. ุจู ุนุจุงุฑุชุ ุงู ูพุฑููุงูุฑ ููุงุจุน ุฑูุงุจุช ุจุฑุง ูููโูุง ุฑุง ุซุจุช ูโฺฉูุฏ. ูพุฑููุงูุฑ mutex ูโุชูุงูุฏ ุฑูุงุจุช ูุงุด ุงุฒ `sync.Mutex` ู `sync.RWMutex` ุฑุง ุซุจุช ฺฉูุฏ.

โ๏ธ ูพุฑููุงูโูุง mutex ุดุงูู ุณุงุฑ ููุงุจุน ุฑูุงุจุช ูุซู `sync.WaitGroup`ุ `sync.Cond` ุง ุฏุณุชุฑุณ ุจู ุชูุตูโฺฉููุฏูโูุง ูุงู ููโุดููุฏ. ููฺููุ ุฑูุงุจุช mutex ุชุง ุฒูุงู ฺฉู mutex ุขุฒุงุฏ ูุดูุฏุ ุซุจุช ููโุดูุฏ. ุจูุงุจุฑุงูุ ูพุฑููุงู mutex ุจุฑุง ุงุดฺฉุงูโุฒุฏุง ุงุฒ ุฏูู ูุนูู ุจูุฏู ุจุฑูุงูู Go ูุงุจู ุงุณุชูุงุฏู ูุณุชุ ุจุฑุง ุงู ฺฉุงุฑ ูโุชูุงูุฏ ุงุฒ ูพุฑููุงูุฑ ฺฏูุฑูุชู ุงุณุชูุงุฏู ฺฉูุฏ.

#### 4.25.2.4.1 ฺฉูุชุฑู ูพุฑููุงูุฑ Mutex

ฺูุฏู API ุจุฑุง ฺฉูุชุฑู ูพุฑููุงูุฑ mutex ุฏุฑ ุฏุณุชุฑุณ ุงุณุช:

- `go test -mutexprofile mutex.pprof` ุชุณุชโูุง ุฑุง ุงุฌุฑุง ูโฺฉูุฏ ู ูพุฑููุงู mutex ุฑุง ุฏุฑ ฺฉ ูุงู ุจุง ูุงู `mutex.pprof` ูโููุณุฏ.
- [`runtime.SetMutexProfileRate(rate)`](https://pkg.go.dev/runtime#SetMutexProfileRate) ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ูุฑุฎ ูููููโฺฏุฑ ูพุฑููุงูุฑ mutex ุฑุง ูุนุงู ู ฺฉูุชุฑู ฺฉูุฏ. ุงฺฏุฑ ูุฑุฎ ูููููโฺฏุฑ ุจุฑุงุจุฑ ุจุง `R` ุชูุธู ุดูุฏุ ุจู ุทูุฑ ูุชูุณุท `1/R` ุงุฒ ุฑูุฏุงุฏูุง ุฑูุงุจุช mutex ุซุจุช ูโุดููุฏ. ุงฺฏุฑ ูุฑุฎ ุจุฑุงุจุฑ 0 ุง ฺฉูุชุฑ ุจุงุดุฏุ ูฺ ุฑูุฏุงุฏ ุซุจุช ููโุดูุฏ.
- [`pprof.Lookup("mutex").WriteTo(w, 0)`](https://pkg.go.dev/runtime/pprof#Lookup) ูพุฑููุงู mutex ุฑุง ุงุฒ ุดุฑูุน ูพุฑุฏุงุฒุด ุชุง ุฒูุงู ููุดุชู ุจู `w` ุซุจุช ูโฺฉูุฏ.
- [`import _ "net/http/pprof"`](https://pkg.go.dev/net/http/pprof) ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ุจุง ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู ูุณุฑ `GET /debug/pprof/mutex?seconds=30` ฺฉ ูพุฑููุงู 30 ุซุงููโุง ุงุฒ mutexโูุง ุฏุฑุงูุช ฺฉูุฏ.

#### 4.25.2.4.2 ููููู ุณุฑุน ุงุณุชูุงุฏู ุงุฒ ูพุฑููุงูุฑ Mutex

ุงฺฏุฑ ูุงุฒ ุจู ฺฉุฏ ุณุฑุน ุจุฑุง ูุฑุงุฑ ุฏุงุฏู ุฏุฑ ุชุงุจุน `main()` ุฏุงุฑุฏุ ูโุชูุงูุฏ ุงุฒ ฺฉุฏ ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

```go
runtime.SetMutexProfileFraction(100)
file, _ := os.Create("./mutex.pprof")
defer pprof.Lookup("mutex").WriteTo(file, 0)
```

ูพุฑููุงู mutex ุจู ุฏุณุช ุขูุฏู ุฏุฑ ุงุตู ุฌุฏูู ุงุฒ ุฑุฏูพุง ูพุดุชูโูุง (`stack traces`) ุฎูุงูุฏ ุจูุฏ ฺฉู ุจู ุตูุฑุช ูุฑูุช ุฏูุฏู pprof ุฐุฎุฑู ูโุดูุฏ.

|stack trace|contentions/count|delay/nanoseconds|
|-|-|-|
|main;foo;sync.(*Mutex).Unlock|5|867549417|
|main;bar;baz;sync.(*Mutex).Unlock|3|453510869|
|main;foobar;sync.(*RWMutex).RUnlock|4|5351086|

#### 4.25.2.4.3 ุชูุงูุช ูพุฑููุงูโูุง Block ู Mutex

ูพุฑููุงูโูุง block ู mutex ูุฑ ุฏู ุฒูุงู ุงูุชุธุงุฑ ุฑู mutexโูุง ุฑุง ุซุจุช ูโฺฉููุฏุ ุงูุง ุชูุงูุช ุฏุฑ ุงู ุงุณุช ฺฉู ูพุฑููุงู block ุฒูุงู ฺฉู ฺฏูุฑูุชู ุฏุฑ ุญุงู ุงูุชุธุงุฑ ุจุฑุง ููู ุดุฏู ุงุณุช ุฑุง ุซุจุช ูโฺฉูุฏุ ุฏุฑ ุญุงู ฺฉู ูพุฑููุงู mutex ุฒูุงู ฺฉู ฺฉ ฺฏูุฑูุชู ููู ุฑุง ุฏุฑ ุงุฎุชุงุฑ ุฏุงุฑุฏ ู ุจุงุนุซ ุฌููฺฏุฑ ุงุฒ ุงุฏุงูู ฺฉุงุฑ ุณุงุฑ ฺฏูุฑูุชูโูุง ูโุดูุฏุ ุฑุง ุซุจุช ูโฺฉูุฏ.

#### 4.25.2.4.4 ูพุงุฏูโุณุงุฒ ูพุฑููุงูุฑ Mutex

ูพุฑููุงูุฑ mutex ุจุง ุซุจุช ุฒูุงู ฺฉู ฺฉ ฺฏูุฑูุชู ุชูุงุด ูโฺฉูุฏ ููู ุฑุง ุจฺฏุฑุฏ (ูุซูุงู `mu.Lock()`)ุ ุชุง ุฒูุงู ฺฉู ฺฏูุฑูุชู ุตุงุญุจ ููู ุขู ุฑุง ุขุฒุงุฏ ฺฉูุฏ (ูุซูุงู `mu.Unlock()`)ุ ฺฉุงุฑ ูโฺฉูุฏ. ุงุจุชุฏุง ฺฉ ฺฏูุฑูุชู `semacquire()` ุฑุง ุจุฑุง ฺฏุฑูุชู ููู ูุฑุงุฎูุงู ูโฺฉูุฏ ู ุงฺฏุฑ ููู ุฏุฑ ุญุงู ุญุงุถุฑ ุชูุณุท ฺฏูุฑูุชู ุฏฺฏุฑ ฺฏุฑูุชู ุดุฏู ุจุงุดุฏุ ุฒูุงู ุดุฑูุน ุงูุชุธุงุฑ ุซุจุช ูโุดูุฏ. ููุช ฺฏูุฑูุชู ุตุงุญุจ ููู ุขู ุฑุง ุจุง ูุฑุงุฎูุงู `semrelease()` ุขุฒุงุฏ ูโฺฉูุฏุ ฺฏูุฑูุชู ููุชุธุฑ ุจุฑุฑุณ ูโุดูุฏ ู ุฒูุงู ุงูุชุธุงุฑ ุขู ูุญุงุณุจู ูโฺฏุฑุฏุฏ. ุฏุฑ ููุงุชุ ุงฺฏุฑ ุฑูุฏุงุฏ ุจู ุตูุฑุช ุชุตุงุฏู ุจุฑุง ุซุจุช ุงูุชุฎุงุจ ุดูุฏุ ุฒูุงู ูุณุฏูุฏ ุจู ฺฉ ููุดู ูุด (`hash map`) ุงุถุงูู ูโุดูุฏ ฺฉู ฺฉูุฏ ุขู ูพุดุชู ูุฑุงุฎูุงู ฺฏูุฑูุชู ุขุฒุงุฏฺฉููุฏู ููู ุงุณุช.

#### 4.25.2.4.5 ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ Mutex

- โ๏ธ ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ูุฑุงุฎูุงูโูุง ุชู ุฏุฑ ุชู ฺฉู ูโุชูุงู ุฏุฑ ูพุดุชู ูุฑุงุฎูุงูโูุง ูพุฑููุงู mutex ุซุจุช ฺฉุฑุฏุ ุฏุฑ ุญุงู ุญุงุถุฑ [`32`](https://sourcegraph.com/search?q=context:global+repo:github.com/golang/go+file:src/*+maxStack+%3D&patternType=literal) ุงุณุช. ุจุฑุง ุงุทูุงุนุงุช ุจุดุชุฑ ุฏุฑุจุงุฑู ูุญุฏูุฏุชโูุง ูพุฑููุงูุฑ CPUุ ุจู ูุณุชูุฏุงุช ูุฑุชุจุท ูุฑุงุฌุนู ฺฉูุฏ.
- โ๏ธ ูฺ ูุญุฏูุฏุช ุจุฑุง ุงูุฏุงุฒู ููุดู ูุด ุฏุงุฎู ฺฉู ุฏุงุฏูโูุง ูพุฑููุงู mutex ุฑุง ูฺฏู ูโุฏุงุฑุฏ ูุฌูุฏ ูุฏุงุฑุฏ. ุงู ุจุฏุงู ูุนูุงุณุช ฺฉู ุงูุฏุงุฒู ุขู ุชุง ุฒูุงู ฺฉู ุชูุงู ูุณุฑูุง ูุณุฏูุฏฺฉููุฏู ุฏุฑ ฺฉุฏ ุดูุง ูพูุดุด ุฏุงุฏู ุดููุฏุ ุฑุดุฏ ุฎูุงูุฏ ฺฉุฑุฏ. ุฏุฑ ุนููุ ุงู ูุดฺฉู ฺูุฏุงู ุงุฌุงุฏ ููโฺฉูุฏุ ุงูุง ููฺฉู ุงุณุช ุจู ุนููุงู ฺฉ ูุดุช ุญุงูุธู ฺฉูฺฺฉ ุจู ูุธุฑ ุจุฑุณุฏ.
- โ๏ธ ุจุฑฺุณุจโูุง ูพุฑููุงูุฑ CPU ุฏุฑ ูพุฑููุงู mutex ูพุดุชุจุงู ููโุดููุฏ. ุงุถุงูู ฺฉุฑุฏู ุงู ูฺฺฏ ุจู ูพุงุฏูโุณุงุฒ ูุนู ููฺฉู ุงุณุช ุจุงุนุซ ุงุฌุงุฏ ูุดุช ุญุงูุธู ุฏุฑ ููุดู ูุด ุฏุงุฎู ฺฉู ุฏุงุฏูโูุง ูพุฑููุงู ุญุงูุธู ุฑุง ูฺฏู ูโุฏุงุฑุฏุ ุดูุฏ.
- โ๏ธ ุชุนุฏุงุฏ ุฑูุงุจุชโูุง ู ุฒูุงูโูุง ุชุฃุฎุฑ ุฏุฑ ฺฉ ูพุฑููุงู mutex ุจุฑ ุงุณุงุณ **ุขุฎุฑู** ูุฑุฎ ูููููโุจุฑุฏุงุฑ ุชูุธู ุดุฏูุ ุชูุธู ูโุดููุฏุ ูู ุฏุฑ ุฒูุงู ูููููโุจุฑุฏุงุฑ. ุฏุฑ ูุชุฌูุ ุจุฑูุงููโูุง ฺฉู ูุฑุฎ ูููููโุจุฑุฏุงุฑ ูพุฑููุงู mutex ุฑุง ุฏุฑ ูุงูู ุงุฌุฑุง ุฎูุฏ ุชุบุฑ ูโุฏููุฏุ ููฺฉู ุงุณุช ูุชุงุฌ ูุงุฏูู ุฑุง ูุดุงูุฏู ฺฉููุฏ.

### 4.25.2.5 ูพุฑููุงูุฑ Goroutine

ุฏุฑ ุฒูุงู ุงุฌุฑุง Goุ ุชูุงู ฺฏูุฑูุชูโูุง ุฏุฑ ฺฉ ุขุฑุงู ุณุงุฏู ุจู ูุงู [allgs](https://github.com/golang/go/blob/3a778ff50f7091b8a64875c8ed95bfaacf3d334c/src/runtime/proc.go#L500) ูฺฏูุฏุงุฑ ูโุดููุฏ. ุงู ุขุฑุงู ุดุงูู ฺฏูุฑูุชูโูุง ูุนุงู ู ุบุฑูุนุงู (ูุฑุฏู) ุงุณุช. ฺฏูุฑูุชูโูุง ูุฑุฏู ุจุฑุง ุงุณุชูุงุฏู ูุฌุฏุฏ ุฒูุงู ฺฉู ฺฏูุฑูุชูโูุง ุฌุฏุฏ ุงุฌุงุฏ ูโุดููุฏุ ูฺฏู ุฏุงุดุชู ูโุดููุฏ.

Go ุฏุงุฑุง APIโูุง ูุฎุชูู ุจุฑุง ุจุฑุฑุณ ฺฏูุฑูุชูโูุง ูุนุงู ุฏุฑ `allgs` ุงุณุช ฺฉู ุจู ููุฑุงู ุงุณุชฺฉ ุชุฑูุณ ู ุจุฑุฎ ุฏฺฏุฑ ุงุฒ ูฺฺฏโูุง ุขููุง ุงุทูุงุนุงุช ุงุฑุงุฆู ูโุฏููุฏ. ุจุฑุฎ ุงุฒ ุงู APIโูุง ุงุทูุงุนุงุช ุขูุงุฑ ุงุฑุงุฆู ูโุฏููุฏุ ุฏุฑ ุญุงู ฺฉู ุจุฑุฎ ุฏฺฏุฑ ุงุทูุงุนุงุช ูุฑุจูุท ุจู ูุฑ ฺฏูุฑูุชู ุฑุง ุจู ุตูุฑุช ุฌุฏุงฺฏุงูู ูุฑุงูู ูโฺฉููุฏ.

ุนูุฑุบู ุชูุงูุชโูุง ุจู ุงู APIโูุงุ ุชุนุฑู [ูุดุชุฑฺฉ](https://github.com/golang/go/blob/9b955d2d3fcff6a5bc8bce7bafdc4c634a28e95b/src/runtime/mprof.go#L729) ุงุฒ ฺฏูุฑูุชู "ูุนุงู" ุจู ูุธุฑ ูโุฑุณุฏ ฺฉู ุดุงูู ููุงุฑุฏ ุฒุฑ ุจุงุดุฏ:

- ฺฏูุฑูุชู [ุงุฒ ุจู ุฑูุชู](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L65-L71) ูุจุงุดุฏ.
- ฺฏูุฑูุชู [ุณุณุชู](https://github.com/golang/go/blob/9b955d2d3fcff6a5bc8bce7bafdc4c634a28e95b/src/runtime/traceback.go#L1013-L1021) ุง ฺฏูุฑูุชู ููุงโฺฉููุฏู ูุจุงุดุฏ.

ุจู ุนุจุงุฑุช ุฏฺฏุฑุ ฺฏูุฑูุชูโูุง ฺฉู ุฏุฑ ุญุงู ุงุฌุฑุง ูุณุชูุฏ ู ููฺูู ุขููุง ฺฉู ููุชุธุฑ ูุฑูุฏ/ุฎุฑูุฌ (I/O)ุ ูููโูุงุ ฺฉุงูุงูโูุงุ ุจุฑูุงููโุฑุฒ ู ุบุฑู ูุณุชูุฏุ ููู ุจู ุนููุงู "ูุนุงู" ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดููุฏุ ุญุช ุงฺฏุฑ ุจู ูุธุฑ ุจุฑุณุฏ ฺฉู ุจุฑุฎ ุงุฒ ุงู ุญุงูุชโูุง ุบุฑูุนุงู ูุณุชูุฏ.

#### 4.25.2.5.1 ุณุฑุจุงุฑ (Overhead)

ููู ูพุฑููุงูโฺฏุฑโูุง ฺฏูุฑูุชู ุฏุฑ Go ูุงุฒ ุจู ฺฉ ูุงุฒ **ูุชูููโุณุงุฒ ุฌูุงู (stop-the-world)** ุจู ุงูุฏุงุฒู `O(N)` ุฏุงุฑูุฏุ ฺฉู ุฏุฑ ุขู `N` ุชุนุฏุงุฏ ฺฏูุฑูุชูโูุง ุชุฎุตุต ุฏุงุฏู ุดุฏู ุงุณุช. ฺฉ [ุจูฺูุงุฑฺฉ ุณุงุฏู](https://github.com/felixge/fgprof/blob/fe01e87ceec08ea5024e8168f88468af8f818b62/fgprof_test.go#L35-L78) [ูุดุงู ูโุฏูุฏ](https://github.com/felixge/fgprof/blob/master/BenchmarkProfilerGoroutines.txt) ฺฉู ุฌูุงู ุจู ุทูุฑ ุชูุฑุจ ุจู ุงุฒุง ูุฑ ฺฏูุฑูุชู ุญุฏูุฏ ~1ยตs ูุชููู ูโุดูุฏุ ููุช ุงุฒ API [`runtime.GoroutineProfile()`](https://golang.org/pkg/runtime/#GoroutineProfile) ุงุณุชูุงุฏู ูโุดูุฏ. ุงูุง ุงู ููุฏุงุฑ ููฺฉู ุงุณุช ุจุณุชู ุจู ุนูุงูู ูุงููุฏ ุนูู ุงุณุชฺฉ ุจุฑูุงููุ ุชุนุฏุงุฏ ฺฏูุฑูุชูโูุง ูุฑุฏู ู ุบุฑู ุชุบุฑ ฺฉูุฏ.

ุจู ุทูุฑ ฺฉูุ ุจุฑูุงููโูุง ฺฉู ุจุณุงุฑ ุญุณุงุณ ุจู ุชุฃุฎุฑ ูุณุชูุฏ ู ุงุฒ ูุฒุงุฑุงู ฺฏูุฑูุชู ูุนุงู ุงุณุชูุงุฏู ูโฺฉููุฏุ ููฺฉู ุงุณุช ุจุฎูุงููุฏ ุฏุฑ ูพุฑููุงูโฺฏุฑ ฺฏูุฑูุชู ุฏุฑ ูุญุท ุชููุฏ ุจุง ุฏูุช ุจุดุชุฑ ุนูู ฺฉููุฏ. ุจุง ุงู ุญุงูุ ุชุนุฏุงุฏ ุฒุงุฏ ฺฏูุฑูุชูโูุง ู ุญุช ุดุงุฏ ุฎูุฏ ุฒุจุงู Go ููฺฉู ุงุณุช ุจุฑุง ฺูู ุจุฑูุงููโูุง ุงุฏูโ ููุงุณุจ ูุจุงุดุฏ.

ุจุดุชุฑ ุจุฑูุงููโูุง ฺฉู ุชุนุฏุงุฏ ุฒุงุฏ ฺฏูุฑูุชู ุงุฌุงุฏ ููโฺฉููุฏ ู ูโุชูุงููุฏ ฺูุฏ ููโุซุงูู ุชุฃุฎุฑ ุงุถุงู ุฑุง ุชุญูู ฺฉููุฏุ ูุจุงุฏ ูุดฺฉู ุจุง ูพุฑููุงูโฺฏุฑ ูุณุชูุฑ ฺฏูุฑูุชู ุฏุฑ ูุญุท ุชููุฏ ุฏุงุดุชู ุจุงุดูุฏ.

#### 4.25.2.5.2 ูฺฺฏโูุง ฺฏูุฑูุชู

ฺฏูุฑูุชูโูุง ุฏุงุฑุง ุจุณุงุฑ ุงุฒ [ูฺฺฏโูุง](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L406-L486) ูุณุชูุฏ ฺฉู ูโุชูุงููุฏ ุจู ุงุดฺฉุงูโุฒุฏุง ุจุฑูุงููโูุง Go ฺฉูฺฉ ฺฉููุฏ. ููุงุฑุฏ ุฒุฑ ุฌุงูุจ ุชูุฌู ูุณุชูุฏ ู ุจู ุทุฑู ูุฎุชูู ุงุฒ ุทุฑู APIโูุง ฺฉู ุฏุฑ ุงุฏุงูู ุงู ุณูุฏ ุชูุถุญ ุฏุงุฏู ุดุฏูโุงูุฏุ ุฏุฑ ุฏุณุชุฑุณ ูุฑุงุฑ ุฏุงุฑูุฏ:

- [`goid`](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L428): ุดูุงุณูโ ฺฉุชุง ฺฏูุฑูุชูุ ฺฏูุฑูุชู ุงุตู ุฏุงุฑุง ุดูุงุณู `1` ุงุณุช.
- [`atomicstatus`](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L14-L105): ูุถุนุช ฺฏูุฑูุชูุ ฺฉ ุงุฒ ููุงุฑุฏ ุฒุฑ:
  - `idle`: ุชุงุฒู ุชุฎุตุต ุฏุงุฏู ุดุฏู ุงุณุช.
  - `runnable`: ุฏุฑ ุตู ุงุฌุฑุงุ ููุชุธุฑ ุฒูุงูโุจูุฏ.
  - `running`: ุฏุฑ ุญุงู ุงุฌุฑุง ุฑู ฺฉ ูุฎ (thread) ุณุณุชูโุนุงูู.
  - `syscall`: ูุณุฏูุฏ ุดุฏู ุฏุฑ ฺฉ ูุฑุงุฎูุงู ุณุณุชู.
  - `waiting`: ุชูุณุท ุฒูุงูโุจูุฏโฺฉููุฏู ูุชููู ุดุฏูุ ูฺฏุงู ฺฉูุฏ ุจู `g.waitreason`.
  - `dead`: ุชุงุฒู ุฎุงุฑุฌ ุดุฏู ุง ุฏุฑ ุญุงู ุฏูุจุงุฑูโุณุงุฒ.
  - `copystack`: ุงุณุชฺฉ ุฏุฑ ุญุงู ุงูุชูุงู ุงุณุช.
  - `preempted`: ุชุงุฒู ุงุฒ ุงุฌุฑุง ุฎูุฏุฏุงุฑ ฺฉุฑุฏู ุงุณุช.
- [`waitreason`](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L996-L1024): ุฏูู ฺฉู ฺฏูุฑูุชู ุฏุฑ ูุถุนุช `waiting` ูุฑุงุฑ ุฏุงุฑุฏุ ูุงููุฏ ุฎูุงุจุ ุนููุงุช ฺฉุงูุงูุ I/Oุ ุฌูุนโุขูุฑ ุฒุจุงูู (GC) ู ุบุฑู.
- [`waitsince`](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L430): ุฒูุงู ุชูุฑุจ ฺฉู ฺฏูุฑูุชู ูุงุฑุฏ ูุถุนุช `waiting` ุง `syscall` ุดุฏู ุงุณุช ฺฉู ุชูุณุท ุงููู GC ุจุนุฏ ุงุฒ ุดุฑูุน ุงูุชุธุงุฑ ุชุนู ูโุดูุฏ.
- [`labels`](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L472): ูุฌููุนูโุง ุงุฒ ฺฉูุฏ/ููุฏุงุฑ [ุจุฑฺุณุจโูุง ูพุฑููุงูโฺฏุฑ](https://rakyll.org/profiler-labels/) ฺฉู ูโุชูุงููุฏ ุจู ฺฏูุฑูุชูโูุง ูุชุตู ุดููุฏ.
- `stack trace`: ุชุงุจุน ฺฉู ุฏุฑ ุญุงู ุงุฌุฑุงุณุช ู ููฺูู ุชูุงุจุน ูุฑุงุฎูุงููุฏู ุขู. ุงู ุจู ุตูุฑุช ุฎุฑูุฌ ูุชู ุดุงูู ูุงู ูุงูโูุงุ ูุงู ุชูุงุจุน ู ุดูุงุฑู ุฎุทูุท ุง ุจู ุตูุฑุช ฺฉ ุขุฑุงู ุงุฒ ุขุฏุฑุณโูุง ุดูุงุฑูุฏู ุจุฑูุงูู (PCs) ููุงุด ุฏุงุฏู ูโุดูุฏ. ๐งุชุญูู ุจุดุชุฑ ุฏุฑุจุงุฑู ุงู ููุถูุน: ุขุง ูโุชูุงู ูุชู ุชุงุจุน/ูุงู/ุฎุท ุฑุง ุจู PCs ุชุจุฏู ฺฉุฑุฏุ
- [`gopc`](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L466): ุขุฏุฑุณ ุดูุงุฑูุฏู ุจุฑูุงูู (PC) ูุฑุจูุท ุจู ูุฑุงุฎูุงู `go ...` ฺฉู ุจุงุนุซ ุงุฌุงุฏ ุงู ฺฏูุฑูุชู ุดุฏู ุงุณุช. ุงู ูโุชูุงูุฏ ุจู ูุงูุ ูุงู ุชุงุจุน ู ุดูุงุฑู ุฎุท ุชุจุฏู ุดูุฏ.
- [`lockedm`](https://github.com/golang/go/blob/go1.15.6/src/runtime/runtime2.go#L460): ูุฎ ฺฉู ุงู ฺฏูุฑูุชู ุจู ุขู ููู ุดุฏู ุงุณุชุ ุฏุฑ ุตูุฑุช ฺฉู ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.


#### 4.25.2.5.3 ูุงุชุฑุณ ูฺฺฏโูุง (Feature Matrix)

ุฌุฏูู ูุงุชุฑุณ ูฺฺฏโูุง ุฒุฑ ุจู ุดูุง ฺฉ ุงุฏู ฺฉู ุงุฒ ุฏุณุชุฑุณ ฺฉููู ุงู ูฺฺฏโูุง ุงุฒ ุทุฑู APIูุง ูุฎุชูู ุงุฑุงุฆู ูโุฏูุฏ.

{{<img url="#" image="../../assets/img/content/chapter4/profiling/9.png" alt="goroutine matrix">}}

#### 4.25.2.5.4 APIูุง

[`runtime.Stack()`](https://golang.org/pkg/runtime/#Stack) /  [`pprof.Lookup(debug=2)`](https://golang.org/pkg/runtime/pprof/#Lookup)

ุงู ุชุงุจุน ุฎุฑูุฌ ูุชู ุจุฏูู ุณุงุฎุชุงุฑ ุจุงุฒูโฺฏุฑุฏุงูุฏ ฺฉู ุดุงูู ุงุณุชฺฉ (Stack) ุชูุงู ฺฏูุฑูุชูโูุง ูุนุงู ู ูฺฺฏโูุง ฺฉู ุฏุฑ ูุงุชุฑุณ ูฺฺฏโูุง ุฐฺฉุฑ ุดุฏู ุงุณุชุ ูโุจุงุดุฏ.

ูฺฺฏ `waitsince` ุจู ุนููุงู `nanotime() - gp.waitsince()` ุจุฑ ุญุณุจ ุฏููู ููุงุด ุฏุงุฏู ูโุดูุฏุ ุงูุง ุชููุง ุฒูุงู ฺฉู ูุฏุช ุฒูุงู ุจุด ุงุฒ 1 ุฏููู ุจุงุดุฏ.

`pprof.Lookup(debug=2)` ฺฉ ูุงู ูุณุชุนุงุฑ ุณุงุฏูโุดุฏู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุงู ูพุฑููุงู ุงุณุช. ูุฑุงุฎูุงู ูุงูุน ุจู ุงู ุดฺฉู ุงุณุช:

```go
profile := pprof.Lookup("goroutine")
profile.WriteTo(os.Stdout, 2)
```

ูพุงุฏูโุณุงุฒ ูพุฑููุงู ุจู ุณุงุฏฺฏ `runtime.Stack()` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ.

ุฏุฑ ุฒุฑ ูุซุงู ฺฉูุชุงู ุงุฒ ุฎุฑูุฌ ุจุงุฒฺฏุฑุฏุงูุฏู ุดุฏู ุขูุฏู ุงุณุช.

```shell
goroutine 1 [running]:
main.glob..func1(0x14e5940, 0xc0000aa7b0, 0xc000064eb0, 0x2)
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:29 +0x6f
main.writeProfiles(0x2, 0xc0000c4008, 0x1466424)
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:106 +0x187
main.main()
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:152 +0x3d2

goroutine 22 [sleep, 1 minutes]:
time.Sleep(0x3b9aca00)
	/usr/local/Cellar/go/1.15.6/libexec/src/runtime/time.go:188 +0xbf
main.shortSleepLoop()
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:165 +0x2a
created by main.indirectShortSleepLoop2
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:185 +0x35

goroutine 3 [IO wait, 1 minutes]:
internal/poll.runtime_pollWait(0x1e91e88, 0x72, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/runtime/netpoll.go:222 +0x55
internal/poll.(*pollDesc).wait(0xc00019e018, 0x72, 0x0, 0x0, 0x1465786)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:87 +0x45
internal/poll.(*pollDesc).waitRead(...)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:92
internal/poll.(*FD).Accept(0xc00019e000, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_unix.go:394 +0x1fc
net.(*netFD).accept(0xc00019e000, 0x7d667d63cbbded3e, 0x1789ccbbded3e, 0x100000001)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/fd_unix.go:172 +0x45
net.(*TCPListener).accept(0xc000188060, 0x60006709, 0xc000196da8, 0x109abe6)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/tcpsock_posix.go:139 +0x32
net.(*TCPListener).Accept(0xc000188060, 0xc000196df8, 0x18, 0xc000001200, 0x12e9eec)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/tcpsock.go:261 +0x65
net/http.(*Server).Serve(0xc00019c000, 0x14ec6e0, 0xc000188060, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:2937 +0x266
net/http.(*Server).ListenAndServe(0xc00019c000, 0xc00019c000, 0x1475536)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:2866 +0xb7
net/http.ListenAndServe(...)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:3120
main.main.func1(0xc000032120)
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:123 +0x126
created by main.main
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:121 +0xc5

goroutine 4 [sleep, 1 minutes]:
time.Sleep(0x3b9aca00)
	/usr/local/Cellar/go/1.15.6/libexec/src/runtime/time.go:188 +0xbf
main.shortSleepLoop()
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:165 +0x2a
created by main.main
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:130 +0x195

goroutine 5 [sleep, 1 minutes]:
time.Sleep(0x34630b8a000)
	/usr/local/Cellar/go/1.15.6/libexec/src/runtime/time.go:188 +0xbf
main.sleepLoop(0x34630b8a000)
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:171 +0x2b
created by main.main
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:131 +0x1bc

goroutine 6 [chan receive, 1 minutes]:
main.chanReceiveForever()
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:177 +0x4d
created by main.main
	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:132 +0x1d4

goroutine 24 [select, 1 minutes]:
net/http.(*persistConn).writeLoop(0xc0000cea20)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/transport.go:2340 +0x11c
created by net/http.(*Transport).dialConn
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/transport.go:1709 +0xcdc

goroutine 23 [IO wait, 1 minutes]:
internal/poll.runtime_pollWait(0x1e91da0, 0x72, 0x14e6ca0)
	/usr/local/Cellar/go/1.15.6/libexec/src/runtime/netpoll.go:222 +0x55
internal/poll.(*pollDesc).wait(0xc00010e198, 0x72, 0x14e6c00, 0x16db878, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:87 +0x45
internal/poll.(*pollDesc).waitRead(...)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:92
internal/poll.(*FD).Read(0xc00010e180, 0xc000256000, 0x1000, 0x1000, 0x0, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_unix.go:159 +0x1a5
net.(*netFD).Read(0xc00010e180, 0xc000256000, 0x1000, 0x1000, 0x103b1dc, 0xc000199b58, 0x10680e0)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/fd_posix.go:55 +0x4f
net.(*conn).Read(0xc000010008, 0xc000256000, 0x1000, 0x1000, 0x0, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/net.go:182 +0x8e
net/http.(*persistConn).Read(0xc0000cea20, 0xc000256000, 0x1000, 0x1000, 0xc00009e300, 0xc000199c58, 0x10074b5)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/transport.go:1887 +0x77
bufio.(*Reader).fill(0xc0001801e0)
	/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:101 +0x105
bufio.(*Reader).Peek(0xc0001801e0, 0x1, 0x0, 0x0, 0x1, 0x0, 0xc0001d0060)
	/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:139 +0x4f
net/http.(*persistConn).readLoop(0xc0000cea20)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/transport.go:2040 +0x1a8
created by net/http.(*Transport).dialConn
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/transport.go:1708 +0xcb7

goroutine 41 [IO wait, 1 minutes]:
internal/poll.runtime_pollWait(0x1e91cb8, 0x72, 0x14e6ca0)
	/usr/local/Cellar/go/1.15.6/libexec/src/runtime/netpoll.go:222 +0x55
internal/poll.(*pollDesc).wait(0xc00019e098, 0x72, 0x14e6c00, 0x16db878, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:87 +0x45
internal/poll.(*pollDesc).waitRead(...)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:92
internal/poll.(*FD).Read(0xc00019e080, 0xc000326000, 0x1000, 0x1000, 0x0, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_unix.go:159 +0x1a5
net.(*netFD).Read(0xc00019e080, 0xc000326000, 0x1000, 0x1000, 0x203000, 0x203000, 0x203000)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/fd_posix.go:55 +0x4f
net.(*conn).Read(0xc000186028, 0xc000326000, 0x1000, 0x1000, 0x0, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/net.go:182 +0x8e
net/http.(*connReader).Read(0xc00007c300, 0xc000326000, 0x1000, 0x1000, 0x100000006, 0x10, 0x1819408)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:798 +0x1ad
bufio.(*Reader).fill(0xc000290060)
	/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:101 +0x105
bufio.(*Reader).ReadSlice(0xc000290060, 0xa, 0x1819408, 0xc000337988, 0x100f6d0, 0xc000110000, 0x100)
	/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:360 +0x3d
bufio.(*Reader).ReadLine(0xc000290060, 0xc000110000, 0x1079694, 0xc0001a4000, 0x0, 0x1010038, 0x30)
	/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:389 +0x34
net/textproto.(*Reader).readLineSlice(0xc000182300, 0xc000110000, 0x10d7c4d, 0xc00019e080, 0x1068000, 0xc000282900)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/textproto/reader.go:58 +0x6c
net/textproto.(*Reader).ReadLine(...)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/textproto/reader.go:39
net/http.readRequest(0xc000290060, 0x0, 0xc000110000, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/request.go:1012 +0xaa
net/http.(*conn).readRequest(0xc0000c6320, 0x14ed4a0, 0xc000322000, 0x0, 0x0, 0x0)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:984 +0x19a
net/http.(*conn).serve(0xc0000c6320, 0x14ed4a0, 0xc000322000)
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:1851 +0x705
created by net/http.(*Server).Serve
	/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:2969 +0x36c
```

**[`pprof.Lookup(debug=1)`](https://golang.org/pkg/runtime/pprof/#Lookup)**

ุงู ุฑูุด ูพุฑููุงูโฺฏุฑ ูุดุงุจู `pprof.Lookup(debug=2)` ูุฑุงุฎูุงู ูโุดูุฏุ ุงูุง ุฏุงุฏูโูุง ฺฉุงููุงู ูุชูุงูุช ุชููุฏ ูโฺฉูุฏ:

- ุจู ุฌุง ูุณุช ฺฉุฑุฏู ูุฑ ฺฏูุฑูุชู ุจู ุตูุฑุช ุฌุฏุงฺฏุงููุ ฺฏูุฑูุชูโูุง ุจุง ุงุณุชฺฉ ู ุจุฑฺุณุจโูุง ฺฉุณุงู ููุท ฺฉ ุจุงุฑ ููุฑุงู ุจุง ุชุนุฏุงุฏ ุขููุง ูุณุช ูโุดููุฏ.
- ุจุฑฺุณุจโูุง pprof ุฏุฑ ุงู ุญุงูุช ฺฏูุฌุงูุฏู ูโุดููุฏุ ุฏุฑ ุญุงู ฺฉู `debug=2` ุขููุง ุฑุง ุดุงูู ููโุดูุฏ.
- ุจุดุชุฑ ูฺฺฏโูุง ุฏฺฏุฑ ฺฏูุฑูุชู ฺฉู ุฏุฑ `debug=2` ูุฌูุฏ ุฏุงุฑูุฏุ ุฏุฑ ุงูุฌุง ูุฌูุฏ ูุฏุงุฑูุฏ.
- ูุฑูุช ุฎุฑูุฌ ููฺูุงู ุจู ุตูุฑุช ูุชู ุงุณุชุ ุงูุง ุธุงูุฑ ุจุณุงุฑ ูุชูุงูุช ูุณุจุช ุจู `debug=2` ุฏุงุฑุฏ.

ุฏุฑ ุฒุฑ ฺฉ ููููู ฺฉูุชุงู ุงุฒ ุฎุฑูุฌ ุจุฑฺฏุฑุฏุงูุฏู ุดุฏู ุขูุฑุฏู ุดุฏู ุงุณุช.

```shell
goroutine profile: total 9
2 @ 0x103b125 0x106cd1f 0x13ac44a 0x106fd81
# labels: {"test_label":"test_value"}
#	0x106cd1e	time.Sleep+0xbe			/usr/local/Cellar/go/1.15.6/libexec/src/runtime/time.go:188
#	0x13ac449	main.shortSleepLoop+0x29	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:165

1 @ 0x103b125 0x10083ef 0x100802b 0x13ac4ed 0x106fd81
# labels: {"test_label":"test_value"}
#	0x13ac4ec	main.chanReceiveForever+0x4c	/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:177

1 @ 0x103b125 0x103425b 0x106a1d5 0x10d8185 0x10d91c5 0x10d91a3 0x11b8a8f 0x11cb72e 0x12df52d 0x11707c5 0x117151d 0x1171754 0x1263c2c 0x12d96ca 0x12d96f9 0x12e09ba 0x12e5085 0x106fd81
#	0x106a1d4	internal/poll.runtime_pollWait+0x54		/usr/local/Cellar/go/1.15.6/libexec/src/runtime/netpoll.go:222
#	0x10d8184	internal/poll.(*pollDesc).wait+0x44		/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:87
#	0x10d91c4	internal/poll.(*pollDesc).waitRead+0x1a4	/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_poll_runtime.go:92
#	0x10d91a2	internal/poll.(*FD).Read+0x182			/usr/local/Cellar/go/1.15.6/libexec/src/internal/poll/fd_unix.go:159
#	0x11b8a8e	net.(*netFD).Read+0x4e				/usr/local/Cellar/go/1.15.6/libexec/src/net/fd_posix.go:55
#	0x11cb72d	net.(*conn).Read+0x8d				/usr/local/Cellar/go/1.15.6/libexec/src/net/net.go:182
#	0x12df52c	net/http.(*connReader).Read+0x1ac		/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:798
#	0x11707c4	bufio.(*Reader).fill+0x104			/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:101
#	0x117151c	bufio.(*Reader).ReadSlice+0x3c			/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:360
#	0x1171753	bufio.(*Reader).ReadLine+0x33			/usr/local/Cellar/go/1.15.6/libexec/src/bufio/bufio.go:389
#	0x1263c2b	net/textproto.(*Reader).readLineSlice+0x6b	/usr/local/Cellar/go/1.15.6/libexec/src/net/textproto/reader.go:58
#	0x12d96c9	net/textproto.(*Reader).ReadLine+0xa9		/usr/local/Cellar/go/1.15.6/libexec/src/net/textproto/reader.go:39
#	0x12d96f8	net/http.readRequest+0xd8			/usr/local/Cellar/go/1.15.6/libexec/src/net/http/request.go:1012
#	0x12e09b9	net/http.(*conn).readRequest+0x199		/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:984
#	0x12e5084	net/http.(*conn).serve+0x704			/usr/local/Cellar/go/1.15.6/libexec/src/net/http/server.go:1851

...
```

**[`pprof.Lookup(debug=0)`](https://golang.org/pkg/runtime/pprof/#Lookup)**

ุงู ุฑูุด ูพุฑููุงูโฺฏุฑ ุฏููุงู ูุงููุฏ `pprof.Lookup(debug=1)` ูุฑุงุฎูุงู ูโุดูุฏ ู ููุงู ุฏุงุฏูโูุง ุฑุง ุชููุฏ ูโฺฉูุฏ. ุชููุง ุชูุงูุช ุงู ุงุณุช ฺฉู ูุฑูุช ุฏุงุฏูโูุง ุจู ุตูุฑุช ูพุฑูุชฺฉู ุจุงูุฑ pprof ุงุณุช.

ุฏุฑ ุฒุฑ ฺฉ ููููู ฺฉูุชุงู ุงุฒ ุฎุฑูุฌ ุจุฑฺฏุดุช ฺฉู ุชูุณุท `go tool pprof -raw` ฺฏุฒุงุฑุด ุดุฏู ุงุณุช ุขูุฑุฏู ุดุฏู ุงุณุช.

```shell
PeriodType: goroutine count
Period: 1
Time: 2021-01-14 16:46:23.697667 +0100 CET
Samples:
goroutine/count
          2: 1 2 3 
                test_label:[test_value]
          1: 1 4 5 6 
                test_label:[test_value]
          1: 1 7 8 9 10 11 12 13 14 15 16 17 18 19 20 
          1: 1 7 8 9 10 11 12 21 14 22 23 
                test_label:[test_value]
          1: 1 7 8 9 24 25 26 27 28 29 30 
          1: 1 31 32 
                test_label:[test_value]
          1: 1 2 33 
                test_label:[test_value]
          1: 34 35 36 37 38 39 40 41 
                test_label:[test_value]
Locations
     1: 0x103b124 M=1 runtime.gopark /usr/local/Cellar/go/1.15.6/libexec/src/runtime/proc.go:306 s=0
     2: 0x106cd1e M=1 time.Sleep /usr/local/Cellar/go/1.15.6/libexec/src/runtime/time.go:188 s=0
     3: 0x13ac449 M=1 main.shortSleepLoop /Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:165 s=0
     4: 0x10083ee M=1 runtime.chanrecv /usr/local/Cellar/go/1.15.6/libexec/src/runtime/chan.go:577 s=0
     5: 0x100802a M=1 runtime.chanrecv1 /usr/local/Cellar/go/1.15.6/libexec/src/runtime/chan.go:439 s=0
     6: 0x13ac4ec M=1 main.chanReceiveForever /Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/goroutine/main.go:177 s=0
...
Mappings
1: 0x0/0x0/0x0   [FN]
```

**[`runtime.GoroutineProfile()`](https://golang.org/pkg/runtime/#GoroutineProfile)**

ุงู ุชุงุจุน ุฏุฑ ูุงูุน ฺฉ slice ุงุฒ ุชูุงู ฺฏูุฑูุชูโูุง ูุนุงู ู trace ุงุณุชฺฉ ูุนู ุขููุง ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ. ุงุณุชฺฉ ุชุฑูุณโูุง ุจู ุตูุฑุช ุขุฏุฑุณโูุง ุจุฑูุงูู ุงุฑุงุฆู ูโุดููุฏ ฺฉู ูโุชูุงู ุขููุง ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน [`runtime.CallersFrames()`](https://golang.org/pkg/runtime/#CallersFrames) ุจู ูุงูโูุง ุชูุงุจุน ุชุฑุฌูู ฺฉุฑุฏ.

ุงู ุฑูุด ุชูุณุท [fgprof](https://github.com/felixge/fgprof) ุจุฑุง ูพุงุฏูโุณุงุฒ ูพุฑููุงูโฺฏุฑ ุฏูุงุฑ ุณุงุนุช ุงุณุชูุงุฏู ูโุดูุฏ.

ูฺฺฏโูุง ุฒุฑ ุฏุฑ ุญุงู ุญุงุถุฑ ุฏุฑ ุฏุณุชุฑุณ ูุณุชูุฏุ ุงูุง ููฺฉู ุงุณุช ุจุฑุง ูพุดููุงุฏ ุจู ูพุฑูฺู Go ุฏุฑ ุขูุฏู ุฌุงูุจ ุจุงุดูุฏ:

- ุดุงูู ฺฉุฑุฏู ูฺฺฏโูุง ฺฏูุฑูุชูโูุง ฺฉู ูููุฒ ุฏุฑ ุฏุณุชุฑุณ ูุณุชูุฏุ ุจู ุฎุตูุต ุจุฑฺุณุจโูุง.
- ููุชุฑ ฺฉุฑุฏู ุจุฑ ุงุณุงุณ ุจุฑฺุณุจโูุง pprofุ ุงู ฺฉุงุฑ ูโุชูุงูุฏ **stop-the-world** ุฑุง ฺฉุงูุด ุฏูุฏุ ุงูุง ูุงุฒ ุจู ูฺฏูุฏุงุฑ ุงุถุงู ุชูุณุท runtime ุฎูุงูุฏ ุฏุงุดุช.
- ูุญุฏูุฏ ฺฉุฑุฏู ุชุนุฏุงุฏ ฺฏูุฑูุชูโูุง ุจุงุฒฺฏุดุช ุจู ฺฉ ุฒุฑูุฌููุนู ุชุตุงุฏูุ ฺฉู ูโุชูุงูุฏ **stop-the-world** ุฑุง ฺฉุงูุด ุฏูุฏ ู ููฺฉู ุงุณุช ูพุงุฏูโุณุงุฒ ุขู ูุณุจุช ุจู ููุชุฑ ุจุฑ ุงุณุงุณ ุจุฑฺุณุจ ุขุณุงูโุชุฑ ุจุงุดุฏ.

ุฏุฑ ุฒุฑ ฺฉ ูุซุงู ฺฉูุชุงู ุงุฒ ุฎุฑูุฌ ุจุงุฒฺฏุดุช ุขูุฑุฏู ุดุฏู ุงุณุช.

```json
[
  {
    "Stack0": [
      20629256,
      20629212,
      20627047,
      20628306,
      17018153,
      17235329,
      ...
    ]
  },
  {
    "Stack0": [
      17019173,
      17222943,
      20628554,
      17235329,
      ...
    ]
  },
  ...
]
```

**[`net/http/pprof`](https://golang.org/pkg/net/http/pprof/)**

ุงู ูพฺฉุฌ ูพุฑููุงูโูุง ุชูุตูโุดุฏู ุฏุฑ ุจุฎุด [`pprof.Lookup("goroutine")`](https://golang.org/pkg/runtime/pprof/#Lookup) ุฑุง ุงุฒ ุทุฑู endpointูุง HTTP ูุฑุงูู ูโฺฉูุฏ. ุฎุฑูุฌ ุฏููุงู ููุงู ฺุฒ ุงุณุช ฺฉู ุฏุฑ ุฑูุดโูุง ุฏฺฏุฑ ุฏุฏู ูโุดูุฏ.

#### 4.25.2.5.5 ุชุงุฑุฎฺู

ูพุฑููุงูโฺฏุฑ ฺฏูุฑูุชู ุชูุณุท [Russ Cox](https://github.com/rsc) [ูพุงุฏูโุณุงุฒ ุดุฏ](https://codereview.appspot.com/5687076/) ู ุจุฑุง ุงููู ุจุงุฑ ุฏุฑ ูุณุฎู [weekly.2012-02-22](https://golang.org/doc/devel/weekly.html#2012-02-22) ูพุด ุงุฒ ุงูุชุดุงุฑ go1 ุธุงูุฑ ุดุฏ.

### 4.25.2.6 ูพุฑููุงูุฑ ThreadCreate

๐ ูพุฑููุงู threadcreate ุจุฑุง ููุงุด ุงุณุชฺฉ ุชุฑูุณโูุง ุทุฑุงุญ ุดุฏู ฺฉู ููุฌุฑ ุจู ุงุฌุงุฏ ูุฎโูุง (threads) ุฌุฏุฏ ุณุณุชูโุนุงูู ุดุฏูโุงูุฏ. ุจุง ุงู ุญุงูุ ุงุฒ ุณุงู ฒฐฑณ [ุฎุฑุงุจ ุดุฏู ุงุณุช](https://github.com/golang/go/issues/6104)ุ ุจูุงุจุฑุงู ุจูุชุฑ ุงุณุช ุงุฒ ุขู ุฏูุฑ ฺฉูุฏ.


## 4.25.3 ุขููุฒุด ฺฉุงุฑ ุจุง ุงุจุฒุงุฑ go pprof

ูพุฑููุงูุฑูุง ูุฎุชูู ุฏุงุฎู ุฏุฑ Go ุจุฑุง ฺฉุงุฑ ุจุง ุงุจุฒุงุฑ ุจุตุฑโุณุงุฒ [pprof](https://github.com/google/pprof) ุทุฑุงุญ ุดุฏูโุงูุฏ. pprof ุฎูุฏ ฺฉ ูพุฑูฺู ุบุฑุฑุณู ุงุฒ ฺฏูฺฏู ุงุณุช ฺฉู ุจุฑุง ุชุญูู ุฏุงุฏูโูุง ูพุฑููุงูโฺฏุฑ ุงุฒ ุจุฑูุงููโูุง C++ุ Java ู Go ุทุฑุงุญ ุดุฏู ุงุณุช. ุงู ูพุฑูฺู ฺฉ ูุฑูุช ูพุฑูุชฺฉู ุจุงูุฑ ุฑุง ุชุนุฑู ูโฺฉูุฏ ฺฉู ุชูุณุท ุชูุงู ูพุฑููุงูุฑูุง Go ุงุณุชูุงุฏู ูโุดูุฏ ู ุฏุฑ ุงู ุณูุฏ ุชูุถุญ ุฏุงุฏู ุดุฏู ุงุณุช.

ูพุฑูฺู Go ุฎูุฏ ฺฉ ูุณุฎู ุงุฒ pprof ุฑุง [ุจูโููุฑุงู](https://github.com/golang/go/tree/master/src/cmd/pprof) ุฏุงุฑุฏ ฺฉู ูโุชูุงู ุขู ุฑุง ุงุฒ ุทุฑู ุฏุณุชูุฑ `go tool pprof` ูุฑุงุฎูุงู ฺฉุฑุฏ. ุงู ุงุจุฒุงุฑ ุชุง ุญุฏ ุฒุงุฏ ุจุง ุงุจุฒุงุฑ ุงุตู ูุดุงุจู ุงุณุชุ ุจูโุฌุฒ ฺูุฏ ุชุบุฑ ุฌุฒุฆ. Go ุชูุตู ูโฺฉูุฏ ฺฉู ุจุฑุง ฺฉุงุฑ ุจุง ูพุฑููุงูโูุง Go ููุดู ุงุฒ `go tool pprof` ุจูโุฌุง ุงุจุฒุงุฑ ุงุตู ุงุณุชูุงุฏู ุดูุฏ.

### 4.25.3.1 ูฺฺฏโูุง

ุงุจุฒุงุฑ pprof ุฏุงุฑุง ฺฉ ุฑุงุจุท ุฎุท ูุฑูุงู ุชุนุงูู ุงุณุชุ ุงูุง ููฺูู ฺฉ ุฑุงุจุท ฺฉุงุฑุจุฑ ูุจ ู ฺฏุฒููโูุง ูุฎุชูู ูุฑูุช ุฎุฑูุฌ ุฏฺฏุฑ ูุฒ ุฏุงุฑุฏ.

### 4.25.3.2 ูุฑูุช ูุงู

ูุฑูุช pprof ุฏุฑ ุชุนุฑู ูพุฑูุชฺฉู ุจุงูุฑ [profile.proto](https://github.com/google/pprof/blob/master/proto/profile.proto) ุชุนุฑู ุดุฏู ุงุณุช ฺฉู ุดุงูู ูุธุฑุงุช ููุฏ ุงุณุช. ุนูุงูู ุจุฑ ุงูุ ฺฉ [README](https://github.com/google/pprof/blob/master/proto/README.md) ุฑุณู ุจุฑุง ุขู ูุฌูุฏ ุฏุงุฑุฏ. ูุงูโูุง pprof ููุดู ุจุง ูุดุฑุฏูโุณุงุฒ gzip ุฏุฑ ุฏุณฺฉ ุฐุฎุฑู ูโุดููุฏ.

ฺฉ ุชุตูุฑ ุจู ุงูุฏุงุฒู ูุฒุงุฑ ฺฉููู ูโุงุฑุฒุฏุ ุจูุงุจุฑุงู ุฏุฑ ุฒุฑ ฺฉ ุชุฌุณู ุฎูุฏฺฉุงุฑ [ุชููุฏ ุดุฏู](https://github.com/seamia/protodot) ุงุฒ ุงู ูุฑูุช ูุฑุงุฑ ุฏุงุฏู ุดุฏู ุงุณุช. ูุทูุงู ุชูุฌู ุฏุงุดุชู ุจุงุดุฏ ฺฉู ููุฏูุง ูุงููุฏ `filename` ุงุดุงุฑูโฺฏุฑูุง ุจู `string_table` ูุณุชูุฏ ฺฉู ุฏุฑ ุชุฌุณู ูุดุงู ุฏุงุฏู ููโุดููุฏ ู ุจูุจูุฏูุง ุงู ุญูุฒู ุฎูุดโุขูุฏ ุงุณุช!

{{<img url="#" image="../../assets/img/content/chapter4/profiling/10.png" alt="profile">}}

### 4.25.3.3 ูุฑูุช ุฏุงุฏูโูุง pprof

ูุฑูุช ุฏุงุฏูโูุง pprof ุจู ูุธุฑ ูโุฑุณุฏ ฺฉู ุจุฑุง ฺฉุงุฑุงุ ุฒุจุงูโูุง ูุฎุชูู ู ุงููุงุน ูพุฑููุงูโูุง ูุฎุชูู (CPUุ Heap ู ุบุฑู) ุทุฑุงุญ ุดุฏู ุงุณุชุ ุงูุง ุจู ุฏูู ุงู ููุถูุนุ ุจุณุงุฑ ุงูุชุฒุงุน ู ูพุฑ ุงุฒ ุงุดุงุฑูโฺฏุฑ ุงุณุช. ุงฺฏุฑ ูโุฎูุงูุฏ ุฌุฒุฆุงุช ฺฉุงูู ุฑุง ูุดุงูุฏู ฺฉูุฏุ ุจู ููฺฉโูุง ุจุงูุง ูุฑุงุฌุนู ฺฉูุฏ. ุงฺฏุฑ ุจู ุฏูุจุงู **ุฎูุงุตูโุง ูุฎุชุตุฑ** ูุณุชุฏุ ุงุฏุงูู ุฏูุฏ:

ฺฉ ูุงู pprof ุดุงูู ููุฑุณุช ุงุฒ **ูพุดุชูโูุง ุชุฑุงุดู** ุงุณุช ฺฉู ุจู ุขูโูุง ูููููโูุง ฺฏูุชู ูโุดูุฏ ู ฺฉ ุง ฺูุฏ **ููุฏุงุฑ** ุนุฏุฏ ุจุง ุขูโูุง ูุฑุชุจุท ุงุณุช. ุจุฑุง ฺฉ ูพุฑููุงู CPUุ ููุฏุงุฑ ููฺฉู ุงุณุช ูุฏุช ุฒูุงู CPU ุฏุฑ ูุงููุซุงูู ุจุงุดุฏ ฺฉู ูพุดุชู ุชุฑุงุดู ุฏุฑ ุทูู ูพุฑููุงูโุณุงุฒ ูุดุงูุฏู ุดุฏู ุงุณุช. ุจุฑุง ฺฉ ูพุฑููุงู Heapุ ููฺฉู ุงุณุช ุชุนุฏุงุฏ ุจุงุชโูุง ุชุฎุตุตโุงูุชู ุจุงุดุฏ. **ููุนโูุง ููุฏุงุฑ** ุฎูุฏ ุฏุฑ ุงุจุชุฏุง ูุงู ุชูุตู ุดุฏู ู ุจุฑุง ูพุฑ ฺฉุฑุฏู ููุฑุณุช "ููููู" ุฏุฑ ุฑุงุจุท ฺฉุงุฑุจุฑ pprof ุงุณุชูุงุฏู ูโุดููุฏ. ุนูุงูู ุจุฑ ููุงุฏุฑุ ูุฑ ูพุดุชู ุชุฑุงุดู ูโุชูุงูุฏ ุดุงูู ูุฌููุนูโุง ุงุฒ **ุจุฑฺุณุจโูุง** ูุฒ ุจุงุดุฏ. ุจุฑฺุณุจโูุง ุฒูุฌโูุง ฺฉูุฏ-ููุฏุงุฑ ูุณุชูุฏ ู ุญุช ูโุชูุงููุฏ ุดุงูู ูุงุญุฏ ูุฒ ุจุงุดูุฏ. ุฏุฑ Goุ ุงู ุจุฑฺุณุจโูุง ุจุฑุง [ุจุฑฺุณุจโูุง ูพุฑููุงูุฑ](https://rakyll.org/profiler-labels/) ุงุณุชูุงุฏู ูโุดููุฏ.

ุงู ูพุฑููุงู ููฺูู ุดุงูู **ุฒูุงู** (ุฏุฑ UTC) ุงุณุช ฺฉู ูพุฑููุงู ุซุจุช ุดุฏู ู **ูุฏุช ุฒูุงู** ุถุจุท ุฑุง ูุดุงู ูโุฏูุฏ.

ุนูุงูู ุจุฑ ุงูุ ูุฑูุช ุงูฺฉุงู ุงุณุชูุงุฏู ุงุฒ **ุนุจุงุฑุงุช ููุธู drop/keep** ุจุฑุง ุญุฐู ุง ุดุงูู ฺฉุฑุฏู ุจุฑุฎ ุงุฒ ูพุดุชูโูุง ุชุฑุงุดู ุฑุง ูุฑุงูู ูโฺฉูุฏุ ุงูุง ุขูโูุง [ุชูุณุท Go ุงุณุชูุงุฏู ููโุดููุฏ](https://github.com/golang/go/blob/go1.15.6/src/runtime/pprof/proto.go#L375-L376). ููฺูู ูุถุง ุจุฑุง ููุฑุณุช ุงุฒ **ูุธุฑุงุช** ([ุชูุณุท Go ูุฒ ุงุณุชูุงุฏู ููโุดูุฏ](https://github.com/golang/go/search?q=tagProfile_Comment)) ู ุชูุตู **ูุงุตูู** ุฏูุฑูโุง ฺฉู ุฏุฑ ุขู ูููููโูุง ฺฏุฑูุชู ุดุฏูโุงูุฏ ูุฌูุฏ ุฏุงุฑุฏ.

ฺฉุฏ ุชููุฏ ุฎุฑูุฌ pprof ุฏุฑ Go ุฏุฑ [runtime/pprof/proto.go](https://github.com/golang/go/blob/go1.15.6/src/runtime/pprof/proto.go) ููุฌูุฏ ุงุณุช.

### 4.25.3.4 ุฑูุฒฺฏุดุง (Decoding)

ุฏุฑ ุฒุฑ ุชุนุฏุงุฏ ุงุจุฒุงุฑ ุจุฑุง ุฑูุฒฺฏุดุง ูุงูโูุง pprof ุจู ุฎุฑูุฌ ูุชู ูุงุจู ุฎูุงูุฏู ุงูุณุงู ุขูุฑุฏู ุดุฏู ุงุณุช. ุขูโูุง ุจุฑ ุงุณุงุณ ูพฺุฏฺฏ ูุฑูุช ุฎุฑูุฌ ุฎูุฏ ูุฑุชุจ ุดุฏูโุงูุฏุ ุจู ุทูุฑ ฺฉู ุงุจุฒุงุฑูุง ฺฉู ุฎุฑูุฌ ุณุงุฏูโุชุฑ ุงุฑุงุฆู ูโุฏููุฏ ุงุจุชุฏุง ููุฑุณุช ุดุฏูโุงูุฏ:

### 4.25.3.5 ุงุณุชูุงุฏู ุงุฒ `pprofutils`

[pprofutils](https://github.com/felixge/pprofutils) ุงุจุฒุงุฑ ฺฉูฺฺฉ ุจุฑุง ุชุจุฏู ุจู ูุงูโูุง pprof ู ูุฑูุช ูุชู ุฌูุน ุดุฏู Brendan Gregg ุงุณุช ([folded text](https://github.com/brendangregg/FlameGraph#2-fold-stacks)). ูโุชูุงูุฏ ุงุฒ ุขู ุจู ุตูุฑุช ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ:

```bash
$ pprof2text < examples/cpu/pprof.samples.cpu.001.pb.gz

golang.org/x/sync/errgroup.(*Group).Go.func1;main.run.func2;main.computeSum 19
golang.org/x/sync/errgroup.(*Group).Go.func1;main.run.func2;main.computeSum;runtime.asyncPreempt 5
runtime.mcall;runtime.gopreempt_m;runtime.goschedImpl;runtime.schedule;runtime.findrunnable;runtime.stopm;runtime.notesleep;runtime.semasleep;runtime.pthread_cond_wait 1
runtime.mcall;runtime.park_m;runtime.schedule;runtime.findrunnable;runtime.checkTimers;runtime.nanotime;runtime.nanotime1 1
runtime.mcall;runtime.park_m;runtime.schedule;runtime.findrunnable;runtime.stopm;runtime.notesleep;runtime.semasleep;runtime.pthread_cond_wait 2
runtime.mcall;runtime.park_m;runtime.resetForSleep;runtime.resettimer;runtime.modtimer;runtime.wakeNetPoller;runtime.netpollBreak;runtime.write;runtime.write1 7
runtime.mstart;runtime.mstart1;runtime.sysmon;runtime.usleep 3
```

### 4.25.3.6 ุงุณุชูุงุฏู ุงุฒ `go tool pprof`

ุฎูุฏ `pprof` ุฏุงุฑุง ฺฉ ุญุงูุช ุฎุฑูุฌ ุจู ูุงู `-raw` ุงุณุช ฺฉู ูุญุชูุง ฺฉ ูุงู pprof ุฑุง ููุงุด ูโุฏูุฏ. ุจุง ุงู ุญุงูุ ุจุงุฏ ุชูุฌู ุฏุงุดุช ฺฉู ุงู ุญุงูุช ุขูฺูุงู `-raw` ูุณุช ฺฉู ูโุชูุงู ุจู ุขู ุฑุณุฏุ ุจู `protoc` ุฒุฑ ูฺฏุงู ฺฉูุฏ:

```bash
$ go tool pprof -raw examples/cpu/pprof.samples.cpu.001.pb.gz

PeriodType: cpu nanoseconds
Period: 10000000
Time: 2021-01-08 17:10:32.116825 +0100 CET
Duration: 3.13
Samples:
samples/count cpu/nanoseconds
         19  190000000: 1 2 3
          5   50000000: 4 5 2 3
          1   10000000: 6 7 8 9 10 11 12 13 14
          1   10000000: 15 16 17 11 18 14
          2   20000000: 6 7 8 9 10 11 18 14
          7   70000000: 19 20 21 22 23 24 14
          3   30000000: 25 26 27 28
Locations
     1: 0x1372f7f M=1 main.computeSum /Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/cpu/main.go:39 s=0
     2: 0x13730f2 M=1 main.run.func2 /Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/cpu/main.go:31 s=0
     3: 0x1372cf8 M=1 golang.org/x/sync/errgroup.(*Group).Go.func1 /Users/felix.geisendoerfer/go/pkg/mod/golang.org/x/sync@v0.0.0-20201207232520-09787c993a3a/errgroup/errgroup.go:57 s=0
     ...
Mappings
1: 0x0/0x0/0x0   [FN]
```


### 4.25.3.7 ุงุณุชูุงุฏู ุงุฒ `protoc`

ุจุฑุง ฺฉุณุงู ฺฉู ุจู ุฏูุจุงู ุฏุฏู ุฏุงุฏูโูุง ูุฒุฏฺฉ ุจู ุฐุฎุฑูโุณุงุฒ ุจุงูุฑ ุฎุงู ูุณุชูุฏุ ูุง ุจู ฺฉุงููพุงูุฑ ูพุฑูุชฺฉู ุจุงูุฑ `protoc` ูุงุฒ ุฏุงุฑู. ุฏุฑ macOS ูโุชูุงูุฏ ุงุฒ `brew install protobuf` ุจุฑุง ูุตุจ ุขู ุงุณุชูุงุฏู ฺฉูุฏุ ุจุฑุง ุณุงุฑ ูพูุชูุฑูโูุง ุจู ุจุฎุด ูุตุจ [README](https://github.com/protocolbuffers/protobuf#protocol-compiler-installation) ูุฑุงุฌุนู ฺฉูุฏ.

ุญุงูุง ุจุงุฏ ุจู ููุงู ูพุฑููุงู CPU ุงุฒ ุจุงูุง ูฺฏุงู ุจูุฏุงุฒู:

```bash
$ gzcat examples/cpu/pprof.samples.cpu.001.pb.gz | protoc --decode perftools.profiles.Profile ./profile.proto

sample_type {
  type: 1
  unit: 2
}
sample_type {
  type: 3
  unit: 4
}
sample {
  location_id: 1
  location_id: 2
  location_id: 3
  value: 19
  value: 190000000
}
sample {
  location_id: 4
  location_id: 5
  location_id: 2
  location_id: 3
  value: 5
  value: 50000000
}
...
mapping {
  id: 1
  has_functions: true
}
location {
  id: 1
  mapping_id: 1
  address: 20393855
  line {
    function_id: 1
    line: 39
  }
}
location {
  id: 2
  mapping_id: 1
  address: 20394226
  line {
    function_id: 2
    line: 31
  }
}
...
function {
  id: 1
  name: 5
  system_name: 5
  filename: 6
}
function {
  id: 2
  name: 7
  system_name: 7
  filename: 6
}
...
string_table: ""
string_table: "samples"
string_table: "count"
string_table: "cpu"
string_table: "nanoseconds"
string_table: "main.computeSum"
string_table: "/Users/felix.geisendoerfer/go/src/github.com/felixge/go-profiler-notes/examples/cpu/main.go"
...
time_nanos: 1610122232116825000
duration_nanos: 3135113726
period_type {
  type: 3
  unit: 4
}
period: 

10000000
```

ุงู ุฏุณุชูุฑุงุช ุจู ูุง ุงู ุงูฺฉุงู ุฑุง ูโุฏููุฏ ฺฉู ุณุงุฎุชุงุฑูุง ูุฑูุฏ ู ููุงุฏุฑ ุฎูุฏ ุฑุง ูุดุงูุฏู ฺฉููุ ุจู ูุง ฺฉูฺฉ ูโฺฉููุฏ ุชุง ุฏุฑ ููุงุช ูุฑูุช ุฑุง ุจูุชุฑ ุฏุฑฺฉ ฺฉูู.

### 4.25.3.8 ุงุณุชูุงุฏู ุงุฒ net/http/pprof ูพุฑููุงููฺฏ ุฑููุช

ุงูฺฉุงู ุฏุจุงฺฏ ุณุฑูุณ ุจุง ุงุณุชูุงุฏู ุงุฒ pprof ุจุฑุฑู `http.Server` ุง ุณุงุฑ ูุจ ุณุฑูุฑูุง. ุดูุง ู ุชูุงูุฏ ุงุฒ ูพฺฉุฌ [`net/http/pprof`](https://pkg.go.dev/net/http/pprof@go1.23.2) ุงุณุชูุงุฏู ฺฉูุฏ ุงูุง ุฏูุช ฺฉูุฏ ฒ ูุณุฆูู ูุฌูุฏ ุฏุงุฑุฏ ุจุงุฏ ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ ููฺฏุงู ุงุณุชูุงุฏู:

1. ุฒูุงูฺฉู ุงู ูพฺฉุฌ ุฑุง ุฏุฑ ูุฑ ุฌุง ุงุฒ ูพุฑูฺู ุฎูุฏ ูุฑุงุฎูุงู ฺฉูุฏ ุชุงุจุน `init()` ุฏุงุฎู ูพฺฉุฌ ุงุฌุฑุง ู ุดูุฏ ู ุฎูุฏฺฉุงุฑ ุจู `http.Handler` ุณุฑูุฑ mux ุงุถุงูู ู ุดูุฏ ู ูุงุฒ ุจู ุฑุฌุณุชุฑ ฺฉุฑุฏู handler ูุณุช ุงูุง ุงฺฏุฑ web framework ูุง ุฏฺฏุฑ ุฑุง ุงุณุชูุงุฏู ูฺฉูุฏ ุจุงุฏ ุจุตูุฑุช ุฏุณุช ุงุณุชูุงุฏู ฺฉูุฏ.
2. ุงูฺฉุงู ุงูฺฉู ูพฺฉุฌ pprof ูุงุจูุช configuration ุดุฏู ุฑุง ุฏุงุดุชู ุจุงุดุฏ ูุฏุงุฑุฏ ู ุงุทูุงุนุงุช ุฏุจุงฺฏ ุฎู ุญุณุงุณ ูุณุชูุฏ ุงฺฏุฑ ุณุฑูุณ ุดูุง ุฑู ูพุฑูุฏุงฺฉุดู ูุณุช ููฺฉู ุงุณุช ุงุทูุงุนุงุช ุญุณุงุณ ุจุฑูู ุฏุฑุฒ ุฏูุฏ, ุจู ุนููุงู ูุซุงู `debug/pprof/cmdline` ุงุทูุงุนุงุช flag, switch ูุง ฺฉู ุณุฑูุณ ุดูุง ุงุฌุฑุง ุดุฏู ุงุณุช ุฑุง ููุงุด ู ุฏูุฏ ู ุฏุฑ ุตูุฑุชฺฉู ููฺฏ ุฏุงุดุชู ุจุงุดุฏ ุดุงูู ุงุทูุงุนุงุช ุญุณุงุณ ูุธุฑ secret key, password ู... ุจุงุดุฏ ุฏุฏู ู ุดูุฏ.

ุจุฑุง ููุฑุฏ ุฏูู ุฑุงู ุญู ุฏุงุฑู ฺฉู ู ุชูุงูุฏ ุฌูู ุฎูุฏฺฉุงุฑ ุฑุฌุณุชุฑ ุดุฏู handler ูุง pprof ุฑุง ุจฺฏุฑุฏ ู ููุงุฑุฏ ููุฑุฏ ูุงุฒ ุฑุง ุฑุฌุณุชุฑ ฺฉูุฏ.

{{< hint info >}}
ุจุฑุง ููุฑุฏ ุฏูู ุฑุงู ุญู ุฏุงุฑู ฺฉู ู ุชูุงูุฏ ุฌูู ุฎูุฏฺฉุงุฑ ุฑุฌุณุชุฑ ุดุฏู handler ูุง pprof ุฑุง ุจฺฏุฑุฏ ู ููุงุฑุฏ ููุฑุฏ ูุงุฒ ุฑุง ุฑุฌุณุชุฑ ฺฉูุฏ.

ุจู ููููู ฺฉุฏ ุฒุฑ ุชูุฌู ฺฉูุฏ:

```go
package main  
  
import (  
    "flag"  
    "fmt"    "github.com/PacViewer/synker/internal/logger"    _ "go.uber.org/automaxprocs"  
    "net/http"    "net/http/pprof")  
  
var (  
    pprofAddr      *string  
)  
  
func init() {  
    pprofAddr = flag.String("pprof-addr", "", "start pprof on server")  
    flag.Parse()  
  
    // init disables default pprof handlers registered by importing net/http/pprof.  
    // Your pprof is showing (https://mmcloughlin.com/posts/your-pprof-is-showing)    
    http.DefaultServeMux = http.NewServeMux()  
}  
  
func main() {  
    log := logger.DefaultLogger  
  
    if *pprofAddr != "" {  
       mux := http.NewServeMux()  
       mux.HandleFunc("/debug/pprof/", pprof.Index)  
       mux.HandleFunc("/debug/pprof/profile", pprof.Profile)  
       mux.HandleFunc("/debug/pprof/symbol", pprof.Symbol)  
       mux.HandleFunc("/debug/pprof/trace", pprof.Trace)  
  
       sv := &http.Server{  
          Addr:    *pprofAddr,  
          Handler: mux,  
       }  
  
       log.Info("pprof listened", "addr", fmt.Sprintf("http://%s/debug/pprof", *pprofAddr))  
       go func() {  
          if err := sv.ListenAndServe(); err != nil {  
             log.Fatal("failed to listen pprof server", "err", err)  
          }  
       }()  
    }  
}
```
{{< /hint >}}


ูพุณ ุงุฒ ุงูฺฉู `net/http/pprof` ุฑุง ุฑุฌุณุชุฑ ฺฉุฑุฏุฏ ุจุฑุฑู ุณุฑูุฑ ุฑู ุฑูุช `/debug/pprof` ุฏุฑ ุฏุณุชุฑุณ ุงุณุช.

{{<img url="#" image="../../assets/img/content/chapter4/profiling/11.png" alt="pprof">}}

### 4.25.3.9 ุฏุณุชูุฑุงุช pprof

ุฏุฑ ุฒุฑ ูุง ฺฉุณุฑ ุฏุณุชูุงุฑุช ฺฉุงุฑุจุฑุฏ pprof ุฑุง ูุนุฑู ูฺฉูู ฺฉู ูุชูุงูุฏ ุจุตูุฑุช visualization ุงุทูุงุนุงุช ูพุฑููุงู ุฑุง ุฏุฑ ููฺฉุงู ุง ุฑููุช ุจุจูุฏ.

#### 4.25.3.9.1 ุฏุฏู CPU Profile ุขููุงู ุฑู ููฺฉุงู

ุจุฑุง ุฏุฏู ุงุทูุงุนุงุช CPU Profile ุจุตูุฑุช ุขููุงู ุฑู ููฺฉุงู ุฏุณุชูุฑ ุฒุฑ ุฑุง ุจุฒูุฏ:

```shell
go tool pprof -http=:8081 http://localhost:8080/debug/pprof/profile
```


{{<img url="#" image="../../assets/img/content/chapter4/profiling/12.png" alt="cpu profile">}}

#### 4.25.3.9.2 ุฏุฏู Memory Profile ุขููุงู ุฑู ููฺฉุงู

ุจุฑุง ุฏุฏู ุงุทูุงุนุงุช Memory Profile ุจุตูุฑุช ุขููุงู ุฑู ููฺฉุงู ุฏุณุชูุฑ ุฒุฑ ุฑุง ุจุฒูุฏ:

- **ุฏุฏู allocation ูุง**

```shell
go tool pprof -http=:8081 http://localhost:8080/debug/pprof/allocs
```

{{<img url="#" image="../../assets/img/content/chapter4/profiling/13.png" alt="memory allocs profile">}}

- **ุฏุฏู heap ูุง**

```shell
go tool pprof -http=:8081 http://localhost:8080/debug/pprof/heap
```

{{<img url="#" image="../../assets/img/content/chapter4/profiling/13.png" alt="heap profile">}}


ุจุฑุง ุฏุฏู ุฏุฑ ูุงูุจ flame graph ู ุชูุงูุฏ ุจู ุขุฏุฑุณ ุฒุฑ ุจุฑุฑูุฏ:


```shell
http://localhost:8082/ui/flamegraph
```


{{<img url="#" image="../../assets/img/content/chapter4/profiling/15.png" alt="flame graph">}}


#### 4.25.3.9.3 ฺฏุฑูุชู ุฎุฑูุฌ pdf, png, svg

ุจุฑุง ุงูฺฉู ุจุชูุงูุฏ ุงุฒ ุงุทูุงุนุงุช profiling ุฎุฑูุฌ ูุงู ุจฺฏุฑุฏ ุฏุณุชูุฑ ุฒุฑ ุฑุง ุจุฒูุฏ.


- **PDF**

```shell
go tool pprof -pdf heap_profile.pprof
```

- **SVG**

```shell
go tool pprof -svg heap_profile.pprof
```

- **PNG**

```shell
go tool pprof -png heap_profile.pprof
```


### 4.25.3.9 ูุชุฌูโฺฏุฑ

ูุฏุฑุช ฺฉุงุฑุขูุฏ ุญุงูุธู ุฏุฑ Goุ ุจู ููุฑุงู ุงุจุฒุงุฑูุง ูพุฑููุงูโุณุงุฒโุงุดุ ุจู ุชูุณุนูโุฏููุฏฺฏุงู ูพูุชูุฑู ูู ุจุฑุง ุณุงุฎุช ุจุฑูุงููโูุง ฺฉุงุฑุขูุฏ ุงุฑุงุฆู ูโุฏูุฏ. ุจุง ุฏุฑฺฉ ุฑูุชุงุฑ ุญุงูุธู ุฏุฑ Go ู ูพุฑููุงูโุณุงุฒ ููุธู ุจุฑูุงูู ุฎูุฏุ ูโุชูุงูุฏ ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ุงู ุจุฑูุงูู ุญุช ุฏุฑ ุจุงุฑูุง ุณูฺฏู ูุฒ ฺฉุงุฑุขูุฏ ู ูพุงุณุฎฺฏู ุจุงู ูโูุงูุฏ.